<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationDate="1/12/2016 7:12:54 AM"
  DTS:CreationName="Microsoft.Package"
  DTS:CreatorComputerName="AMS06X"
  DTS:CreatorName="AMS\pgonzalez"
  DTS:DTSID="{98CBC0EE-5543-4CD4-93F4-1059C23EDC2E}"
  DTS:ExecutableType="Microsoft.Package"
  DTS:LastModifiedProductVersion="15.0.1301.433"
  DTS:LocaleID="11274"
  DTS:ObjectName="CircDebitos H_CIRCUITO_FACT_DEB_REFACT"
  DTS:PackageType="5"
  DTS:VersionBuild="103"
  DTS:VersionGUID="{9A316BDB-87E3-417B-BBC6-979A4E6EB7D5}">
  <DTS:Property
    DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:LogProviders>
    <DTS:LogProvider
      DTS:ConfigString="DS_MSDB"
      DTS:CreationName="Microsoft.LogProviderSQLServer"
      DTS:Description="Writes log entries for events to a SQL Server database"
      DTS:DTSID="{2831FD00-F4FC-4850-9764-C6E847716EE7}"
      DTS:ObjectName="SSIS log provider for SQL Server">
      <DTS:ObjectData>
        <InnerObject />
      </DTS:ObjectData>
    </DTS:LogProvider>
  </DTS:LogProviders>
  <DTS:Variables>
    <DTS:Variable
      DTS:CreationName=""
      DTS:DTSID="{34AB07EB-3935-4BA7-BADD-D5E150688836}"
      DTS:IncludeInDebugDump="6789"
      DTS:Namespace="User"
      DTS:ObjectName="Periodo">
      <DTS:VariableValue
        DTS:DataType="3">0</DTS:VariableValue>
    </DTS:Variable>
  </DTS:Variables>
  <DTS:LoggingOptions
    DTS:FilterKind="0"
    DTS:LoggingMode="1">
    <DTS:Property
      DTS:DataType="8"
      DTS:Name="EventFilter">1,7,OnError</DTS:Property>
    <DTS:Property
      DTS:EventName="OnError"
      DTS:Name="ColumnFilter">
      <DTS:Property
        DTS:Name="Computer">-1</DTS:Property>
      <DTS:Property
        DTS:Name="Operator">-1</DTS:Property>
      <DTS:Property
        DTS:Name="SourceName">-1</DTS:Property>
      <DTS:Property
        DTS:Name="SourceID">-1</DTS:Property>
      <DTS:Property
        DTS:Name="ExecutionID">-1</DTS:Property>
      <DTS:Property
        DTS:Name="MessageText">-1</DTS:Property>
      <DTS:Property
        DTS:Name="DataBytes">-1</DTS:Property>
    </DTS:Property>
    <DTS:SelectedLogProviders>
      <DTS:SelectedLogProvider
        DTS:InstanceID="{2831FD00-F4FC-4850-9764-C6E847716EE7}" />
    </DTS:SelectedLogProviders>
  </DTS:LoggingOptions>
  <DTS:Executables>
    <DTS:Executable
      DTS:refId="Package\Actualiza H_CIRCUITO_FACT_DEB_REFACT"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{2be0cc4c-0a01-4ea7-9ae9-a7baa12c8ed4}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Actualiza H_CIRCUITO_FACT_DEB_REFACT"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{6FDBBEF9-C4FF-4E83-BC5D-D6E8D72C6D9E}"
          SQLTask:SqlStatementSource="&#xA;/* Actualiza información en H_CIRCUITO_FACT_DEB_REFACT */&#xA;&#xA;Declare @Periodo Int Set @Periodo = ?&#xA;&#xA;&#x9;&#x9;-- FACTURADO.&#xA;&#xA;&#x9;&#x9;&#x9;-- Crea temporal #Facturado que suma los valores previos a insertarlo en la H para Debitos.&#xA;&#x9;&#x9;&#x9;&#x9;DELETE FROM H_CIRCUITO_FACT_DEB_REFACT&#xA;&#x9;&#x9;&#x9;&#x9;FROM H_CIRCUITO_FACT_DEB_REFACT F&#xA;&#x9;&#x9;&#x9;&#x9;JOIN DW_SALUD.dbo.D_TIPO_CIRCUITO T on T.id_tipo_circuito = F.id_tipo_circuito&#xA;&#x9;&#x9;&#x9;&#x9;WHERE T.id_tipo_circuito_agrup in (1) and id_periodo = @Periodo&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;&#x9;INSERT INTO DW_SALUD.dbo.H_CIRCUITO_FACT_DEB_REFACT&#xA;&#x9;&#x9;&#x9;&#x9;(id_periodo, id_acreedor, id_tipo_prestador, id_tipo_circuito, marca_refact_salud, importe, id_compania, id_periodo_recepcion)&#xA;&#x9;&#x9;&#x9;&#x9;SELECT Id_Periodo, Id_Acreedor, 'P' as id_tipo_prestador, Id_marca_facturado as id_tipo_circuito, 'X' marca_refact_salud, SUM(Importe_Facturado) as Importe_Facturado, id_compania, @Periodo as id_periodo_recepcion&#xA;&#x9;&#x9;&#x9;&#x9;FROM DW_SALUD.dbo.AUX_H_CIRCUITO_FACTURACION&#xA;&#x9;&#x9;&#x9;&#x9;WHERE id_periodo = @Periodo&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY Id_Periodo, Id_Acreedor, Id_marca_facturado, id_compania&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;-- DEBITOS MANUALES.&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;-- Borra Debitos/Creditos Manuales en H_CIRCUITO_FACT_DEB_REFACT&#x9;&#xA;&#x9;&#x9;&#x9;&#x9;DELETE FROM H_CIRCUITO_FACT_DEB_REFACT&#xA;&#x9;&#x9;&#x9;&#x9;FROM H_CIRCUITO_FACT_DEB_REFACT F&#xA;&#x9;&#x9;&#x9;&#x9;JOIN DW_SALUD.dbo.AUX_H_CIRCUITO_DEBITOS_MANUALES P on F.id_tipo_circuito = P.id_tipo_circuito and F.id_periodo_recepcion = P.id_periodo_recepcion and F.id_acreedor = P.id_acreedor&#xA;&#x9;&#x9;&#x9;&#x9;JOIN DW_SALUD.dbo.D_TIPO_CIRCUITO T on T.id_tipo_circuito = P.id_tipo_circuito&#xA;&#x9;&#x9;&#x9;&#x9;WHERE T.id_tipo_circuito_agrup in (3) and P.id_periodo_recepcion = @Periodo&#xA;&#xA;&#x9;&#x9;&#x9;-- Inserta Debitos/Creditos Manuales en H_CIRCUITO_FACT_DEB_REFACT.&#xA;&#x9;&#x9;&#x9;&#x9;INSERT INTO DW_SALUD.dbo.H_CIRCUITO_FACT_DEB_REFACT&#xA;&#x9;&#x9;&#x9;&#x9;(id_periodo, id_acreedor, id_tipo_prestador, id_tipo_circuito, marca_refact_salud, importe, id_compania, id_periodo_recepcion)&#xA;&#x9;&#x9;&#x9;&#x9;SELECT F.id_periodo, F.id_acreedor, 'P' as id_tipo_prestador, F.id_tipo_circuito, 'X' marca_refact_salud, SUM(F.Importe) as Importe, F.id_compania, F.id_periodo_recepcion&#xA;&#x9;&#x9;&#x9;&#x9;FROM AUX_H_CIRCUITO_DEBITOS_MANUALES F&#xA;&#x9;&#x9;&#x9;&#x9;JOIN DW_SALUD.dbo.D_TIPO_CIRCUITO T on T.id_tipo_circuito = F.id_tipo_circuito&#xA;&#x9;&#x9;&#x9;&#x9;WHERE T.id_tipo_circuito_agrup in (3) -- Aqui no pone Id_Periodo porque en la AUX_H_CIRCUITO_FACT_DEB_REFACT ya inserta los datos referidos al periodo a actualizar.&#xA;&#x9;&#x9;&#x9;&#x9;and F.id_periodo_recepcion = @Periodo&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY F.id_periodo, F.id_acreedor, F.id_tipo_circuito, F.id_compania, F.id_periodo_recepcion&#xA;&#xA;&#xA;&#xA;&#x9;&#x9;-- DEBITOS AUTOMÁTICOS.&#xA;&#xA;&#x9;&#x9;&#x9;-- Inserta Debitos Automaticos en H_CIRCUITO_FACT_DEB_REFACT - Ya fueron borradas arriba cualquier dato que pueda existir.&#xA;&#x9;&#x9;&#x9;&#x9;DELETE FROM H_CIRCUITO_FACT_DEB_REFACT&#xA;&#x9;&#x9;&#x9;&#x9;FROM H_CIRCUITO_FACT_DEB_REFACT F &#xA;&#x9;&#x9;&#x9;&#x9;JOIN DW_SALUD.dbo.D_TIPO_CIRCUITO T on T.id_tipo_circuito = F.id_tipo_circuito&#xA;&#x9;&#x9;&#x9;&#x9;WHERE T.id_tipo_circuito_agrup in (4) and id_periodo = @Periodo&#xA;&#xA;&#x9;&#x9;&#x9;&#x9;INSERT INTO DW_SALUD.dbo.H_CIRCUITO_FACT_DEB_REFACT&#xA;&#x9;&#x9;&#x9;&#x9;(id_periodo, id_acreedor, id_tipo_prestador, id_tipo_circuito, marca_refact_salud, importe, id_compania, id_periodo_recepcion)&#xA;&#x9;&#x9;&#x9;&#x9;SELECT F.id_periodo, F.id_acreedor, 'P' as id_tipo_prestador, F.id_tipo_circuito, 'X' marca_refact_salud, SUM(F.Importe_debito) as Importe, F.id_compania, @Periodo as id_periodo_recepcion&#xA;&#x9;&#x9;&#x9;&#x9;FROM DW_SALUD.dbo.AUX_H_CIRCUITO_DEBITOS_AUTOMATICOS F&#xA;&#x9;&#x9;&#x9;&#x9;--JOIN DW_SALUD.dbo.AUX_H_CIRCUITO_FACT_DEB_REFACT P on F.id_periodo = P.id_periodo and F.id_acreedor = P.id_acreedor and F.id_tipo_circuito = P.id_tipo_circuito and F.id_compania = P.id_compania&#xA;&#x9;&#x9;&#x9;&#x9;JOIN DW_SALUD.dbo.D_TIPO_CIRCUITO T on T.id_tipo_circuito = F.id_tipo_circuito&#xA;&#x9;&#x9;&#x9;&#x9;WHERE F.id_periodo = @Periodo and T.id_tipo_circuito_agrup in (4)&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY F.id_periodo, F.id_acreedor, F.id_tipo_circuito, F.id_compania&#xA;&#xA;&#xA;&#x9;&#x9;-- REFACTURACION.&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;-- Inserta Refacturacion Administrativa.&#xA;&#x9;&#x9;&#x9;&#x9;-- Borra de la H lo que existe en la #Refacturacion pero que sea del ultimo periodo a insertar (marca_procesado = 0)&#xA;&#x9;&#x9;&#x9;&#x9;DELETE H_CIRCUITO_FACT_DEB_REFACT&#xA;&#x9;&#x9;&#x9;&#x9;FROM H_CIRCUITO_FACT_DEB_REFACT F &#xA;&#x9;&#x9;&#x9;&#x9;JOIN DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION P on F.id_tipo_circuito = P.id_tipo_circuito and F.id_periodo_recepcion = P.id_periodo_recepcion and F.id_acreedor = P.id_acreedor&#xA;&#x9;&#x9;&#x9;&#x9;JOIN DW_SALUD.dbo.D_TIPO_CIRCUITO T on T.id_tipo_circuito = F.id_tipo_circuito&#xA;&#x9;&#x9;&#x9;&#x9;WHERE (T.id_tipo_circuito_agrup in (2) or T.id_tipo_circuito = 13) and P.id_periodo_recepcion = @Periodo&#xA;&#xA;&#x9;&#x9;&#x9;&#x9;-- Inserta totales para el periodo nuevo (marca_procesado = 0) ubicandolo en los distintos periodos de Facturacion. &#xA;&#x9;&#x9;&#x9;&#x9;INSERT INTO DW_SALUD.dbo.H_CIRCUITO_FACT_DEB_REFACT&#xA;&#x9;&#x9;&#x9;&#x9;(id_periodo, id_acreedor, id_tipo_prestador, id_tipo_circuito, marca_refact_salud, importe, id_compania, id_periodo_recepcion)&#xA;&#x9;&#x9;&#x9;&#x9;SELECT F.id_periodo, F.id_acreedor, 'P' as id_tipo_prestador, F.id_tipo_circuito, Refacturacion_Salud as marca_refact_salud, SUM(F.Importe) as Importe, F.id_compania, F.id_periodo_recepcion&#xA;&#x9;&#x9;&#x9;&#x9;FROM AUX_H_CIRCUITO_REFACTURACION F&#xA;&#x9;&#x9;&#x9;&#x9;--JOIN DW_SALUD.dbo.AUX_H_CIRCUITO_FACT_DEB_REFACT P on F.id_periodo = P.id_periodo and F.id_acreedor = P.id_acreedor and F.id_tipo_circuito = P.id_tipo_circuito and F.Refacturacion_Salud = P.marca_refact_salud and F.id_compania = P.id_compania&#xA;&#x9;&#x9;&#x9;&#x9;JOIN DW_SALUD.dbo.D_TIPO_CIRCUITO T on T.id_tipo_circuito = F.id_tipo_circuito&#xA;&#x9;&#x9;&#x9;&#x9;WHERE (T.id_tipo_circuito_agrup in (2) or T.id_tipo_circuito = 13) -- Aqui no pone Id_Periodo porque en la AUX_H_CIRCUITO_FACT_DEB_REFACT ya inserta los datos referidos al periodo a actualizar.&#xA;&#x9;&#x9;&#x9;&#x9;and F.id_periodo_recepcion = @Periodo&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY F.id_periodo, F.id_acreedor, F.id_tipo_circuito, F.Refacturacion_Salud, F.id_compania, F.id_periodo_recepcion&#xA;&#xA;&#xA;/* Fin */&#xA;&#xA;&#xA;" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask">
          <SQLTask:ParameterBinding
            SQLTask:ParameterName="@Periodo"
            SQLTask:DtsVariableName="User::Periodo"
            SQLTask:ParameterDirection="Input"
            SQLTask:DataType="3"
            SQLTask:ParameterSize="-1" />
        </SQLTask:SqlTaskData>
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\Actualiza Plazos en H_CIRCUITO_FACT_DEB_REFACT"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{6B831163-4C6A-45B4-A956-D37A5B805C5A}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Actualiza Plazos en H_CIRCUITO_FACT_DEB_REFACT"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{6FDBBEF9-C4FF-4E83-BC5D-D6E8D72C6D9E}"
          SQLTask:SqlStatementSource="&#xA;&#xA;/* Actualiza campos de Diferencias en el arribo entre Facturación y Refacturación */&#xA;&#xA;Declare @Periodo Int Set @Periodo = ?&#xA;&#xA;&#x9; /* Limpia AUX_H_CIRCUITO_REFACTURACION */&#xA;&#x9; DELETE FROM DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES&#xA;&#x9; WHERE id_periodo_recepcion = @Periodo&#xA;&#xA;&#x9; /* Inserta información de Cursogramas desde AUX_H_CIRCUITO_REFACTURACION */&#xA;&#x9; INSERT INTO DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES&#xA;&#x9; (id_periodo, id_periodo_recepcion, id_acreedor, nro_cursogramaV, fecha_recepcionV, fecha_pagoV, Nro_cursogramaN, Fecha_recepcionN, id_tipo_circuito, Refacturacion_Salud)&#xA;&#x9; SELECT id_periodo, id_periodo_recepcion, id_acreedor, nro_cursograma as nro_cursogramaV, CAST('19000101' as Datetime) as fecha_recepcionV, CAST('19000101' as Datetime) as fecha_pagoV, Numero_Comprobante as nro_cursogramaN, CAST(SUBSTRING(CAST(fecha_recepcion as CHAR(10)),1,4)+'-'+SUBSTRING(CAST(fecha_recepcion as CHAR(10)),5,2)+'-'+SUBSTRING(CAST(fecha_recepcion as CHAR(10)),7,2) as datetime) as fecha_recepcionN, id_tipo_circuito, Refacturacion_Salud&#xA;&#x9; FROM DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION&#xA;&#x9; WHERE Nro_Cursograma &lt;&gt; 0 and Tipo_Comprobante not in ('TFC','DMAN') and id_periodo_recepcion = @Periodo&#xA;&#xA;&#xA;&#x9; -- FECHA DE RECEPCIÓN DEL CURSOGRAMA ORIGINAL VS FECHA DE RECEPCIÓN DEL CURSOGRAMA DE REFACTURACIÓN.&#xA;&#x9;&#x9;-- ATENCIÓN: &#xA;&#x9;&#x9;-- Tener en cuenta que este paso se debe realizar cuando la H_CIRCUITO_FACT_DEB_REFACT ya tenga información cargada de Refacturacion para el periodo a actualizar, es decir que el paso previo se actualice bien.&#xA;&#x9;&#x9;-- Como cada cursograma tiene una unica fecha de Recepcion mas allá de que este en Amb e Int, hace una pasada por ambas tablas.&#xA;&#x9;&#x9;-- La fecha de recepcion que aparece en las tablas de Refacturación hace Referencia justamente a la refacturacion (Cursograma Nuevo (campo Numero_Comprobante)) por eso para los cursogramas originales debemos buscarlo en las H de Consumos.&#xA;&#xA;&#x9;&#x9;-- Actualiza fecha de recepcion desde CUP004 que alimentana a la H de Ambulatorio e Internacion.&#xA;&#x9;&#x9;UPDATE DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES&#xA;&#x9;&#x9;SET fecha_recepcionV = C.CUC_FRE&#xA;&#x9;&#x9;FROM HOST03.HOST03.DESARROLLO.CUP004 C&#xA;&#x9;&#x9;JOIN DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES D on C.CUC_NUM = D.nro_cursogramaV&#xA;&#x9;&#x9;WHERE id_periodo_recepcion = @Periodo&#xA;&#xA;&#x9;&#x9;-- Actualiza fecha de recepcion de los cursogramas de refacturacion desde CUP004. La fecha ya la tenemos, pero nos aferramos a la de la CUP004 ya que esta alimentana a la H de Ambulatorio e Internacion.&#xA;&#x9;&#x9;UPDATE DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES&#xA;&#x9;&#x9;SET fecha_recepcionN = C.CUC_FRE&#xA;&#x9;&#x9;FROM HOST03.HOST03.DESARROLLO.CUP004 C&#xA;&#x9;&#x9;JOIN DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES D on C.CUC_NUM = D.nro_cursogramaN&#xA;&#x9;&#x9;WHERE D.id_periodo_recepcion = @Periodo&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;-- Calcula diferencia en días.&#xA;&#x9;&#x9;&#x9;UPDATE DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES&#xA;&#x9;&#x9;&#x9;SET dif_plazo_recep = DATEDIFF(DAY, Fecha_RecepcionV, Fecha_RecepcionN)&#xA;&#x9;&#x9;&#x9;where Fecha_RecepcionV not in ('1900-01-01') and id_periodo_recepcion = @Periodo&#xA;&#xA;&#x9;&#x9;&#x9;&#x9;-- Marca en cero los registros que no traen información para que no afecten en el resultado total.&#xA;&#x9;&#x9;&#x9;&#x9;UPDATE DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES&#xA;&#x9;&#x9;&#x9;&#x9;SET dif_plazo_recep = 0&#xA;&#x9;&#x9;&#x9;&#x9;WHERE (fecha_recepcionV in ('1900-01-01')) or (fecha_recepcionN in ('1900-01-01'))&#xA;&#x9;&#x9;&#x9;&#x9;and id_periodo_recepcion = @Periodo&#xA;&#xA;&#x9;&#x9;&#x9;-- Crea #Plazo_Recepcion para guardar el promedio por cada acreedor en la #Plazo_Recepcion.&#xA;&#x9;&#x9;&#x9;SELECT P.id_periodo, P.id_acreedor, P.Refacturacion_Salud, P.id_tipo_circuito, SUM(P.dif_plazo_recep) as dias_plazo_recepcion, COUNT(CAST(P.dif_plazo_recep as decimal(8,2))) as cant_plazo_recepcion&#xA;&#x9;&#x9;&#x9;INTO #Plazo_Recepcion&#xA;&#x9;&#x9;&#x9;FROM AUX_H_CIRCUITO_REFACTURACION_PROM_MESES P&#xA;&#x9;&#x9;&#x9;WHERE P.id_periodo_recepcion = @Periodo&#xA;&#x9;&#x9;&#x9;GROUP BY P.id_acreedor, P.id_periodo, P.Refacturacion_Salud, P.id_tipo_circuito&#xA;&#x9;&#x9;&#x9;ORDER BY P.id_acreedor, P.id_periodo, P.Refacturacion_Salud, P.id_tipo_circuito&#xA;&#xA;&#xA;&#x9;&#x9;&#x9;-- Pega Cantidades de Cursogramas y Sumas de días por Acreedor/Periodo en H_CIRCUITO_FACT_DEB_REFACT para ser calculado en #Plazo_Recepcion.&#xA;&#x9;&#x9;&#x9;UPDATE DW_SALUD.dbo.H_CIRCUITO_FACT_DEB_REFACT&#xA;&#x9;&#x9;&#x9;SET dias_plazo_recepcion = C.dias_plazo_recepcion,&#xA;&#x9;&#x9;&#x9;cant_plazo_recepcion = C.cant_plazo_recepcion&#xA;&#x9;&#x9;&#x9;FROM #Plazo_Recepcion C&#xA;&#x9;&#x9;&#x9;JOIN DW_SALUD.dbo.H_CIRCUITO_FACT_DEB_REFACT R on C.id_acreedor = R.id_acreedor and C.id_periodo = R.id_periodo and C.id_tipo_circuito = R.id_tipo_circuito and C.Refacturacion_Salud COLLATE SQL_Latin1_General_CP850_CI_AI = R.marca_refact_salud&#xA;&#x9;&#x9;&#x9;WHERE R.id_tipo_circuito in (2,3,4)&#xA;&#xA;&#xA;&#x9;&#x9;&#x9;-- Borra Auxiliares&#xA;&#x9;&#x9;&#x9;drop table #Plazo_Recepcion&#xA;&#xA;&#xA;&#xA;&#x9;-- FECHA DE PAGO DEL CURSOGRAMA ORIGINAL VS FECHA DE RECEPCIÓN DEL CURSOGRAMA DE REFACTURACIÓN.&#xA;&#x9;&#x9;-- ATENCIÓN: Tener en cuenta que este paso se debe realizar cuando la H_CIRCUITO_FACT_DEB_REFACT ya tenga información cargada de Refacturacion para el periodo a actualizar, es decir que el paso previo se actualice bien.&#xA;&#xA;&#x9;&#x9;-- Actualiza campo fecha_pagoV para los cursogramas AMS&#xA;&#x9;&#x9;UPDATE DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES&#xA;&#x9;&#x9;SET fecha_pagoV = CAST(SUBSTRING(CAST(C.W_V554_FAPL as CHAR(10)),1,4)+'-'+SUBSTRING(CAST(C.W_V554_FAPL as CHAR(10)),5,2)+'-'+SUBSTRING(CAST(C.W_V554_FAPL as CHAR(10)),7,2) as datetime)&#xA;&#x9;&#x9;FROM DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES R&#xA;&#x9;&#x9;JOIN HOST03.HOST03.AMSPROVD.V554FAPLI C on R.nro_cursogramaV = C.W_V554_NCOM&#xA;&#x9;&#x9;WHERE R.id_periodo_recepcion = @Periodo&#xA;&#xA;&#x9;&#x9;-- Actualiza campo fecha_pagoV para los cursogramas SMP&#xA;&#x9;&#x9;UPDATE DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES&#xA;&#x9;&#x9;SET fecha_pagoV = CAST(SUBSTRING(CAST(C.W_V554_FAPL as CHAR(10)),1,4)+'-'+SUBSTRING(CAST(C.W_V554_FAPL as CHAR(10)),5,2)+'-'+SUBSTRING(CAST(C.W_V554_FAPL as CHAR(10)),7,2) as datetime)&#xA;&#x9;&#x9;FROM DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES R&#xA;&#x9;&#x9;JOIN HOST03.HOST03.SMPPROVD.V554FAPLI C on R.nro_cursogramaV = C.W_V554_NCOM&#xA;&#x9;&#x9;WHERE R.id_periodo_recepcion = @Periodo&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;-- Actualiza campo fecha_pagoV para los cursogramas OSP&#xA;&#x9;&#x9;UPDATE DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES&#xA;&#x9;&#x9;SET fecha_pagoV = CAST(SUBSTRING(CAST(C.W_V554_FAPL as CHAR(10)),1,4)+'-'+SUBSTRING(CAST(C.W_V554_FAPL as CHAR(10)),5,2)+'-'+SUBSTRING(CAST(C.W_V554_FAPL as CHAR(10)),7,2) as datetime)&#xA;&#x9;&#x9;FROM DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES R&#xA;&#x9;&#x9;JOIN HOST03.HOST03.OSPPROVD.V554FAPLI C on R.nro_cursogramaV = C.W_V554_NCOM&#xA;&#x9;&#x9;WHERE R.id_periodo_recepcion = @Periodo&#xA;&#xA;&#x9;&#x9;-- Calcula diferencia en días.&#xA;&#x9;&#x9;UPDATE DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES&#xA;&#x9;&#x9;SET dif_plazo_pago = DATEDIFF(DAY, Fecha_PagoV, Fecha_RecepcionN)&#xA;&#x9;&#x9;WHERE id_periodo_recepcion = @Periodo&#xA;&#x9;&#x9;and fecha_pagoV not in ('1900-01-01')&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;-- Marca en cero los registros que no traen información para que no afecten en el resultado total.&#xA;&#x9;&#x9;&#x9;UPDATE DW_SALUD.dbo.AUX_H_CIRCUITO_REFACTURACION_PROM_MESES&#xA;&#x9;&#x9;&#x9;SET dif_plazo_pago = 0&#xA;&#x9;&#x9;&#x9;WHERE id_periodo_recepcion = @Periodo&#xA;&#x9;&#x9;&#x9;and fecha_pagoV in ('1900-01-01') or fecha_recepcionN in ('1900-01-01')&#xA;&#xA;&#x9;&#x9;-- Crea #Plazo_Recepcion para guardar la suma de días y cantidades de cursogramas por cada Acreedor/Periodo en la #Plazo_Pago.&#xA;&#x9;&#x9;SELECT P.id_periodo, P.id_acreedor, P.id_tipo_circuito, P.Refacturacion_Salud, SUM(P.Dif_Plazo_Pago) as dias_plazo_pago, COUNT(P.Dif_Plazo_Pago) as cant_plazo_pago&#xA;&#x9;&#x9;INTO #Plazo_Pago&#xA;&#x9;&#x9;FROM AUX_H_CIRCUITO_REFACTURACION_PROM_MESES P &#xA;&#x9;&#x9;WHERE P.id_periodo_recepcion = @Periodo and Dif_Plazo_Pago &lt;&gt; 0&#xA;&#x9;&#x9;GROUP BY id_acreedor, id_periodo, P.id_tipo_circuito, P.Refacturacion_Salud&#xA;&#x9;&#x9;ORDER BY id_acreedor, id_periodo, P.id_tipo_circuito, P.Refacturacion_Salud&#xA;&#xA;&#xA;&#x9;&#x9;-- Pega promedio en H_CIRCUITO_FACT_DEB_REFACT que ya fue calculado en #Plazo_Recepcion&#xA;&#x9;&#x9;UPDATE DW_SALUD.dbo.H_CIRCUITO_FACT_DEB_REFACT&#xA;&#x9;&#x9;SET dias_plazo_pago = IsNull(C.dias_plazo_pago,0),&#xA;&#x9;&#x9;cant_plazo_pago = IsNull(C.cant_plazo_pago,0)&#xA;&#x9;&#x9;FROM #Plazo_Pago C&#xA;&#x9;&#x9;JOIN DW_SALUD.dbo.H_CIRCUITO_FACT_DEB_REFACT R on C.id_acreedor = R.id_acreedor and C.id_periodo = R.id_periodo and C.id_tipo_circuito = R.id_tipo_circuito and C.Refacturacion_Salud COLLATE SQL_Latin1_General_CP850_CI_AI = R.marca_refact_salud&#xA;&#x9;&#x9;WHERE R.id_tipo_circuito in (2,3,4) /* Circuitos de Refacturacion*/&#xA;&#x9;&#xA;&#x9;&#x9;&#x9;-- Es incorrecto tener cantidades y dias en cero. Esto sucede porque cuando una fecha tiene '1900-01-01' cuenta el cursograma pero no suma nada ya que no se permite esta operación. Aplicamos un control a estos casos.&#xA;&#x9;&#x9;&#x9;UPDATE DW_SALUD.dbo.H_CIRCUITO_FACT_DEB_REFACT&#xA;&#x9;&#x9;&#x9;SET dias_plazo_pago = 0, cant_plazo_pago = 0&#xA;&#x9;&#x9;&#x9;WHERE (cant_plazo_pago is null) or (dias_plazo_pago = 0 and cant_plazo_pago &gt; 0)&#xA;&#x9;&#x9;&#x9;and id_tipo_circuito in (2,3,4)&#xA;&#xA;&#x9;&#x9;&#x9;-- También es incorrecto tener dias y cantidades en cero. Esto rara vez puede suceder pero por las dudas aplicamos un control a estos casos.&#xA;&#x9;&#x9;&#x9;UPDATE DW_SALUD.dbo.H_CIRCUITO_FACT_DEB_REFACT&#xA;&#x9;&#x9;&#x9;SET dias_plazo_pago = 0, cant_plazo_pago = 0&#xA;&#x9;&#x9;&#x9;WHERE (cant_plazo_pago is null) or (cant_plazo_pago = 0 and dias_plazo_pago &gt; 0)&#xA;&#x9;&#x9;&#x9;and id_tipo_circuito in (2,3,4)&#xA;&#xA;&#x9;&#x9;-- Borra Auxiliares&#xA;&#x9;&#x9;drop table #Plazo_Pago&#xA;&#xA;&#xA;-- Para todos los tipos de circuitos que no forman parte del analisis de Plazos de Pago o Recepción se le pone 0&#xA; UPDATE DW_SALUD.dbo.H_CIRCUITO_FACT_DEB_REFACT&#xA; SET dias_plazo_pago = 0, cant_plazo_pago = 0, dias_plazo_recepcion = 0, cant_plazo_recepcion = 0&#xA; WHERE id_tipo_circuito not in (2,3,4) &#xA;&#xA;&#xA;" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask">
          <SQLTask:ParameterBinding
            SQLTask:ParameterName="@Periodo"
            SQLTask:DtsVariableName="User::Periodo"
            SQLTask:ParameterDirection="Input"
            SQLTask:DataType="3"
            SQLTask:ParameterSize="-1" />
        </SQLTask:SqlTaskData>
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\Variable Periodo"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{9a6fbdaf-8286-4897-b3bf-b47a9814f5f5}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Variable Periodo"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{6FDBBEF9-C4FF-4E83-BC5D-D6E8D72C6D9E}"
          SQLTask:SqlStatementSource="&#x9;------  Periodo &#xA;&#xA;&#xA;----select 201806 as Periodo&#xA;&#xA;&#x9;select max(id_periodo) as Periodo from D_PERIODO where vigente_consumo = 1"
          SQLTask:ResultType="ResultSetType_SingleRow" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask">
          <SQLTask:ResultBinding
            SQLTask:ResultName="Periodo"
            SQLTask:DtsVariableName="User::Periodo" />
        </SQLTask:SqlTaskData>
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:PrecedenceConstraints>
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[Constraint]"
      DTS:CreationName=""
      DTS:DTSID="{A03C199B-D447-4310-A9ED-BDCF0508D523}"
      DTS:From="Package\Variable Periodo"
      DTS:LogicalAnd="True"
      DTS:ObjectName="Constraint"
      DTS:To="Package\Actualiza H_CIRCUITO_FACT_DEB_REFACT" />
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[Constraint 2]"
      DTS:CreationName=""
      DTS:DTSID="{D68F2A48-3845-4BB5-9663-57765FA0EC63}"
      DTS:From="Package\Actualiza H_CIRCUITO_FACT_DEB_REFACT"
      DTS:LogicalAnd="True"
      DTS:ObjectName="Constraint 2"
      DTS:To="Package\Actualiza Plazos en H_CIRCUITO_FACT_DEB_REFACT" />
  </DTS:PrecedenceConstraints>
  <DTS:DesignTimeProperties><![CDATA[<?xml version="1.0"?>
<!--This CDATA section contains the layout information of the package. The section includes information such as (x,y) coordinates, width, and height.-->
<!--If you manually edit this section and make a mistake, you can delete it. -->
<!--The package will still be able to load normally but the previous layout information will be lost and the designer will automatically re-arrange the elements on the design surface.-->
<Objects
  Version="8">
  <!--Each node below will contain properties that do not affect runtime behavior.-->
  <Package
    design-time-name="Package">
    <LayoutInfo>
      <GraphLayout
        Capacity="8" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph" xmlns:mssgle="clr-namespace:Microsoft.SqlServer.Graph.LayoutEngine;assembly=Microsoft.SqlServer.Graph" xmlns:assembly="http://schemas.microsoft.com/winfx/2006/xaml">
        <NodeLayout
          Size="307,42"
          Id="Package\Actualiza H_CIRCUITO_FACT_DEB_REFACT"
          TopLeft="27.1132075471699,90.179245283019" />
        <NodeLayout
          Size="359,42"
          Id="Package\Actualiza Plazos en H_CIRCUITO_FACT_DEB_REFACT"
          TopLeft="1.11320754716985,174.858490566038" />
        <NodeLayout
          Size="160,42"
          Id="Package\Variable Periodo"
          TopLeft="100.61320754717,5.5" />
        <EdgeLayout
          Id="Package.PrecedenceConstraints[Constraint]"
          TopLeft="180.61320754717,47.5">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="0,42.679245283019"
              Start="0,0"
              End="0,35.179245283019">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,35.179245283019" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
        <EdgeLayout
          Id="Package.PrecedenceConstraints[Constraint 2]"
          TopLeft="180.61320754717,132.179245283019">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="0,42.679245283019"
              Start="0,0"
              End="0,35.179245283019">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,35.179245283019" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
      </GraphLayout>
    </LayoutInfo>
  </Package>
</Objects>]]></DTS:DesignTimeProperties>
</DTS:Executable>