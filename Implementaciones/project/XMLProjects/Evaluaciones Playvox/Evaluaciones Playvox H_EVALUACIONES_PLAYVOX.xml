<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationDate="11/28/2017 1:14:50 PM"
  DTS:CreationName="Microsoft.Package"
  DTS:CreatorComputerName="AMS06X"
  DTS:CreatorName="AMS\jtrinchier"
  DTS:DTSID="{D331F395-9DEB-4C69-AE16-0066AF90D566}"
  DTS:ExecutableType="Microsoft.Package"
  DTS:LastModifiedProductVersion="15.0.1301.433"
  DTS:LocaleID="11274"
  DTS:ObjectName="Evaluaciones Playvox H_EVALUACIONES_PLAYVOX"
  DTS:PackageType="5"
  DTS:VersionBuild="40"
  DTS:VersionGUID="{94976C6C-8CF1-48EF-A362-2CD13D644E2D}">
  <DTS:Property
    DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:LogProviders>
    <DTS:LogProvider
      DTS:ConfigString="DS_MSDB"
      DTS:CreationName="Microsoft.LogProviderSQLServer"
      DTS:Description="Writes log entries for events to a SQL Server database"
      DTS:DTSID="{D96C09FB-816B-42BD-84FC-8F287D3F32B0}"
      DTS:ObjectName="SSIS log provider for SQL Server">
      <DTS:ObjectData>
        <InnerObject />
      </DTS:ObjectData>
    </DTS:LogProvider>
  </DTS:LogProviders>
  <DTS:Variables />
  <DTS:LoggingOptions
    DTS:FilterKind="0"
    DTS:LoggingMode="1">
    <DTS:Property
      DTS:DataType="8"
      DTS:Name="EventFilter">1,7,OnError</DTS:Property>
    <DTS:Property
      DTS:EventName="OnError"
      DTS:Name="ColumnFilter">
      <DTS:Property
        DTS:Name="Computer">-1</DTS:Property>
      <DTS:Property
        DTS:Name="Operator">-1</DTS:Property>
      <DTS:Property
        DTS:Name="SourceName">-1</DTS:Property>
      <DTS:Property
        DTS:Name="SourceID">-1</DTS:Property>
      <DTS:Property
        DTS:Name="ExecutionID">-1</DTS:Property>
      <DTS:Property
        DTS:Name="MessageText">-1</DTS:Property>
      <DTS:Property
        DTS:Name="DataBytes">-1</DTS:Property>
    </DTS:Property>
    <DTS:SelectedLogProviders>
      <DTS:SelectedLogProvider
        DTS:InstanceID="{D96C09FB-816B-42BD-84FC-8F287D3F32B0}" />
    </DTS:SelectedLogProviders>
  </DTS:LoggingOptions>
  <DTS:Executables>
    <DTS:Executable
      DTS:refId="Package\Actualiza H_EVALUACIONES_PLAYVOX"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{A6187B7C-3956-4121-B285-37C564B18308}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Actualiza H_EVALUACIONES_PLAYVOX"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{D3AA9E3F-6BC3-471B-90AB-1F81547A9B0A}"
          SQLTask:SqlStatementSource="---- Inserta en la H_EVALUACIONES_PlayVox la info relacionada entre las siguientes tablas:&#xA;---- Consultas_DW.dbo.AUX_H_Info_EVALUACIONES_PlayVox --- &gt; tabla con información del Excel&#xA;---- RRHH.rrhh.dbo.empleado --- &gt; tabla que contiene los mail de los empleados en el server AMS07X&#xA;---- D_USUARIOS_PlayVox y D_MONITORES tablas de dimension que pasan id_usuario_PlayVox e id_monitor&#xA;---- Se agrego en el filtro &quot;fecha_egreso is null&quot; porque toma solo los mail activos de los empleados (existen casos donde un empleado era de Staff y hoy de Sancor Salud)&#xA;Declare @Periodo int&#xA;Set @Periodo = (SELECT&#x9;max(dbo.DevuelvePeriodo(fecha_evaluacion)) from CONSULTAS_DW.DBO.AUX_H_INFO_EVALUACIONES_PLAYVOX A )&#xA;&#xA;INSERT INTO H_EVALUACIONES_PLAYVOX&#xA;(id_periodo, id_usuario_playvox, id_monitor, puntaje_obtenido, puntaje_total, objetivo_playvox, fecha_evaluacion ,id_plantilla_playvox)&#xA;SELECT&#x9;dbo.DevuelvePeriodo(fecha_evaluacion)&#xA;&#x9;&#x9;,U.id_usuario_playvox&#xA;&#x9;&#x9;,M.id_monitor&#xA;&#x9;&#x9;,puntaje_obtenido&#xA;&#x9;&#x9;,puntaje_total&#xA;&#x9;&#x9;,objetivo_playvox / 100&#xA;&#x9;&#x9;,fecha_evaluacion&#xA;                               ,id_plantilla_playvox&#xA;FROM CONSULTAS_DW.DBO.AUX_H_INFO_EVALUACIONES_PLAYVOX A &#xA;INNER JOIN RRHH.RRHH.DBO.EMPLEADO E ON (E.email_empresa COLLATE SQL_Latin1_General_CP850_CI_AI=A.email)&#xA;INNER JOIN D_USUARIOS_PLAYVOX U ON (E.usuario COLLATE SQL_Latin1_General_CP850_CI_AI=U.de_usuario_playvox)&#xA;INNER JOIN D_MONITORES M ON (M.de_monitor=A.de_monitor)&#xA;WHERE fecha_egreso IS NULL and U.id_usuario_playvox not in&#xA; (select distinct id_usuario_playvox from H_EVALUACIONES_PLAYVOX where id_periodo in( @Periodo))&#xA;&#xA;&#xA;&#xA;&#xA;---- Actualiza la id_unidad_organizacional_contacto, para el periodo que estamos procesando con la info actual del contacto&#xA;&#xA;&#xA;UPDATE &#x9;H_EVALUACIONES_PLAYVOX set id_unidad_organizacional_contacto =&#xA;a12.id_unidad_organizacional_contacto&#xA;from&#x9;H_EVALUACIONES_PLAYVOX&#x9;a11&#xA;&#x9;join&#x9;D_USUARIOS_PLAYVOX&#x9;a12&#xA;&#x9;  on &#x9;(a11.id_usuario_playvox = a12.id_usuario_playvox)&#xA;&#x9;join&#x9;D_UNIDADES_ORGANIZACIONALES_CONTACTOS&#x9;a13&#xA;&#x9;  on &#x9;(a12.id_unidad_organizacional_contacto = a13.id_unidad_organizacional_contacto)&#xA;&#x9;  &#xA;&#x9;  where id_agrupador_unidad_organizacional_contacto in (1,2)&#xA;&#x9;  and a11.id_periodo = @PERIODO&#xA;&#xA;&#x9;  &#x9;  --- si no es car o contact, le pega el que tenga el usuario de playvox en la D_USUARIOS_PLAYVOX&#xA;&#xA;&#x9;UPDATE &#x9;H_EVALUACIONES_PLAYVOX set id_unidad_organizacional_contacto = a12.id_unidad_organizacional_contacto&#xA;  from&#x9;H_EVALUACIONES_PLAYVOX&#x9;a11&#xA;&#x9;join&#x9;D_USUARIOS_PLAYVOX&#x9;a12&#xA;&#x9;  on &#x9;(a11.id_usuario_playvox = a12.id_usuario_playvox)&#xA;&#x9;join&#x9;D_UNIDADES_ORGANIZACIONALES_CONTACTOS&#x9;a13&#xA;&#x9;  on &#x9;(a12.id_unidad_organizacional_contacto = a13.id_unidad_organizacional_contacto)&#xA;&#x9;  where a11.id_unidad_organizacional_contacto is null&#xA;&#x9;  and a11.id_periodo = @PERIODO&#xA;&#xA;&#xA;&#xA;---- Frena el proceso si la cantidad de registros del excel no es la misma que en la H&#xA;&#xA;IF (select count(id_periodo) from H_EVALUACIONES_PLAYVOX where id_periodo = @Periodo) &lt;&gt; (select count(id_plantilla_playvox) from CONSULTAS_DW.DBO.AUX_H_INFO_EVALUACIONES_PLAYVOX)&#xA;BEGIN&#xA;RAISERROR ('Cantidad de Registros Incorrecta en Proceso Actualización H_EVALUACIONES_PLAYVOX.', 11, 1)&#xA;END&#xA;&#xA;&#xA;" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:DesignTimeProperties><![CDATA[<?xml version="1.0"?>
<!--Esta sección CDATA contiene la información de diseño del paquete. Esta sección incluye información como, por ejemplo, las coordenadas (x,y), el ancho y el alto.-->
<!--Si edita manualmente esta sección y comete un error, puede eliminarlo. -->
<!--El paquete podrá cargarse normalmente, pero se perderá la información de diseño anterior y el diseñador reorganizará los elementos automáticamente en la superficie de diseño.-->
<Objects
  Version="8">
  <!--Cada uno de los nodos siguientes contiene propiedades que no afectan al comportamiento en tiempo de ejecución.-->
  <Package
    design-time-name="Package">
    <LayoutInfo>
      <GraphLayout
        Capacity="4" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph">
        <NodeLayout
          Size="284,42"
          Id="Package\Actualiza H_EVALUACIONES_PLAYVOX"
          TopLeft="5.5,5.5" />
      </GraphLayout>
    </LayoutInfo>
  </Package>
</Objects>]]></DTS:DesignTimeProperties>
</DTS:Executable>