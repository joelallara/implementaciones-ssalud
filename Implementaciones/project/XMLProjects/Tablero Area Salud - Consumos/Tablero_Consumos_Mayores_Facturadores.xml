<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationDate="7/27/2016 8:26:28 AM"
  DTS:CreationName="Microsoft.Package"
  DTS:CreatorComputerName="AMS06X"
  DTS:CreatorName="AMS\nprida"
  DTS:DTSID="{C06417D3-C86C-4841-9DD9-FE4501D877ED}"
  DTS:ExecutableType="Microsoft.Package"
  DTS:LastModifiedProductVersion="15.0.1301.433"
  DTS:LocaleID="11274"
  DTS:ObjectName="Tablero_Consumos_Mayores_Facturadores"
  DTS:PackageType="5"
  DTS:VersionBuild="24"
  DTS:VersionGUID="{542A5F43-E17E-4A27-A98D-1244D28876FF}">
  <DTS:Property
    DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:LogProviders>
    <DTS:LogProvider
      DTS:ConfigString="DS_MSDB"
      DTS:CreationName="Microsoft.LogProviderSQLServer"
      DTS:Description="Writes log entries for events to a SQL Server database"
      DTS:DTSID="{741A8932-56E3-4F6D-8887-9C26A475BFFE}"
      DTS:ObjectName="SSIS log provider for SQL Server">
      <DTS:ObjectData>
        <InnerObject />
      </DTS:ObjectData>
    </DTS:LogProvider>
  </DTS:LogProviders>
  <DTS:Variables />
  <DTS:LoggingOptions
    DTS:FilterKind="0"
    DTS:LoggingMode="1">
    <DTS:SelectedLogProviders>
      <DTS:SelectedLogProvider
        DTS:InstanceID="{741A8932-56E3-4F6D-8887-9C26A475BFFE}" />
    </DTS:SelectedLogProviders>
  </DTS:LoggingOptions>
  <DTS:Executables>
    <DTS:Executable
      DTS:refId="Package\DM_MAYORES_FACTURADORES"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Tarea Ejecutar SQL"
      DTS:DTSID="{A826D610-AA91-422E-924B-13A1CB07FFC7}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="DM_MAYORES_FACTURADORES"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{BF595323-C78F-4C6D-A7DC-EA2565A19B14}"
          SQLTask:SqlStatementSource="-- AQ 02.01.2020 &#xA;-- Se ajusta ETL para pasar a tabla definitiva el total de registros para que luego en los reportes coincidan los totales tanto de &#xA;-- reportes de Consumos como de T3, porque con la lógica de Top10 se lograba Total=Amb+Int, pero este total era menor al de Consumos&#xA;&#xA;&#xA;--BORRAMOS TABLAS USADAS PARA EL CALCULO&#xA;if exists (select * from sysobjects where name = 'AUX_DM_MAYORES_FACTURADORES')&#xA;  begin&#xA;     drop table AUX_DM_MAYORES_FACTURADORES&#xA;  end&#xA;GO&#xA;&#xA;Truncate Table DM_MAYORES_FACTURADORES&#xA;&#xA;GO&#xA;&#xA;&#xA;--ARMAMOS TABLA MAYORES FACTURADORES&#xA;--Calculo ambulatorio&#xA;select DRL.id_compania, a15.id_posicion, a11.Id_Tipo_Prestador, a11.id_acreedor,&#xA; A11.id_origen_prestacion,  sum(a11.imp_pret_amb_pag) as IMP_PAG,&#xA; CE.id_subtipo_venta as id_subtipo_venta ,a13.id_plan_agrupado_G&#xA;INTO AUX_DM_MAYORES_FACTURADORES&#xA;from H_ORD_AMB_DET a11     &#xA; join D_PLANES a12    &#xA;   on  (a11.id_plan_producto = a12.id_plan_producto and a11.id_producto = a12.id_producto)&#xA; join D_PLANES_AGRUPADOS a13    &#xA;   on  (a12.id_plan_agrupado = a13.id_plan_agrupado)&#xA; join D_PERSONAS a14    &#xA;   on  (a11.id_persona = a14.id_persona)&#xA; join D_LOCALIDADES_AFILIADO a15    &#xA;   on  (a14.id_localidad_afiliado = a15.id_localidad_afiliado)&#xA; join D_PRODUCTOS a16    &#xA;   on  (a11.id_producto = a16.id_producto)&#xA; join D_SUBRUBRO_LEY DSL     on (DSL.Id_SubRubro_Ley = a12.id_SubRubro_ley)&#xA; join D_RUBRO_LEY DRL     on (DRL.Id_Rubro_ley = DSL.id_Rubro_Ley)&#xA; join H_CONVENIOS_EMPRESAS CE ON CE.id_convenio = a11.id_convenio and a11.id_tipo_entidad_convenio = CE.id_tipo_entidad_convenio and CE.id_periodo = a11.id_periodo&#xA;WHERE DSL.id_SubRubro_ley in (1,2,3,5,6,7) &#xA; and a16.id_segmento not in (3)&#xA; and not exists (select fpp.id_producto, fpp.id_plan_producto from FILTRO_PLAN_PRODUCTO fpp    where fpp.id_producto = a11.id_producto and fpp.id_plan_producto = a11.id_plan_producto)&#xA; and  a11.id_reintegro in ('F','R')&#xA; and a11.ccosto2 = 1&#xA; and a11.id_periodo in (select top 12 H.id_periodo from D_PERIODO H    where H.vigente_consumo=1 group by  H.id_periodo order by H.id_periodo DESC)&#xA;group by a15.id_posicion, a11.id_acreedor, a11.Id_Tipo_Prestador, A11.id_origen_prestacion, DRL.id_compania, CE.id_subtipo_venta, a13.id_plan_agrupado_G&#xA;&#xA;&#xA;&#xA;--calculo internaciones&#xA;INSERT INTO AUX_DM_MAYORES_FACTURADORES&#xA;select DRL.id_compania, a15.id_posicion, a11.Id_Tipo_Prestador, a11.id_acreedor,&#xA; A11.id_origen_prestacion,  sum(a11.imp_prest_int_pag) as IMP_PAG, CE.id_subtipo_venta as id_subtipo_venta ,a13.id_plan_agrupado_G&#xA;from H_ORD_INT_DET a11     &#xA; join D_PLANES a12    &#xA;   on  (a11.id_plan_producto = a12.id_plan_producto and a11.id_producto = a12.id_producto)&#xA; join D_PLANES_AGRUPADOS a13    &#xA;   on  (a12.id_plan_agrupado = a13.id_plan_agrupado)&#xA; join D_PERSONAS a14    &#xA;   on  (a11.id_persona = a14.id_persona)&#xA; join D_LOCALIDADES_AFILIADO a15    &#xA;   on  (a14.id_localidad_afiliado = a15.id_localidad_afiliado)&#xA; join D_PRODUCTOS a16    &#xA;   on  (a11.id_producto = a16.id_producto)&#xA; join D_SUBRUBRO_LEY DSL     on (DSL.Id_SubRubro_Ley = a12.id_SubRubro_ley)&#xA; join D_RUBRO_LEY DRL     on (DRL.Id_Rubro_ley = DSL.id_Rubro_Ley)&#xA; join H_CONVENIOS_EMPRESAS CE ON CE.id_convenio = a11.id_convenio and a11.id_tipo_entidad_convenio = CE.id_tipo_entidad_convenio and CE.id_periodo = a11.id_periodo&#xA;WHERE DSL.id_SubRubro_ley in (1,2,3,5,6,7) &#xA; and a16.id_segmento not in (3)&#xA; and not exists (select fpp.id_producto, fpp.id_plan_producto from FILTRO_PLAN_PRODUCTO fpp    where fpp.id_producto = a11.id_producto and fpp.id_plan_producto = a11.id_plan_producto)&#xA; and  a11.id_reintegro in ('F','R')&#xA; and a11.ccosto2 = 1&#xA; and a11.id_periodo in (select top 12 H.id_periodo from D_PERIODO H    where H.vigente_consumo=1 group by  H.id_periodo order by H.id_periodo DESC)&#xA;group by a15.id_posicion, a11.id_acreedor, a11.Id_Tipo_Prestador, &#xA; A11.id_origen_prestacion, DRL.id_compania, CE.id_subtipo_venta, a13.id_plan_agrupado_G&#xA;&#xA;&#xA;--CALCULAMOS un origen de prestacion TOTAL, que agrupe ambos par poder calcular el top sebre el total.&#xA;insert into AUX_DM_MAYORES_FACTURADORES&#xA;Select id_compania, id_posicion, Id_Tipo_Prestador, id_acreedor, &#xA;'T' as id_origen_prestacion, sum(IMP_PAG) , id_subtipo_venta, id_plan_agrupado_G &#xA;from AUX_DM_MAYORES_FACTURADORES &#xA;group by  id_posicion,  Id_Acreedor, Id_Tipo_Prestador, id_compania , id_subtipo_venta , id_plan_agrupado_G&#xA;&#xA;&#xA;-- AQ - Pasaje a tabla definitiva&#xA;INSERT INTO DM_MAYORES_FACTURADORES&#xA;&#x9;(id_compania, id_posicion, Id_Tipo_Prestador, Id_Acreedor,id_origen_prestacion, imp_pag_may_facturadores_T3,&#xA;&#x9;id_empresa_PE_T3 , id_tipo_entidad_PE_T3 ,id_marca_PE_T3 ,  id_plan_agrupado_G, id_subtipo_venta)&#xA;Select &#xA;&#x9;id_compania, id_posicion, Id_Tipo_Prestador, Id_Acreedor, id_origen_prestacion, IMP_PAG , &#xA;&#x9;0 as id_empresa_PE_T3 , 'I' as id_tipo_entidad_PE_T3 , 0 as id_marca_PE_T3 ,  id_plan_agrupado_G, id_subtipo_venta&#xA;FROM  AUX_DM_MAYORES_FACTURADORES&#xA;&#xA;     &#xA;--BORRAMOS TABLAS USADAS PARA EL CALCULO&#xA;if exists (select * from sysobjects where name = 'AUX_DM_MAYORES_FACTURADORES')&#xA;  begin&#xA;     drop table AUX_DM_MAYORES_FACTURADORES&#xA;  end&#xA;GO" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\DM_MAYORES_FACTURADORES_DETALLE"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Tarea Ejecutar SQL"
      DTS:Disabled="True"
      DTS:DTSID="{2E574087-5A7D-41A8-8825-4804A75EE5BE}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="DM_MAYORES_FACTURADORES_DETALLE"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{BF595323-C78F-4C6D-A7DC-EA2565A19B14}"
          SQLTask:SqlStatementSource="if exists (select * from sysobjects where name = 'H1')&#xA;  begin&#xA;     drop table H1&#xA;  end&#xA;&#xA;if exists (select * from sysobjects where name = 'H2')&#xA;  begin&#xA;     drop table H2&#xA;  end&#xA;&#xA;--AMBULATORIO&#xA;&#xA;select DRL.id_compania, DM.id_acreedor, DM.id_tipo_prestador, &#xA;a11.id_prestacion, sum(a11.imp_pret_amb_pag) Imp_Pag_AMB, DM.id_subtipo_venta,DM.id_plan_agrupado_G&#xA;INTO H1&#xA;FROM DM_MAYORES_FACTURADORES DM  &#xA;JOIN H_ORD_AMB_DET a11    ON (DM.id_acreedor = A11.id_acreedor and DM.id_tipo_prestador = a11.id_Tipo_Prestador)&#xA;join H_CONVENIOS_EMPRESAS CE on CE.id_convenio = a11.id_convenio and CE.id_tipo_entidad_convenio = a11.id_tipo_entidad_convenio and CE.id_periodo = a11.id_periodo and CE.id_subtipo_venta = DM.id_subtipo_venta&#xA; join D_PRODUCTOS a16  &#xA;   on  (a11.id_producto = a16.id_producto)&#xA; join D_PERSONAS DP      on (a11.id_persona = DP.id_persona)&#xA; join D_LOCALIDADES_AFILIADO DL     on (DL.id_localidad_afiliado = DP.id_localidad_afiliado and DL.id_posicion = DM.id_posicion)&#xA; join D_PLANES a12   &#xA;   on  (a11.id_plan_producto = a12.id_plan_producto and a11.id_producto = a12.id_producto)&#xA; join D_PLANES_AGRUPADOS a13   &#xA;   on  (a12.id_plan_agrupado = a13.id_plan_agrupado and DM.id_plan_agrupado_G = a13.id_plan_agrupado_G)&#xA; join D_SUBRUBRO_LEY DSL    on (DSL.Id_SubRubro_Ley = a12.id_SubRubro_ley) &#xA; join D_RUBRO_LEY DRL     on (DRL.Id_Rubro_ley = DSL.id_Rubro_Ley)&#xA;where a11.id_periodo in (select top 12 H.id_periodo from D_PERIODO H   where H.vigente_consumo=1 group by  H.id_periodo order by H.id_periodo DESC)&#xA;and a16.id_segmento not in (3)&#xA;and ccosto2 = 1 &#xA;and DSL.id_SubRubro_ley in (1,2,3,5,6,7) &#xA;and  a11.id_reintegro in ('F','R')&#xA;and not EXISTS (select fpp.id_producto, fpp.id_plan_producto from FILTRO_PLAN_PRODUCTO fpp     where fpp.id_producto = a11.id_producto and fpp.id_plan_producto = a11.id_plan_producto)&#xA;and DM.id_origen_prestacion = 'T'&#xA;group by DRL.id_compania, DM.id_tipo_prestador, a11.id_prestacion, DM.id_acreedor, DM.id_subtipo_venta, DM.id_plan_agrupado_G&#xA;&#xA;--INTERNACION&#xA;select DRL.id_compania, DM.id_acreedor, DM.id_tipo_prestador, &#xA;a11.id_prestacion, sum(a11.imp_prest_int_pag) Imp_Pag_int, DM.id_subtipo_venta, DM.id_plan_agrupado_G&#xA;INTO H2&#xA;FROM DM_MAYORES_FACTURADORES DM  &#xA;JOIN H_ORD_INT_DET a11    ON (DM.id_acreedor = A11.id_acreedor and DM.id_tipo_prestador = a11.id_Tipo_Prestador)&#xA;join H_CONVENIOS_EMPRESAS CE on CE.id_convenio = a11.id_convenio and CE.id_tipo_entidad_convenio = a11.id_tipo_entidad_convenio and CE.id_periodo = a11.id_periodo and CE.id_subtipo_venta = DM.id_subtipo_venta&#xA; join D_PRODUCTOS a16  &#xA;   on  (a11.id_producto = a16.id_producto)&#xA; join D_PERSONAS DP      on (a11.id_persona = DP.id_persona)&#xA; join D_LOCALIDADES_AFILIADO DL     on (DL.id_localidad_afiliado = DP.id_localidad_afiliado and DL.id_posicion = DM.id_posicion)&#xA; join D_PLANES a12   &#xA;   on  (a11.id_plan_producto = a12.id_plan_producto and a11.id_producto = a12.id_producto)&#xA; join D_PLANES_AGRUPADOS a13   &#xA;   on  (a12.id_plan_agrupado = a13.id_plan_agrupado and DM.id_plan_agrupado_G = a13.id_plan_agrupado_G)&#xA; join D_SUBRUBRO_LEY DSL    on (DSL.Id_SubRubro_Ley = a12.id_SubRubro_ley) &#xA; join D_RUBRO_LEY DRL     on (DRL.Id_Rubro_ley = DSL.id_Rubro_Ley)&#xA;where a11.id_periodo in (select top 12 H.id_periodo from D_PERIODO H   where H.vigente_consumo=1 group by  H.id_periodo order by H.id_periodo DESC)&#xA;and a16.id_segmento not in (3)&#xA;and ccosto2 = 1 &#xA;and DSL.id_SubRubro_ley in (1,2,3,5,6,7) &#xA;and  a11.id_reintegro in ('F','R')&#xA;and not EXISTS (select fpp.id_producto, fpp.id_plan_producto from FILTRO_PLAN_PRODUCTO fpp     where fpp.id_producto = a11.id_producto and fpp.id_plan_producto = a11.id_plan_producto)&#xA;and DM.id_origen_prestacion = 'T'&#xA;group by DRL.id_compania, DM.id_tipo_prestador, a11.id_prestacion, DM.id_acreedor, DM.id_subtipo_venta, DM.id_plan_agrupado_G&#xA;&#xA;&#xA;Truncate table DM_MAYORES_FACTURADORES_DETALLE&#xA;&#xA;INSERT INTO DM_MAYORES_FACTURADORES_DETALLE&#xA;select &#xA;  coalesce(pa11.id_compania, pa12.id_compania) id_compania,&#xA;  coalesce(pa11.Id_Prestacion, pa12.Id_Prestacion) Id_Prestacion,&#xA;    coalesce(pa11.id_acreedor, pa12.id_acreedor)  id_acreedor, &#xA;  coalesce(pa11.id_tipo_prestador, pa12.id_tipo_prestador)  id_tipo_prestador, &#xA;  (IsNull(pa11.Imp_Pag_AMB,0) + IsNull(pa12.Imp_Pag_INT,0)) IMP_PAG,&#xA;  0 as id_empresa_PE_T3,&#xA;  'I' as id_tipo_entidad_PE_T3,&#xA;  0 as id_marca_PE_T3,&#xA;  coalesce(pa11.id_plan_agrupado_G, pa12.id_plan_agrupado_G)  id_plan_agrupado_G ,&#xA;  0 as id_convenio,&#xA;  'I' as id_tipo_entidad_convenio,&#xA;  coalesce(pa11.id_subtipo_venta, pa12.id_subtipo_venta)  id_subtipo_venta&#xA;from H1 pa11  &#xA; full outer join H2 pa12  &#xA;   on  (pa11.Id_Prestacion = pa12.Id_Prestacion)  AND (pa11.id_acreedor = pa12.id_acreedor) &#xA;   AND (pa12.id_tipo_prestador = pa11.id_tipo_prestador)  and (pa12.id_compania = pa11.id_compania)&#xA;   and pa11.id_subtipo_venta = pa12.id_subtipo_venta and pa11.id_plan_agrupado_G = pa12.id_plan_agrupado_G&#xA;&#xA;&#xA;-----------------------------------------------------------------------------------&#xA;&#xA;if exists (select * from sysobjects where name = 'H1')&#xA;  begin&#xA;     drop table H1&#xA;  end&#xA;&#xA;if exists (select * from sysobjects where name = 'H2')&#xA;  begin&#xA;     drop table H2&#xA;  end&#xA;&#xA;" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:PrecedenceConstraints>
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[Constraint 1]"
      DTS:CreationName=""
      DTS:DTSID="{0A40B053-5DD1-46B3-808C-CBDA353B3261}"
      DTS:From="Package\DM_MAYORES_FACTURADORES"
      DTS:LogicalAnd="True"
      DTS:ObjectName="Constraint 1"
      DTS:To="Package\DM_MAYORES_FACTURADORES_DETALLE" />
  </DTS:PrecedenceConstraints>
  <DTS:DesignTimeProperties><![CDATA[<?xml version="1.0"?>
<!--This CDATA section contains the layout information of the package. The section includes information such as (x,y) coordinates, width, and height.-->
<!--If you manually edit this section and make a mistake, you can delete it. -->
<!--The package will still be able to load normally but the previous layout information will be lost and the designer will automatically re-arrange the elements on the design surface.-->
<Objects
  Version="8">
  <!--Each node below will contain properties that do not affect runtime behavior.-->
  <Package
    design-time-name="Package">
    <LayoutInfo>
      <GraphLayout
        Capacity="4" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph" xmlns:mssgle="clr-namespace:Microsoft.SqlServer.Graph.LayoutEngine;assembly=Microsoft.SqlServer.Graph" xmlns:assembly="http://schemas.microsoft.com/winfx/2006/xaml">
        <NodeLayout
          Size="254,42"
          Id="Package\DM_MAYORES_FACTURADORES"
          TopLeft="31.2311320754717,5.5" />
        <NodeLayout
          Size="309,42"
          Id="Package\DM_MAYORES_FACTURADORES_DETALLE"
          TopLeft="3.73113207547169,116.292452830189" />
        <EdgeLayout
          Id="Package.PrecedenceConstraints[Constraint 1]"
          TopLeft="158.231132075472,47.5">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="0,68.7924528301887"
              Start="0,0"
              End="0,61.2924528301887">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,61.2924528301887" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
      </GraphLayout>
    </LayoutInfo>
  </Package>
</Objects>]]></DTS:DesignTimeProperties>
</DTS:Executable>