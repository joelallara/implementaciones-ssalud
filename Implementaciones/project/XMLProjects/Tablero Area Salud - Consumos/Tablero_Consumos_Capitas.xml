<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationDate="7/27/2016 8:34:46 AM"
  DTS:CreationName="Microsoft.Package"
  DTS:CreatorComputerName="AMS06X"
  DTS:CreatorName="AMS\nprida"
  DTS:DTSID="{B6AB027D-D93E-4982-8D7B-1336E67749E5}"
  DTS:ExecutableType="Microsoft.Package"
  DTS:LastModifiedProductVersion="15.0.1301.433"
  DTS:LocaleID="11274"
  DTS:ObjectName="Tablero_Consumos_Capitas"
  DTS:PackageType="5"
  DTS:VersionBuild="16"
  DTS:VersionGUID="{B61169A0-1539-413F-9D92-F00C8FE0DFEE}">
  <DTS:Property
    DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:LogProviders>
    <DTS:LogProvider
      DTS:ConfigString="DS_MSDB"
      DTS:CreationName="Microsoft.LogProviderSQLServer"
      DTS:Description="Writes log entries for events to a SQL Server database"
      DTS:DTSID="{53E0E78A-1CFE-4E03-AD26-6BE0BBB08ED3}"
      DTS:ObjectName="SSIS log provider for SQL Server">
      <DTS:ObjectData>
        <InnerObject />
      </DTS:ObjectData>
    </DTS:LogProvider>
  </DTS:LogProviders>
  <DTS:Variables />
  <DTS:LoggingOptions
    DTS:FilterKind="0"
    DTS:LoggingMode="1">
    <DTS:SelectedLogProviders>
      <DTS:SelectedLogProvider
        DTS:InstanceID="{53E0E78A-1CFE-4E03-AD26-6BE0BBB08ED3}" />
    </DTS:SelectedLogProviders>
  </DTS:LoggingOptions>
  <DTS:Executables>
    <DTS:Executable
      DTS:refId="Package\DM_CAPITAS"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Tarea Ejecutar SQL"
      DTS:DTSID="{E4A23CF3-EDCC-4D49-BABF-4750E4D04FD7}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="DM_CAPITAS"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{BF595323-C78F-4C6D-A7DC-EA2565A19B14}"
          SQLTask:SqlStatementSource="-- Arma DM_AMS_CAPITAS Redefinir como DM_AMS_GRAV_CAPITAS&#xA;&#xA;if exists (select * from sysobjects where name = 'H1')&#xA;  begin&#xA;     drop table H1&#xA;  end&#xA;&#xA;if exists (select * from sysobjects where name = 'H2')&#xA;  begin&#xA;     drop table H2&#xA;  end&#xA;&#xA;if exists (select * from sysobjects where name = 'H3')&#xA;  begin&#xA;     drop table H3&#xA;  end&#xA;&#xA;if exists (select * from sysobjects where name = 'H4')&#xA;  begin&#xA;     drop table H4&#xA;  end&#xA;&#xA;if exists (select * from sysobjects where name = 'H5')&#xA;  begin&#xA;     drop table H5&#xA;  end&#xA;&#xA;&#xA;declare @periodo int&#xA;set @periodo =  (select top 1 H.id_periodo from D_PERIODO H where H.vigente_consumo=1 group by  H.id_periodo order by H.id_periodo desc)&#xA;&#xA;select  a15.id_posicion, &#xA;a11.id_provision, DRL.id_compania, sum(a11.imp_pret_amb_pag) Imp_Pag_AMB,&#xA; CE.id_subtipo_venta, a13.id_plan_agrupado_G&#xA;INTO H1&#xA;from H_ORD_AMB_DET a11&#xA; join D_PLANES a12&#xA;   on  (a11.id_plan_producto = a12.id_plan_producto and a11.id_producto = a12.id_producto)&#xA; join D_PLANES_AGRUPADOS a13&#xA;   on  (a12.id_plan_agrupado = a13.id_plan_agrupado)&#xA; join D_PERSONAS a14&#xA;   on  (a11.id_persona = a14.id_persona)&#xA; join D_LOCALIDADES_AFILIADO a15&#xA;   on  (a14.id_localidad_afiliado = a15.id_localidad_afiliado)&#xA; join D_PRODUCTOS a16&#xA;   on  (a11.id_producto = a16.id_producto)&#xA; JOIN D_SUBRUBRO_LEY DSL on (DSL.Id_SubRubro_Ley = a12.id_SubRubro_ley)&#xA; join D_RUBRO_LEY DRL on (DSL.id_Rubro_Ley = DRL.Id_Rubro_ley)&#xA; JOIN H_CONVENIOS_EMPRESAS CE ON CE.id_convenio = a11.id_convenio and a11.id_tipo_entidad_convenio = CE.id_tipo_entidad_convenio and a11.id_periodo = CE.id_periodo &#xA;WHERE  DSL.id_SubRubro_ley in (1,2,3,5,6,7) &#xA; and a16.id_segmento not in (3)&#xA; and ccosto2 = 1&#xA; AND imp_pret_amb_pag &lt;&gt; 0&#xA; and not EXISTS (select fpp.id_producto, fpp.id_plan_producto from FILTRO_PLAN_PRODUCTO fpp where fpp.id_producto = a11.id_producto and fpp.id_plan_producto = a11.id_plan_producto)&#xA; and a11.id_periodo = @periodo&#xA;group by  a15.id_posicion, a11.id_provision,  DRL.id_compania, CE.id_subtipo_venta, a13.id_plan_agrupado_G&#xA;&#xA;select  a15.id_posicion, &#xA;a11.id_provision,  DRL.id_compania, sum(a11.imp_prest_int_pag) Imp_Pag_INT,&#xA;CE.id_subtipo_venta, a13.id_plan_agrupado_G&#xA;INTO H2&#xA;from H_ORD_INT_DET a11&#xA; join D_PLANES a12&#xA;   on  (a11.id_plan_producto = a12.id_plan_producto and a11.id_producto = a12.id_producto)&#xA; join D_PLANES_AGRUPADOS a13&#xA;   on  (a12.id_plan_agrupado = a13.id_plan_agrupado)&#xA; join D_PERSONAS a14&#xA;   on  (a11.id_persona = a14.id_persona)&#xA; join D_LOCALIDADES_AFILIADO a15&#xA;   on  (a14.id_localidad_afiliado = a15.id_localidad_afiliado)&#xA; join D_PRODUCTOS a16&#xA;   on  (a11.id_producto = a16.id_producto)&#xA;   JOIN D_SUBRUBRO_LEY DSL on (DSL.Id_SubRubro_Ley = a12.id_SubRubro_ley)&#xA;   join D_RUBRO_LEY DRL on (DSL.id_Rubro_Ley = DRL.Id_Rubro_ley)&#xA;   JOIN H_CONVENIOS_EMPRESAS CE ON CE.id_convenio = a11.id_convenio and a11.id_tipo_entidad_convenio = CE.id_tipo_entidad_convenio and a11.id_periodo = CE.id_periodo&#xA;WHERE DSL.id_SubRubro_ley in (1,2,3,5,6,7) &#xA;and a16.id_segmento not in (3)&#xA;and ccosto2 = 1&#xA;AND imp_prest_int_pag &lt;&gt; 0 &#xA;and not EXISTS (select fpp.id_producto, fpp.id_plan_producto from FILTRO_PLAN_PRODUCTO fpp where fpp.id_producto = a11.id_producto and fpp.id_plan_producto = a11.id_plan_producto)&#xA; and a11.id_periodo = @periodo&#xA;group by  a15.id_posicion, a11.id_provision, DRL.id_compania, CE.id_subtipo_venta, a13.id_plan_agrupado_G&#xA;&#xA;select coalesce(pa11.id_posicion, pa12.id_posicion)  id_posicion,&#xA; coalesce(pa11.Id_Provision, pa12.Id_Provision) Id_Provision,&#xA; coalesce(pa11.id_compania, pa12.id_compania) id_compania,&#xA; (IsNull(pa11.Imp_Pag_AMB,0) + IsNull(pa12.Imp_Pag_INT,0)) IMP_PAG,&#xA;  coalesce(pa11.id_subtipo_venta, pa12.id_subtipo_venta)  id_subtipo_venta, &#xA;  coalesce(pa11.id_plan_agrupado_G, pa12.id_plan_agrupado_G)  id_plan_agrupado_G &#xA;INTO H3&#xA;from H1 pa11&#xA; full outer join H2 pa12&#xA;    ON (pa11.id_posicion = pa12.id_posicion) &#xA;   AND (pa11.Id_Provision = pa12.Id_Provision)&#xA;   and (pa11.id_compania = pa12.id_compania)&#xA;   and (pa11.id_subtipo_venta = pa12.id_subtipo_venta)&#xA;   and (pa11.id_plan_agrupado_G = pa12.id_plan_agrupado_G)&#xA;&#xA;select  a16.id_posicion, a12.id_provision, &#xA; DRL.id_compania, sum(a11.comer_cant_grupo_activo)  CANT_AFI,&#xA;CE.id_subtipo_venta as id_subtipo_venta, a18.id_plan_agrupado_G&#xA;into H4&#xA;from H_COMER_STOCK_AFILIA a11&#xA; cross join D_PROVISION a12&#xA; join TRANS_PERIODO a13&#xA;   on  (a11.id_periodo = a13.ID_PERIODO_ANTERIOR)&#xA; join D_PERSONAS a15&#xA;   on  (a11.id_persona = a15.id_persona)&#xA; join D_LOCALIDADES_AFILIADO a16&#xA;   on  (a15.id_localidad_afiliado = a16.id_localidad_afiliado)&#xA; join D_PLANES a17&#xA;   on  (a11.id_plan_producto = a17.id_plan_producto and &#xA; a11.id_producto = a17.id_producto)&#xA; join D_PLANES_AGRUPADOS a18&#xA;   on  (a17.id_plan_agrupado = a18.id_plan_agrupado)&#xA; join D_PRODUCTOS a19&#xA;   on  (a11.id_producto = a19.id_producto)&#xA;   JOIN D_SUBRUBRO_LEY DSL on (DSL.Id_SubRubro_Ley = a17.id_SubRubro_ley)&#xA;   join D_RUBRO_LEY DRL on (DSL.id_Rubro_Ley = DRL.Id_Rubro_ley)  &#xA;   JOIN H_CONVENIOS_EMPRESAS CE ON CE.id_convenio = a11.id_convenio and a11.id_tipo_entidad_convenio = CE.id_tipo_entidad_convenio and a11.id_periodo = CE.id_periodo&#xA;where DSL.id_SubRubro_ley in (1,2,3,5,6,7)  &#xA;and a19.id_clase_producto = 'S'&#xA;and a13.id_periodo = @periodo&#xA; and a19.id_segmento not in (3)&#xA; and not EXISTS (select fpp.id_producto, fpp.id_plan_producto from FILTRO_PLAN_PRODUCTO fpp where fpp.id_producto = a11.id_producto and fpp.id_plan_producto = a11.id_plan_producto)&#xA;group by  a16.id_posicion,  DRL.id_compania, a12.id_provision, CE.id_subtipo_venta, a18.id_plan_agrupado_G&#xA;&#xA;select  coalesce(pa11.id_posicion, pa12.id_posicion)  id_posicion,&#xA; coalesce(pa11.Id_Provision, pa12.Id_Provision) Id_Provision,&#xA; coalesce(pa11.id_compania, pa12.id_compania) id_compania,&#xA; IsNull(pa11.IMP_PAG,0) IMP_PAG,&#xA; IsNull(pa12.CANT_AFI,0) CANT_AFI,&#xA;  coalesce(pa11.id_subtipo_venta, pa12.id_subtipo_venta)  id_subtipo_venta, &#xA;  coalesce(pa11.id_plan_agrupado_G, pa12.id_plan_agrupado_G)  id_plan_agrupado_G &#xA;INTO H5&#xA;from H3 pa11&#xA; full outer join H4 pa12&#xA;   on  (pa11.id_posicion = pa12.id_posicion) AND (pa11.Id_Provision = pa12.Id_Provision)&#xA;   and (pa11.id_compania = pa12.id_compania)&#xA;   and (pa11.id_subtipo_venta = Pa12.id_subtipo_venta)&#xA;   and (pa11.id_plan_agrupado_G = Pa12.id_plan_agrupado_G)&#xA;   &#xA;delete from H5 where IMP_PAG = 0&#xA;------------------------------------------------------&#xA;&#xA;/* borro lo que ya halla para el periodo a procesar */&#xA;&#xA;delete DM_CAPITAS where id_periodo = @periodo&#xA;&#xA;&#xA;---- Inserta en la tabla DM_CAPITAS&#xA;INSERT INTO DM_CAPITAS&#xA;Select @periodo, id_compania, id_posicion, Id_Provision,  IMP_PAG, CANT_AFI as CANT_AFI_PERIODO_ANT, 0 as id_marca_PE, id_plan_agrupado_G, id_subtipo_venta&#xA;FROM H5 &#xA;&#xA;&#xA;UPDATE DM_CAPITAS &#xA;SET cant_afi_periodo_anterior_T3 = AFI.AFILIADOS&#xA;FROM DM_CAPITAS DM&#xA;INNER JOIN (Select  id_posicion, Id_Provision, id_compania,  MAX(cant_afi_periodo_anterior_T3) AFILIADOS,  0 as id_marca_PE, id_plan_agrupado_G, id_subtipo_venta&#xA;&#x9;&#x9;&#x9;FROM DM_CAPITAS WHERE id_periodo = @periodo GROUP BY  id_posicion, Id_Provision, id_compania, id_plan_agrupado_G, id_subtipo_venta) AFI&#xA;&#x9;ON (DM.id_posicion = AFI.id_posicion and DM.id_compania = AFI.id_compania&#xA;and DM.id_provision = AFI.id_provision and DM.id_subtipo_venta = AFI.id_subtipo_venta and DM.id_plan_agrupado_G = AFI.id_plan_agrupado_G )&#xA;where DM.id_periodo = @periodo&#xA;&#xA;-----------------------------------------------------------------------------------------------------&#xA;&#xA;if exists (select * from sysobjects where name = 'H1')&#xA;  begin&#xA;     drop table H1&#xA;  end&#xA;&#xA;if exists (select * from sysobjects where name = 'H2')&#xA;  begin&#xA;     drop table H2&#xA;  end&#xA;&#xA;if exists (select * from sysobjects where name = 'H3')&#xA;  begin&#xA;     drop table H3&#xA;  end&#xA;&#xA;if exists (select * from sysobjects where name = 'H4')&#xA;  begin&#xA;     drop table H4&#xA;  end&#xA;&#xA;if exists (select * from sysobjects where name = 'H5')&#xA;  begin&#xA;     drop table H5&#xA;  end" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:DesignTimeProperties><![CDATA[<?xml version="1.0"?>
<!--This CDATA section contains the layout information of the package. The section includes information such as (x,y) coordinates, width, and height.-->
<!--If you manually edit this section and make a mistake, you can delete it. -->
<!--The package will still be able to load normally but the previous layout information will be lost and the designer will automatically re-arrange the elements on the design surface.-->
<Objects
  Version="8">
  <!--Each node below will contain properties that do not affect runtime behavior.-->
  <Package
    design-time-name="Package">
    <LayoutInfo>
      <GraphLayout
        Capacity="4" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph">
        <NodeLayout
          Size="149,42"
          Id="Package\DM_CAPITAS"
          TopLeft="5.5,5.5" />
      </GraphLayout>
    </LayoutInfo>
  </Package>
</Objects>]]></DTS:DesignTimeProperties>
</DTS:Executable>