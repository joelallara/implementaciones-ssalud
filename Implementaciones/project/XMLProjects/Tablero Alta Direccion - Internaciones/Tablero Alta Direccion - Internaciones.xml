<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationDate="4/15/2013 7:51:45 AM"
  DTS:CreationName="Microsoft.Package"
  DTS:CreatorComputerName="AMS06"
  DTS:CreatorName="AMS\adminb"
  DTS:DTSID="{807814DA-AF31-42C4-8852-3035970551D1}"
  DTS:ExecutableType="Microsoft.Package"
  DTS:LastModifiedProductVersion="15.0.1301.433"
  DTS:LocaleID="1033"
  DTS:ObjectName="Tablero Alta Direccion - Internaciones"
  DTS:VersionBuild="32"
  DTS:VersionGUID="{CC182107-8CFF-4E2E-963A-09AFBA4DA634}">
  <DTS:Property
    DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:LogProviders>
    <DTS:LogProvider
      DTS:ConfigString="DS_MSDB"
      DTS:CreationName="Microsoft.LogProviderSQLServer"
      DTS:Description="Writes log entries for events to a SQL Server database"
      DTS:DTSID="{043879CF-F81B-4F7B-B4F5-4E63260DF2D1}"
      DTS:ObjectName="SSIS log provider for SQL Server">
      <DTS:ObjectData>
        <InnerObject />
      </DTS:ObjectData>
    </DTS:LogProvider>
  </DTS:LogProviders>
  <DTS:Variables />
  <DTS:LoggingOptions
    DTS:FilterKind="0"
    DTS:LoggingMode="1">
    <DTS:Property
      DTS:DataType="8"
      DTS:Name="EventFilter">1,7,OnError</DTS:Property>
    <DTS:Property
      DTS:EventName="OnError"
      DTS:Name="ColumnFilter">
      <DTS:Property
        DTS:Name="Computer">-1</DTS:Property>
      <DTS:Property
        DTS:Name="Operator">-1</DTS:Property>
      <DTS:Property
        DTS:Name="SourceName">-1</DTS:Property>
      <DTS:Property
        DTS:Name="SourceID">-1</DTS:Property>
      <DTS:Property
        DTS:Name="ExecutionID">-1</DTS:Property>
      <DTS:Property
        DTS:Name="MessageText">-1</DTS:Property>
      <DTS:Property
        DTS:Name="DataBytes">-1</DTS:Property>
    </DTS:Property>
    <DTS:SelectedLogProviders>
      <DTS:SelectedLogProvider
        DTS:InstanceID="{043879CF-F81B-4F7B-B4F5-4E63260DF2D1}" />
    </DTS:SelectedLogProviders>
  </DTS:LoggingOptions>
  <DTS:Executables>
    <DTS:Executable
      DTS:refId="Package\Actualiza H_DEBITOS_ORIGEN"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Tablero Internaciones (H_DEBITOS_ORIGEN)"
      DTS:DTSID="{5384E3D1-8DA7-43AB-BDAE-4916A0A33DEA}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Actualiza H_DEBITOS_ORIGEN"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server v9; © 2004 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{648C4EFB-6DA8-4251-892C-D04DC00A04C0}"
          SQLTask:SqlStatementSource="-- Este procedimiento incorpora a la tabla H_DEBITOS_ORIGEN los débitos correspondientes al último mes de consumo incorporado. Por lo tanto validar que el periodo en la tabla AUX_PERIODO_MES_BORRA corresponda al último periodo de consumo cargado&#xA;&#xA;DECLARE @Periodo INT&#xA;SET @Periodo = (Select max(id_periodo) from H_ORD_AMB_CAB)&#xA;&#xA;&#xA;Delete from H_DEBITOS_ORIGEN WHERE id_periodo = @Periodo&#xA;&#xA;&#xA;INSERT INTO H_DEBITOS_ORIGEN&#xA;Select id_periodo, nro_cursograma, id_tipo_orden, nro_orden,MAX('')as de_orden_int, id_producto, id_plan_producto, id_acreedor, MAX('P') as id_Tipo_Prestador, MAX(id_usuario_auditor) as id_usuario_auditor, id_prestacion, sum(importe_debito*signo_debito_credito) as importe_debito_Administrativo_Acreedor, MAX(0) as importe_debito_Administrativo_Cliente , MAX(0) as importe_debito_Medico_Acreedor, MAX(0) as importe_debito_Medico_Cliente, MAX(0) as importe_debito_Tecnico_Acreedor, MAX(0) as importe_debito_Tecnico_Cliente&#xA;FROM H_DEBITOS&#xA;WHERE id_origen_debito = 'A' and id_destinatario_debito = 'A' and id_periodo = @Periodo&#xA;GROUP BY id_periodo, nro_cursograma, id_tipo_orden, nro_orden, id_producto, id_plan_producto, id_acreedor, id_prestacion&#xA;&#xA;&#xA;INSERT INTO H_DEBITOS_ORIGEN&#xA;Select id_periodo, nro_cursograma, id_tipo_orden, nro_orden,MAX('')as de_orden_int, id_producto, id_plan_producto, id_acreedor, MAX('P') as id_Tipo_Prestador, MAX(id_usuario_auditor) as id_usuario_auditor, id_prestacion, MAX(0) as importe_debito_Administrativo_Acreedor, sum(importe_debito*signo_debito_credito) as importe_debito_Administrativo_Cliente , MAX(0) as importe_debito_Medico_Acreedor, MAX(0) as importe_debito_Medico_Cliente, MAX(0) as importe_debito_Tecnico_Acreedor, MAX(0) as importe_debito_Tecnico_Cliente&#xA;FROM H_DEBITOS&#xA;WHERE id_origen_debito = 'A' and id_destinatario_debito = 'C' and id_periodo = @Periodo&#xA;GROUP BY id_periodo, nro_cursograma, id_tipo_orden, nro_orden, id_producto, id_plan_producto, id_acreedor, id_prestacion&#xA;&#xA;INSERT INTO H_DEBITOS_ORIGEN&#xA;Select id_periodo, nro_cursograma, id_tipo_orden, nro_orden,MAX('')as de_orden_int, id_producto, id_plan_producto, id_acreedor, MAX('P') as id_Tipo_Prestador, MAX(id_usuario_auditor) as id_usuario_auditor, id_prestacion, MAX(0) as importe_debito_Administrativo_Acreedor, MAX(0) as importe_debito_Administrativo_Cliente , sum(importe_debito*signo_debito_credito) as importe_debito_Medico_Acreedor, MAX(0) as importe_debito_Medico_Cliente, MAX(0) as importe_debito_Tecnico_Acreedor, MAX(0) as importe_debito_Tecnico_Cliente&#xA;FROM H_DEBITOS&#xA;WHERE id_origen_debito = 'M' and id_destinatario_debito = 'A' and id_periodo = @Periodo&#xA;GROUP BY id_periodo, nro_cursograma, id_tipo_orden, nro_orden, id_producto, id_plan_producto, id_acreedor, id_prestacion&#xA;&#xA;INSERT INTO H_DEBITOS_ORIGEN&#xA;Select id_periodo, nro_cursograma, id_tipo_orden, nro_orden,MAX('')as de_orden_int, id_producto, id_plan_producto, id_acreedor, MAX('P') as id_Tipo_Prestador, MAX(id_usuario_auditor) as id_usuario_auditor, id_prestacion, MAX(0) as importe_debito_Administrativo_Acreedor, MAX(0) as importe_debito_Administrativo_Cliente , MAX(0) as importe_debito_Medico_Acreedor, sum(importe_debito*signo_debito_credito) as importe_debito_Medico_Cliente, MAX(0) as importe_debito_Tecnico_Acreedor, MAX(0) as importe_debito_Tecnico_Cliente&#xA;FROM H_DEBITOS&#xA;WHERE id_origen_debito = 'M' and id_destinatario_debito = 'C' and id_periodo = @Periodo&#xA;GROUP BY id_periodo, nro_cursograma, id_tipo_orden, nro_orden, id_producto, id_plan_producto, id_acreedor, id_prestacion&#xA;&#xA;INSERT INTO H_DEBITOS_ORIGEN&#xA;Select id_periodo, nro_cursograma, id_tipo_orden, nro_orden,MAX('')as de_orden_int, id_producto, id_plan_producto, id_acreedor, MAX('P') as id_Tipo_Prestador, MAX(id_usuario_auditor) as id_usuario_auditor, id_prestacion, MAX(0) as importe_debito_Administrativo_Acreedor, MAX(0) as importe_debito_Administrativo_Cliente , MAX(0) as importe_debito_Medico_Acreedor, MAX(0) as importe_debito_Medico_Cliente, sum(importe_debito*signo_debito_credito) as importe_debito_Tecnico_Acreedor, MAX(0) as importe_debito_Tecnico_Cliente&#xA;FROM H_DEBITOS&#xA;WHERE id_origen_debito = 'T' and id_destinatario_debito = 'A' and id_periodo = @Periodo&#xA;GROUP BY id_periodo, nro_cursograma, id_tipo_orden, nro_orden, id_producto, id_plan_producto, id_acreedor, id_prestacion&#xA;&#xA;INSERT INTO H_DEBITOS_ORIGEN&#xA;Select id_periodo, nro_cursograma, id_tipo_orden, nro_orden,MAX('')as de_orden_int, id_producto, id_plan_producto, id_acreedor, MAX('P') as id_Tipo_Prestador, MAX(id_usuario_auditor) as id_usuario_auditor, id_prestacion, MAX(0) as importe_debito_Administrativo_Acreedor, MAX(0) as importe_debito_Administrativo_Cliente , MAX(0) as importe_debito_Medico_Acreedor, MAX(0) as importe_debito_Medico_Cliente, MAX(0) as importe_debito_Tecnico_Acreedor, sum(importe_debito*signo_debito_credito) as importe_debito_Tecnico_Cliente&#xA;FROM H_DEBITOS&#xA;WHERE id_origen_debito = 'T' and id_destinatario_debito = 'C' and id_periodo = @Periodo&#xA;GROUP BY id_periodo, nro_cursograma, id_tipo_orden, nro_orden, id_producto, id_plan_producto, id_acreedor, id_prestacion&#xA;" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\Actualiza H_INTERNACIONES_CONSUMOS"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Tablero Internaciones (H_INTERNACIONES_CONSUMOS)"
      DTS:DTSID="{7ACCD600-D826-4118-9669-EEFC9A6D7809}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Actualiza H_INTERNACIONES_CONSUMOS"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server v9; © 2004 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{648C4EFB-6DA8-4251-892C-D04DC00A04C0}"
          SQLTask:SqlStatementSource="-- Historial de cambios&#xA;-- AQ 11.12.2019&#xA;-- se ajusta ETL para contemplar actualizar nuevo campo 'vigente_internaciones' en D_PERIODO cuando cambia el trimestre&#xA;-- luego, en MSTR se generan filtros a partir de este campo porque estos filtros tienen sql embebido &#xA;-- AQ 12.12.2019&#xA;-- se agrega nuevo campo id_periodo_anual_internaciones en D_PERIODO y el código para contemplarlo&#xA; &#xA;SET DATEFORMAT 'YMD'&#xA;&#xA;-- declara periodos&#xA;DECLARE @Ult_MES_Consumo CHAR(6)&#xA;SET @Ult_MES_Consumo = (select MAX(SubString(CAST(id_periodo as CHAR(6)),5,2)) &#xA;from DW_SALUD.dbo.H_ORD_INT_DET &#xA;where SubString(CAST(id_periodo as CHAR(6)),1,4) in (select MAX(id_anio) &#xA;from DW_SALUD.DBO.D_PERIODO where vigente_consumo = 1))&#xA; &#xA; &#xA;-- Controla con el maximo periodo de ambulatorio.&#xA;If @Ult_MES_Consumo in &#xA;(select distinct SubString(CAST(id_periodo as CHAR(6)),5,2) from DW_SALUD.DBO.H_ORD_INT_DET  &#xA;where SubString(CAST(id_periodo as CHAR(6)),5,2) in ('01','04','07','10') and &#xA;SubString(CAST(id_periodo as CHAR(6)),1,4) in (Select MAX(id_anio) from DW_SALUD.DBO.D_PERIODO &#xA;where vigente_consumo = 1))&#xA;&#xA;begin&#xA;&#xA; -- PRINT N'Trimetre Cambia';&#xA;&#xA;&#x9;&#x9;/* Calcula el último periodo trimestre de internaciones consumos DATETIME */ &#xA;&#x9;&#x9;DECLARE @Ult_Periodo_Consumo_DATE Datetime SET @Ult_Periodo_Consumo_DATE = (select MAX(SubString(CAST(id_trimestre_internaciones as CHAR(6)),1,4)+SubString(CAST(id_trimestre_internaciones as CHAR(6)),5,2)+'01') from H_INTERNACIONES_CONSUMOS)&#xA;&#x9;&#x9;/* Calcula Tres Periodos posteriores a @Ult_Periodo_Consumo_DATE */ &#xA;&#x9;&#x9;DECLARE @Trimestre_Cambia_DATE datetime SET @Trimestre_Cambia_DATE = DATEADD(month,3,@Ult_Periodo_Consumo_DATE)&#xA;&#x9;&#x9;/* Convierte @Ult_Periodo_Consumo_DATE en CHAR */ &#xA;&#xA;&#x9;&#x9;DECLARE @Trimestre_Cambia CHAR(6) SET @Trimestre_Cambia = &#xA;&#x9;&#x9;(CAST(DatePart(year, @Trimestre_Cambia_DATE) as CHAR(4))+Replace((case when CAST(DatePart(month, @Trimestre_Cambia_DATE) as CHAR(2)) &lt; 10 then '0'+CAST(DatePart(month, @Trimestre_Cambia_DATE) as CHAR(2)) else CAST(DatePart(month, @Trimestre_Cambia_DATE) as CHAR(2)) end),' ',''))&#xA;&#xA;&#xA;&#x9;&#x9;/*Calcula rangos de internaciones Desde */ DECLARE @Periodo_Int_Desde CHAR(6) SET @Periodo_Int_Desde = (select MIN(id_periodo) from D_PERIODO where id_periodo in (select top 11 id_periodo from D_PERIODO where id_periodo &lt; @Trimestre_Cambia order by id_periodo desc))&#xA;&#x9;&#x9;/*Calcula rangos de internaciones Hasta */ DECLARE @Periodo_Int_Hasta CHAR(6) SET @Periodo_Int_Hasta = @Trimestre_Cambia&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;delete from H_internaciones_consumos where id_trimestre_internaciones = @Trimestre_Cambia&#xA;&#xA;&#xA;-- Genero una temporal para sacar las internaciones que estuvieron vigentes en los 12 meses de F6 que se miran&#xA;select id_orden_int, max(de_orden_int) de_orden_int,  max(id_tipo_internacion) id_tipo_internacion&#xA;into #paso01 from dw_salud.dbo.H_INTERNACIONES where id_periodo &gt;= @Periodo_Int_Desde and id_periodo &lt;= @Periodo_Int_Hasta&#xA;and id_estado_aut_orden in (3, 4)&#xA;group by id_orden_int&#xA;&#x9;&#x9;Insert into H_internaciones_consumos  &#xA;&#x9;&#x9;([id_trimestre_internaciones], &#xA;&#x9;&#x9;[id_periodo], &#xA;&#x9;&#x9;[id_orden_int], [de_orden_int], [id_periodo_consumo], [afiliado], [subnumero], &#xA;&#x9;&#x9;[secuencia], [id_persona], [id_producto], [id_subproducto], [id_plan_producto], &#xA;&#x9;&#x9;[id_rubro_salud], [id_plan_agrupado_SS], [edad_orden], [id_tipo_internacion], &#xA;&#x9;&#x9;[fecha_internacion], &#xA;&#x9;&#x9;[dias_aut_int],  &#xA;&#x9;&#x9;[id_estado_aut_orden],&#xA;&#x9;&#x9;[id_prof_prescr], [id_profesional], [id_no_facturador], &#xA;&#x9;&#x9;[id_posicion_estab_asist], &#xA;&#x9;&#x9;[id_tipo_profesional_preescribiente], &#xA;&#x9;&#x9;[id_tipo_Prestador], [id_prestacion], [cant_prest_acep], [imp_prest_pag])&#xA;&#x9;&#xA;&#x9;&#x9;select&#x9;MAX(@Trimestre_Cambia) as id_trimestre_internaciones,&#xA;&#x9;&#x9;&#x9;999999&#x9;id_periodo,&#xA;&#x9;&#x9;&#x9;I.id_orden_int  id_orden_int,&#xA;&#x9;&#x9;&#x9;MAX(I.De_Orden_Int) de_orden_int,&#xA;&#x9;&#x9;&#x9;a11.id_periodo  id_periodo_consumo,&#xA;&#x9;&#x9;&#x9;a11.afiliado afiliado,&#xA;&#x9;&#x9;&#x9;a11.subnumero subnumero,&#xA;&#x9;&#x9;&#x9;a11.secuencia secuencia,&#xA;&#x9;&#x9;&#x9;a11.id_persona  id_persona,&#xA;&#x9;&#x9;&#x9;a11.id_producto id_producto,&#xA;&#x9;&#x9;&#x9;a11.id_subproducto id_subproducto,&#xA;&#x9;&#x9;&#x9;a11.id_plan_producto id_plan_producto,&#xA;&#x9;&#x9;&#x9;Isnull(a12.id_rubro_salud,'A') id_rubro_salud,&#xA;&#x9;&#x9;&#x9;a13.id_plan_agrupado_S  id_plan_agrupado_S,&#xA;&#x9;&#x9;&#x9;a11.edad_orden edad_orden,&#xA;&#x9;&#x9;&#x9;I.id_tipo_internacion  id_tipo_internacion,&#xA;&#x9;&#x9;&#x9;'9999-01-01' fecha_internacion, &#xA;&#x9;&#x9;&#x9;SUM(0) dias_aut_int,&#xA;&#x9;&#x9;&#x9;9  id_estado_aut_orden,&#xA;&#x9;&#x9;&#x9;a11.id_prof_prescr id_prof_prescr, &#xA;&#x9;&#x9;&#x9;a11.id_profesional id_profesional,&#xA;&#x9;&#x9;&#x9;a11.id_no_facturador id_no_facturador, &#xA;&#x9;&#x9;&#x9;999 id_posicion_estab_asist, &#xA;&#x9;&#x9;&#x9;a11.id_tipo_profesional_preescribiente id_tipo_profesional_preescribiente,&#xA;&#x9;&#x9;&#x9;MAX('P') as Id_Tipo_Prestador,&#xA;&#x9;&#x9;&#x9;a11.id_prestacion  id_prestacion,&#xA;&#x9;&#x9;&#x9;sum(a11.cant_prest_int_acep)  cant_prest_acep,&#xA;&#x9;&#x9;&#x9;sum(a11.imp_prest_int_pag)  imp_prest_pag&#xA;&#x9;&#x9;from&#x9;#paso01 I &#xA;&#x9;&#x9;INNER JOIN  Dw_salud.dbo.H_ORD_INT_DET a11&#xA;&#x9;&#x9;&#x9;  on &#x9;(I.id_orden_int = a11.id_orden_relacionada &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;and a11.id_tipo_orden_relacionada = 6&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;--and a11.id_tipo_internacion not in ('X', '1C', '8C')&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;join&#x9;dw_salud.dbo.D_PLANES&#x9;a12&#xA;&#x9;&#x9;&#x9;  on &#x9;(a11.id_plan_producto = a12.id_plan_producto and &#xA;&#x9;&#x9;&#x9;a11.id_producto = a12.id_producto)&#xA;&#x9;&#x9;&#x9;join&#x9;dw_salud.dbo.D_PLANES_AGRUPADOS&#x9;a13&#xA;&#x9;&#x9;&#x9;  on &#x9;(a12.id_plan_agrupado = a13.id_plan_agrupado)&#xA;&#x9;&#x9; &#x9;join&#x9;dw_salud.dbo.D_PRODUCTOS&#x9;a14&#xA;&#x9;&#x9;&#x9;  on &#x9;(a11.id_producto = a14.id_producto)&#xA;&#x9;&#x9;where&#x9;(a14.id_clase_producto in ('S ')&#xA;&#x9;&#x9; and a14.id_segmento not in (3)&#xA;&#x9;&#x9; and not ((a11.id_producto = 16 and a11.id_plan_producto = 'CC   ')&#xA;&#x9;&#x9;   or  (a11.id_producto=16 and a11.id_plan_producto='CM   ')&#xA;&#x9;&#x9;   or  (a11.id_producto=16 and a11.id_plan_producto='CS1  ')&#xA;&#x9;&#x9;   or  (a11.id_producto=16 and a11.id_plan_producto='CS100')&#xA;&#x9;&#x9;   or  (a11.id_producto=4 and a11.id_plan_producto='M    ')&#xA;&#x9;&#x9;   or  (a11.id_producto=16 and a11.id_plan_producto='M    ')&#xA;&#x9;&#x9;   or  (a11.id_producto=20 and a11.id_plan_producto='M    ')&#xA;&#x9;&#x9;   or  (a11.id_producto=14 and a11.id_plan_producto='Z    ')&#xA;&#x9;&#x9;   or  (a11.id_producto=20 and a11.id_plan_producto='Z    '))&#xA;&#x9;&#x9;   or  (a11.id_producto=1 and a11.id_plan_producto='C    ')&#xA;&#x9;&#x9;   or  (a11.id_producto=4 and a11.id_plan_producto='PMO  ')&#xA;&#x9;&#x9;   or  (a11.id_producto=35 and a11.id_plan_producto='PMO  '))&#xA;&#x9;&#x9;group by &#xA;&#x9;&#x9;&#x9;a11.id_periodo, &#xA;&#x9;&#x9;&#x9;I.id_orden_int,&#xA;&#x9;&#x9;&#x9;a11.id_periodo,&#xA;&#x9;&#x9;&#x9;a11.afiliado,&#xA;&#x9;&#x9;&#x9;a11.subnumero,&#xA;&#x9;&#x9;&#x9;a11.secuencia,&#xA;&#x9;&#x9;&#x9;a11.id_persona,&#xA;&#x9;&#x9;&#x9;a11.id_producto,&#xA;&#x9;&#x9;&#x9;a11.id_subproducto,&#xA;&#x9;&#x9;&#x9;a11.id_plan_producto,&#xA;&#x9;&#x9;&#x9;Isnull(a12.id_rubro_salud,'A'),&#xA;&#x9;&#x9;&#x9;a13.id_plan_agrupado_S,&#xA;&#x9;&#x9;&#x9;a11.edad_orden,&#xA;&#x9;&#x9;&#x9;I.id_tipo_internacion,&#xA;&#x9;&#x9;&#x9;fecha_internacion, &#xA;&#x9;&#x9;&#x9;a11.id_prof_prescr, &#xA;&#x9;&#x9;&#x9;a11.id_profesional,&#xA;&#x9;&#x9;&#x9;a11.id_no_facturador, &#xA;&#x9;&#x9;&#x9;a11.id_tipo_profesional_preescribiente,&#xA;&#x9;&#x9;&#x9;a11.id_prestacion&#xA;&#x9;&#xA;&#x9;&#xA;&#x9;&#xA;&#x9;-- Actualizaciones dastos h_internaciones_consumos&#xA;&#x9;&#x9;Update H_internaciones_consumos &#xA;&#x9;&#x9;SET dias_aut_int = (select sum(dias_aut_int) &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;from H_INTERNACIONES where id_orden_int = hi.id_orden_int&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;and id_periodo &gt;= @Periodo_Int_Desde &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;and id_periodo &lt;= @Periodo_Int_Hasta) &#xA;&#x9;&#x9;FROM H_internaciones_consumos HI&#xA;&#x9;&#x9;INNER JOIN DW_SALUD.DBO.H_INTERNACIONES I ON HI.id_orden_int = I.id_orden_int &#xA;&#x9;&#x9;WHERE HI.id_trimestre_internaciones = @Trimestre_Cambia &#xA;&#x9;&#x9;&#x9;&#x9; &#xA;&#x9;&#x9;Update H_internaciones_consumos SET dias_aut_int = (I1.dias_aut_int / Internaciones.Cantidad)&#xA;&#x9;&#x9;FROM H_internaciones_consumos I1&#xA;&#x9;&#x9;INNER JOIN (Select I2.id_orden_int id_orden_int, count(*) Cantidad from H_internaciones_consumos I2 where &#xA;&#x9;&#x9;I2.id_trimestre_internaciones = @Trimestre_Cambia &#xA;&#x9;&#x9;group by I2.id_orden_int) Internaciones ON I1.id_orden_int = Internaciones.id_orden_int&#xA;&#x9;&#x9;WHERE I1.id_trimestre_internaciones = @Trimestre_Cambia&#xA;&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;-- Cant personas&#xA;&#x9;&#x9;Update H_internaciones_consumos SET cant_personas = Internaciones.Cantidad&#xA;&#x9;&#x9;FROM H_internaciones_consumos I1&#xA;&#x9;&#x9;INNER JOIN (Select I2.id_persona id_persona, &#xA;&#x9;&#x9;count(*) Cantidad from H_internaciones_consumos I2 where I2.id_trimestre_internaciones = @Trimestre_Cambia &#xA;&#x9;&#x9;group by I2.id_persona) Internaciones ON I1.id_persona = Internaciones.id_persona&#xA;&#x9;&#x9;WHERE I1.id_trimestre_internaciones = @Trimestre_Cambia&#xA;&#xA;&#x9;&#x9;update h_internaciones_consumos set cant_personas = 1/Cant_personas&#xA;&#x9;&#x9;WHERE id_trimestre_internaciones = @Trimestre_Cambia&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;-- Cant internaciones&#xA;&#x9;&#x9;Update H_internaciones_consumos SET cant_internaciones = Internaciones.Cantidad&#xA;&#x9;&#x9;FROM H_internaciones_consumos I1 &#xA;&#x9;&#x9;INNER JOIN (Select I2.id_orden_int id_orden_int, count(*) &#xA;&#x9;&#x9;Cantidad from H_internaciones_consumos I2 where I2.id_trimestre_internaciones = @Trimestre_Cambia &#xA;&#x9;&#x9;group by I2.id_orden_int) Internaciones ON I1.id_orden_int = Internaciones.id_orden_int&#xA;&#x9;&#x9;WHERE I1.id_trimestre_internaciones = @Trimestre_Cambia&#xA;&#xA;&#x9;&#x9;update h_internaciones_consumos set cant_internaciones = 1/cant_internaciones&#xA;&#x9;&#x9;WHERE id_trimestre_internaciones = @Trimestre_Cambia&#xA;&#x9;&#xA;&#x9;&#xA;&#x9;-- Completa campos no contemplados en #Paso01&#xA;&#x9;&#x9;-- periodo &#xA;&#x9;&#x9;Update H_internaciones_consumos SET id_periodo = &#xA;&#x9;&#x9;&#x9;&#x9;(select min(id_periodo) from H_INTERNACIONES where id_orden_int = hi.id_orden_int&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;and id_periodo &gt;= @Periodo_Int_Desde &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;and id_periodo &lt;= @Periodo_Int_Hasta)&#xA;&#x9;&#x9;FROM H_internaciones_consumos HI&#xA;&#x9;&#x9;INNER join DW_SALUD.DBO.H_INTERNACIONES I ON HI.id_orden_int = I.id_orden_int&#xA;&#x9;&#x9;WHERE HI.id_trimestre_internaciones = @Trimestre_Cambia&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;-- fecha internacion&#xA;&#x9;&#x9;Update H_internaciones_consumos SET fecha_internacion = I.fecha_internacion&#xA;&#x9;&#x9;FROM H_internaciones_consumos HI&#xA;&#x9;&#x9;INNER JOIN DW_SALUD.DBO.H_INTERNACIONES I ON HI.id_orden_int = I.id_orden_int&#xA;&#x9;&#x9;WHERE HI.id_trimestre_internaciones = @Trimestre_Cambia&#xA;&#xA;&#x9;&#x9;-- estado aut orden&#xA;&#x9;&#x9;Update H_internaciones_consumos SET id_estado_aut_orden = I.id_estado_aut_orden&#xA;&#x9;&#x9;FROM H_internaciones_consumos HI&#xA;&#x9;&#x9;INNER JOIN DW_SALUD.DBO.H_INTERNACIONES I ON HI.id_orden_int = I.id_orden_int&#xA;&#x9;&#x9;WHERE HI.id_trimestre_internaciones = @Trimestre_Cambia&#xA;&#xA;&#x9;&#x9;-- posicion estab asist&#xA;&#x9;&#x9;Update H_internaciones_consumos SET id_posicion_estab_asist = I.id_posicion_estab_asist&#xA;&#x9;&#x9;FROM H_internaciones_consumos HI&#xA;&#x9;&#x9;INNER JOIN DW_SALUD.DBO.H_INTERNACIONES I ON HI.id_orden_int = I.id_orden_int&#xA;&#x9;&#x9;WHERE HI.id_trimestre_internaciones = @Trimestre_Cambia&#xA;&#x9;&#x9;&#x9;&#x9;&#xA;&#xA;&#xA;&#x9; -- AQ 11.12.2019 - Actualización D_PERIODO vigente_internaciones&#xA;&#x9; update d_periodo&#xA;&#x9; set vigente_internaciones = '1' where id_periodo in(@Periodo_Int_Hasta, @Periodo_Int_Hasta-1, @Periodo_Int_Hasta-2)&#xA;&#x9; &#xA;&#x9; /* AQ 12.12.2019 - Actualiza id_periodo_anual_internaciones en D_PERIODO  */&#xA;&#x9;UPDATE D_PERIODO set id_periodo_anual_internaciones = 0&#xA;&#xA;&#x9;&#x9;UPDATE D_PERIODO set id_periodo_anual_internaciones = 1 -- 25 a 36 M&#xA;&#x9;&#x9;WHERE id_periodo in (select top 36 id_periodo from D_PERIODO where vigente_internaciones = 1 order by id_periodo desc)&#xA;&#xA;&#x9;&#x9;UPDATE D_PERIODO set id_periodo_anual_internaciones = 2 -- 13 a 24 M &#xA;&#x9;&#x9;WHERE id_periodo in (select top 24 id_periodo from D_PERIODO where vigente_internaciones = 1 order by id_periodo desc)&#xA;&#xA;&#x9;&#x9;UPDATE D_PERIODO set id_periodo_anual_internaciones = 3 -- U12M&#xA;&#x9;&#x9;WHERE id_periodo in (select top 12 id_periodo from D_PERIODO where vigente_internaciones = 1 order by id_periodo desc)&#xA;&#xA;&#x9; &#xA;&#x9;drop table #paso01&#xA;&#xA;&#x9;end&#xA;&#xA;else&#xA;&#xA;begin&#xA;&#x9;&#xA;&#x9; -- PRINT N'  Trimetre NO Cambia';&#xA;&#xA;&#x9;&#x9;/* Calcula Ultimo Periodo Internaciones Consumos */ &#xA;&#x9;&#x9;DECLARE @Trimestre_NO_Cambia INT SET @Trimestre_NO_Cambia = &#xA;&#x9;&#x9;(select MAX(id_trimestre_internaciones) from H_INTERNACIONES_CONSUMOS)&#xA;&#x9;&#x9;/*Calcula rangos de internaciones Desde */ &#xA;&#x9;&#x9;DECLARE @Periodo_Int_Desde_NC CHAR(6) SET @Periodo_Int_Desde_NC = (select MIN(id_periodo) from D_PERIODO where id_periodo in (select top 11 id_periodo from D_PERIODO where id_periodo &lt; @Trimestre_NO_Cambia order by id_periodo desc))&#xA;&#x9;&#x9;/*Calcula rangos de internaciones Hasta */ &#xA;&#x9;&#x9;DECLARE @Periodo_Int_Hasta_NC CHAR(6) SET @Periodo_Int_Hasta_NC = @Trimestre_NO_Cambia&#xA;&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;delete from H_internaciones_consumos where id_trimestre_internaciones = @Trimestre_NO_Cambia&#xA;&#x9;&#x9;&#xA;-- Genero una temporal para sacar las internaciones que estuvieron vigentes en los 12 meses de F6 que se miran&#xA;select id_orden_int, max(de_orden_int) de_orden_int,  max(id_tipo_internacion) id_tipo_internacion&#xA;into #paso02 from dw_salud.dbo.H_INTERNACIONES where id_periodo &gt;= @Periodo_Int_Desde_NC and id_periodo &lt;= @Periodo_Int_Hasta_NC&#xA;and id_estado_aut_orden in (3, 4)&#xA;group by id_orden_int&#xA;&#x9;&#x9;Insert into H_internaciones_consumos  &#xA;&#x9;&#x9;([id_trimestre_internaciones], &#xA;&#x9;&#x9;[id_periodo], &#xA;&#x9;&#x9;[id_orden_int], [de_orden_int], [id_periodo_consumo], [afiliado], [subnumero], &#xA;&#x9;&#x9;[secuencia], [id_persona], [id_producto], [id_subproducto], [id_plan_producto], &#xA;&#x9;&#x9;[id_rubro_salud], [id_plan_agrupado_SS], [edad_orden], [id_tipo_internacion], &#xA;&#x9;&#x9;[fecha_internacion], &#xA;&#x9;&#x9;[dias_aut_int],  &#xA;&#x9;&#x9;[id_estado_aut_orden],&#xA;&#x9;&#x9;[id_prof_prescr], [id_profesional], [id_no_facturador], &#xA;&#x9;&#x9;[id_posicion_estab_asist], &#xA;&#x9;&#x9;[id_tipo_profesional_preescribiente], &#xA;&#x9;&#x9;[id_tipo_Prestador], [id_prestacion], [cant_prest_acep], [imp_prest_pag])&#xA;&#xA;&#x9;&#x9;select&#x9;MAX(@Trimestre_NO_Cambia) as id_trimestre_internaciones,&#xA;&#x9;&#x9;&#x9;999999&#x9;id_periodo,&#xA;&#x9;&#x9;&#x9;I.id_orden_int  id_orden_int,&#xA;&#x9;&#x9;&#x9;MAX(I.De_Orden_Int) de_orden_int,&#xA;&#x9;&#x9;&#x9;a11.id_periodo  id_periodo_consumo,&#xA;&#x9;&#x9;&#x9;a11.afiliado afiliado,&#xA;&#x9;&#x9;&#x9;a11.subnumero subnumero,&#xA;&#x9;&#x9;&#x9;a11.secuencia secuencia,&#xA;&#x9;&#x9;&#x9;a11.id_persona  id_persona,&#xA;&#x9;&#x9;&#x9;a11.id_producto id_producto,&#xA;&#x9;&#x9;&#x9;a11.id_subproducto id_subproducto,&#xA;&#x9;&#x9;&#x9;a11.id_plan_producto id_plan_producto,&#xA;&#x9;&#x9;&#x9;Isnull(a12.id_rubro_salud,'A') id_rubro_salud,&#xA;&#x9;&#x9;&#x9;a13.id_plan_agrupado_S  id_plan_agrupado_S,&#xA;&#x9;&#x9;&#x9;a11.edad_orden edad_orden,&#xA;&#x9;&#x9;&#x9;I.id_tipo_internacion  id_tipo_internacion,&#xA;&#x9;&#x9;&#x9;'9999-01-01' fecha_internacion, &#xA;&#x9;&#x9;&#x9;SUM(0) dias_aut_int,&#xA;&#x9;&#x9;&#x9;9  id_estado_aut_orden, &#xA;&#x9;&#x9;&#x9;a11.id_prof_prescr id_prof_prescr, &#xA;&#x9;&#x9;&#x9;a11.id_profesional id_profesional,&#xA;&#x9;&#x9;&#x9;a11.id_no_facturador id_no_facturador, &#xA;&#x9;&#x9;&#x9;999 id_posicion_estab_asist, &#xA;&#x9;&#x9;&#x9;a11.id_tipo_profesional_preescribiente id_tipo_profesional_preescribiente,&#xA;&#x9;&#x9;&#x9;MAX('P') as Id_Tipo_Prestador,&#xA;&#x9;&#x9;&#x9;a11.id_prestacion  id_prestacion,&#xA;&#x9;&#x9;&#x9;sum(a11.cant_prest_int_acep)  cant_prest_acep,&#xA;&#x9;&#x9;&#x9;sum(a11.imp_prest_int_pag)  imp_prest_pag&#xA;&#x9;&#x9;from&#x9;#paso02 I &#xA;&#x9;&#x9;  &#x9;INNER JOIN  Dw_salud.dbo.H_ORD_INT_DET a11&#xA;&#x9;&#x9;&#x9;  on &#x9;(I.id_orden_int = a11.id_orden_relacionada &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;and a11.id_tipo_orden_relacionada = 6&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;--and a11.id_tipo_internacion not in ('X', '1C', '8C')&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;join&#x9;dw_salud.dbo.D_PLANES&#x9;a12&#xA;&#x9;&#x9;&#x9;  on &#x9;(a11.id_plan_producto = a12.id_plan_producto and &#xA;&#x9;&#x9;&#x9;a11.id_producto = a12.id_producto)&#xA;&#x9;&#x9;&#x9;join&#x9;dw_salud.dbo.D_PLANES_AGRUPADOS&#x9;a13&#xA;&#x9;&#x9;&#x9;  on &#x9;(a12.id_plan_agrupado = a13.id_plan_agrupado)&#xA;&#x9;&#x9; &#x9;join&#x9;dw_salud.dbo.D_PRODUCTOS&#x9;a14&#xA;&#x9;&#x9;&#x9;  on &#x9;(a11.id_producto = a14.id_producto)&#xA;&#x9;&#x9;where&#x9;(a14.id_clase_producto in ('S ')&#xA;&#x9;&#x9; and a14.id_segmento not in (3)&#xA;&#x9;&#x9; and not ((a11.id_producto = 16 and a11.id_plan_producto = 'CC   ')&#xA;&#x9;&#x9;   or  (a11.id_producto=16 and a11.id_plan_producto='CM   ')&#xA;&#x9;&#x9;   or  (a11.id_producto=16 and a11.id_plan_producto='CS1  ')&#xA;&#x9;&#x9;   or  (a11.id_producto=16 and a11.id_plan_producto='CS100')&#xA;&#x9;&#x9;   or  (a11.id_producto=4 and a11.id_plan_producto='M    ')&#xA;&#x9;&#x9;   or  (a11.id_producto=16 and a11.id_plan_producto='M    ')&#xA;&#x9;&#x9;   or  (a11.id_producto=20 and a11.id_plan_producto='M    ')&#xA;&#x9;&#x9;   or  (a11.id_producto=14 and a11.id_plan_producto='Z    ')&#xA;&#x9;&#x9;   or  (a11.id_producto=20 and a11.id_plan_producto='Z    '))&#xA;&#x9;&#x9;   or  (a11.id_producto=1 and a11.id_plan_producto='C    ')&#xA;&#x9;&#x9;   or  (a11.id_producto=4 and a11.id_plan_producto='PMO  ')&#xA;&#x9;&#x9;   or  (a11.id_producto=35 and a11.id_plan_producto='PMO  '))&#xA;&#x9;&#x9;group by &#xA;&#x9;&#x9;&#x9;id_periodo, &#xA;&#x9;&#x9;&#x9;I.id_orden_int,&#xA;&#x9;&#x9;&#x9;a11.id_periodo,&#xA;&#x9;&#x9;&#x9;a11.afiliado,&#xA;&#x9;&#x9;&#x9;a11.subnumero,&#xA;&#x9;&#x9;&#x9;a11.secuencia,&#xA;&#x9;&#x9;&#x9;a11.id_persona,&#xA;&#x9;&#x9;&#x9;a11.id_producto,&#xA;&#x9;&#x9;&#x9;a11.id_subproducto,&#xA;&#x9;&#x9;&#x9;a11.id_plan_producto,&#xA;&#x9;&#x9;&#x9;Isnull(a12.id_rubro_salud,'A'),&#xA;&#x9;&#x9;&#x9;a13.id_plan_agrupado_S,&#xA;&#x9;&#x9;&#x9;a11.edad_orden,&#xA;&#x9;&#x9;&#x9;I.id_tipo_internacion,&#xA;&#x9;&#x9;&#x9;fecha_internacion, &#xA;&#x9;&#x9;&#x9;a11.id_prof_prescr, &#xA;&#x9;&#x9;&#x9;a11.id_profesional,&#xA;&#x9;&#x9;&#x9;a11.id_no_facturador, &#xA;&#x9;&#x9;&#x9;a11.id_tipo_profesional_preescribiente,&#xA;&#x9;&#x9;&#x9;a11.id_prestacion&#xA;&#x9;&#xA;&#x9;&#xA;&#xA;&#x9;-- Actualizaciones dastos h_internaciones_consumos&#xA;&#x9;&#x9;Update H_internaciones_consumos &#xA;&#x9;&#x9;SET dias_aut_int = (select sum(dias_aut_int) &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;from H_INTERNACIONES where id_orden_int = hi.id_orden_int&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;and id_periodo &gt;= @Periodo_Int_Desde_NC &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;and id_periodo &lt;= @Periodo_Int_Hasta_NC) &#xA;&#x9;&#x9;FROM H_internaciones_consumos HI&#xA;&#x9;&#x9;INNER JOIN DW_SALUD.DBO.H_INTERNACIONES I ON HI.id_orden_int = I.id_orden_int &#xA;&#x9;&#x9;WHERE HI.id_trimestre_internaciones = @Trimestre_NO_Cambia &#xA;&#x9;&#x9;&#x9;&#x9; &#xA;&#x9;&#x9;Update H_internaciones_consumos SET dias_aut_int = (I1.dias_aut_int / Internaciones.Cantidad)&#xA;&#x9;&#x9;FROM H_internaciones_consumos I1&#xA;&#x9;&#x9;INNER JOIN (Select I2.id_orden_int id_orden_int, count(*) Cantidad from H_internaciones_consumos I2 where &#xA;&#x9;&#x9;I2.id_trimestre_internaciones = @Trimestre_NO_Cambia &#xA;&#x9;&#x9;group by I2.id_orden_int) Internaciones ON I1.id_orden_int = Internaciones.id_orden_int&#xA;&#x9;&#x9;WHERE I1.id_trimestre_internaciones = @Trimestre_NO_Cambia&#xA;&#xA;&#xA;&#xA;&#x9;&#x9;-- Cant personas&#xA;&#x9;&#x9;Update H_internaciones_consumos SET cant_personas = Internaciones.Cantidad&#xA;&#x9;&#x9;FROM H_internaciones_consumos I1&#xA;&#x9;&#x9;INNER JOIN (Select I2.id_persona id_persona, count(*) Cantidad from H_internaciones_consumos I2 where I2.id_trimestre_internaciones = @Trimestre_NO_Cambia &#xA;&#x9;&#x9;group by I2.id_persona) Internaciones ON I1.id_persona = Internaciones.id_persona&#xA;&#x9;&#x9;WHERE I1.id_trimestre_internaciones = @Trimestre_NO_Cambia&#xA;&#xA;&#x9;&#x9;update h_internaciones_consumos set cant_personas = 1/Cant_personas&#xA;&#x9;&#x9;WHERE id_trimestre_internaciones = @Trimestre_NO_Cambia&#xA;&#xA;&#x9;&#x9;-- Cant internaciones&#xA;&#x9;&#x9;Update H_internaciones_consumos SET cant_internaciones = Internaciones.Cantidad&#xA;&#x9;&#x9;FROM H_internaciones_consumos I1 &#xA;&#x9;&#x9;INNER JOIN (Select I2.id_orden_int id_orden_int, count(*) Cantidad from H_internaciones_consumos I2 where I2.id_trimestre_internaciones = @Trimestre_NO_Cambia &#xA;&#x9;&#x9;group by I2.id_orden_int) Internaciones ON I1.id_orden_int = Internaciones.id_orden_int&#xA;&#x9;&#x9;WHERE I1.id_trimestre_internaciones = @Trimestre_NO_Cambia&#xA;&#xA;&#x9;&#x9;update h_internaciones_consumos set cant_internaciones = 1/cant_internaciones&#xA;&#x9;&#x9;WHERE id_trimestre_internaciones = @Trimestre_NO_Cambia&#xA;&#x9;&#xA;&#x9;&#xA;--&#x9;-- Completa campos no contemplados en #paso02&#xA;--&#x9;&#x9;-- periodo &#xA;&#x9;&#x9;Update H_internaciones_consumos SET id_periodo = &#xA;&#x9;&#x9;&#x9;&#x9;(select min(id_periodo) from H_INTERNACIONES where id_orden_int = hi.id_orden_int&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;and id_periodo &gt;= @Periodo_Int_Desde_NC &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;and id_periodo &lt;= @Periodo_Int_Hasta_NC)&#xA;&#x9;&#x9;FROM H_internaciones_consumos HI&#xA;&#x9;&#x9;INNER join DW_SALUD.DBO.H_INTERNACIONES I ON HI.id_orden_int = I.id_orden_int&#xA;&#x9;&#x9;WHERE HI.id_trimestre_internaciones = @Trimestre_NO_Cambia&#xA;&#x9;&#x9;&#xA;&#xA;&#x9;&#x9;-- fecha internacion&#xA;&#x9;&#x9;Update H_internaciones_consumos SET fecha_internacion = I.fecha_internacion&#xA;&#x9;&#x9;FROM H_internaciones_consumos HI&#xA;&#x9;&#x9;INNER JOIN DW_SALUD.DBO.H_INTERNACIONES I ON HI.id_orden_int = I.id_orden_int&#xA;&#x9;&#x9;WHERE HI.id_trimestre_internaciones = @Trimestre_NO_Cambia&#xA;&#xA;&#x9;&#x9;-- estadi aut orden&#xA;&#x9;&#x9;Update H_internaciones_consumos SET id_estado_aut_orden = I.id_estado_aut_orden&#xA;&#x9;&#x9;FROM H_internaciones_consumos HI&#xA;&#x9;&#x9;INNER JOIN DW_SALUD.DBO.H_INTERNACIONES I ON HI.id_orden_int = I.id_orden_int&#xA;&#x9;&#x9;WHERE HI.id_trimestre_internaciones = @Trimestre_NO_Cambia&#xA;&#xA;&#x9;&#x9;-- posicion estab asist&#xA;&#x9;&#x9;Update H_internaciones_consumos SET id_posicion_estab_asist = I.id_posicion_estab_asist&#xA;&#x9;&#x9;FROM H_internaciones_consumos HI&#xA;&#x9;&#x9;INNER JOIN DW_SALUD.DBO.H_INTERNACIONES I ON HI.id_orden_int = I.id_orden_int&#xA;&#x9;&#x9;WHERE HI.id_trimestre_internaciones = @Trimestre_NO_Cambia&#xA;&#xA;&#x9;&#x9;drop table #paso02&#xA;&#x9;&#x9;&#xA;END&#xA;" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\Actualiza H_INTERNACIONES_DEBITOS"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Actualiza H_INTERNACIONES_DEBITOS"
      DTS:DTSID="{A42B15DA-17EC-45DD-9C20-4479EF025489}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Actualiza H_INTERNACIONES_DEBITOS"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server v9; © 2004 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{648C4EFB-6DA8-4251-892C-D04DC00A04C0}"
          SQLTask:SqlStatementSource="SET DATEFORMAT 'YMD'&#xA;&#xA;-- declara periodos&#xA;DECLARE @Ult_MES_Consumo CHAR(6)&#xA;SET @Ult_MES_Consumo = (select MAX(SubString(CAST(id_periodo as CHAR(6)),5,2)) from H_ORD_INT_DET where SubString(CAST(id_periodo as CHAR(6)),1,4) in (select MAX(id_anio) from D_PERIODO where vigente_consumo = 1))&#xA;&#xA;-- Controla con el maximo periodo de ambulatorio.&#xA;If @Ult_MES_Consumo in (select distinct SubString(CAST(id_periodo as CHAR(6)),5,2) from H_ORD_INT_DET where SubString(CAST(id_periodo as CHAR(6)),5,2) in ('01','04','07','10') and SubString(CAST(id_periodo as CHAR(6)),1,4) in (Select MAX(id_anio) from D_PERIODO where vigente_consumo = 1))&#xA;&#xA;&#x9;begin&#xA;&#x9;&#x9;/* Calcula el último periodo trimestre de internaciones consumos DATETIME */ DECLARE @Ult_Periodo_Consumo_DATE Datetime SET @Ult_Periodo_Consumo_DATE = (select MAX(SubString(CAST(id_trimestre_internaciones as CHAR(6)),1,4)+SubString(CAST(id_trimestre_internaciones as CHAR(6)),5,2)+'01') from H_INTERNACIONES_DEBITOS)&#xA;&#x9;&#x9;/* Calcula Tres Periodos posteriores a @Ult_Periodo_Consumo_DATE */ DECLARE @Trimestre_Cambia_DATE datetime SET @Trimestre_Cambia_DATE = DATEADD(month,3,@Ult_Periodo_Consumo_DATE)&#xA;&#x9;&#x9;/* Convierte @Ult_Periodo_Consumo_DATE en CHAR */ DECLARE @Trimestre_Cambia CHAR(6) SET @Trimestre_Cambia = (CAST(DatePart(year, @Trimestre_Cambia_DATE) as CHAR(4))+Replace((case when CAST(DatePart(month, @Trimestre_Cambia_DATE) as CHAR(2)) &lt; 10 then '0'+CAST(DatePart(month, @Trimestre_Cambia_DATE) as CHAR(2)) else CAST(DatePart(month, @Trimestre_Cambia_DATE) as CHAR(2)) end),' ',''))&#xA;&#xA;&#x9;&#x9;/*Calcula rangos de internaciones Desde */ DECLARE @Periodo_Int_Desde CHAR(6) SET @Periodo_Int_Desde = (select MIN(id_periodo) from D_PERIODO where id_periodo in (select top 11 id_periodo from D_PERIODO where id_periodo &lt; @Trimestre_Cambia order by id_periodo desc))&#xA;&#x9;&#x9;/*Calcula rangos de internaciones Hasta */ DECLARE @Periodo_Int_Hasta CHAR(6) SET @Periodo_Int_Hasta = @Trimestre_Cambia&#xA;&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;DELETE FROM [DW_Salud].[dbo].[H_INTERNACIONES_DEBITOS] WHERE id_trimestre_internaciones = @Trimestre_Cambia&#xA;&#xA;&#x9;&#x9;INSERT INTO [DW_Salud].[dbo].[H_INTERNACIONES_DEBITOS]&#xA;&#x9;&#x9;SELECT MAX(@Trimestre_Cambia) as id_trimestre_internaciones, I.id_periodo, I.id_orden_int, MAX(I.de_orden_int) as de_orden_int, I.afiliado, I.subnumero, I.secuencia, I.id_persona, HD.id_producto, MAX(9999) as id_subproducto, HD.id_plan_producto, Isnull(a12.id_rubro_salud,'A') id_rubro_salud, a13.id_plan_agrupado_S as Id_Plan_Agrupado_SS, I.edad_orden, I.id_tipo_internacion, I.fecha_internacion, I.id_estado_aut_orden, MAX(999999) as id_prof_prescr, MAX(999999) as id_profesional, MAX(999999) as id_no_facturador, I.id_posicion_estab_asist, I.id_posicion_estab_asist as id_posicion_estab_asist_VI, MAX('P') as id_tipo_profesional_preescribiente, I.id_tipo_prestador, HD.id_prestacion, HD.id_usuario_auditor, sum(HD.importe_debito_Administrativo_Acreedor) as importe_debito_Administrativo_Acreedor, sum(HD.importe_debito_Administrativo_Cliente) as importe_debito_Administrativo_Cliente, sum(HD.importe_debito_Medico_Acreedor) as importe_debito_Medico_Acreedor, sum(HD.importe_debito_Medico_Cliente) as importe_debito_Medico_Cliente, sum(HD.importe_debito_Tecnico_Acreedor) as importe_debito_Tecnico_Acreedor, sum(HD.importe_debito_Tecnico_Cliente) as importe_debito_Tecnico_Cliente&#xA;&#x9;&#x9;FROM H_INTERNACIONES I&#xA;&#x9;&#x9;INNER JOIN H_DEBITOS_ORIGEN HD ON (I.id_orden_int = HD.id_orden_int and HD.id_tipo_orden = 6 and (I.id_estado_aut_orden in (3, 4) and I.id_periodo between @Periodo_Int_Desde and @Periodo_Int_Hasta))&#xA;&#x9;&#x9;INNER JOIN D_PLANES&#x9;a12&#xA;&#x9;&#x9;&#x9;  on &#x9;(HD.id_plan_producto = a12.id_plan_producto and HD.id_producto = a12.id_producto)&#xA;&#x9;&#x9;&#x9;join&#x9;D_PLANES_AGRUPADOS&#x9;a13&#xA;&#x9;&#x9;&#x9;  on &#x9;(a12.id_plan_agrupado = a13.id_plan_agrupado)&#xA; &#x9;&#x9;&#x9;join&#x9;D_PRODUCTOS&#x9;a14&#xA;&#x9;&#x9;&#x9;  on &#x9;(HD.id_producto = a14.id_producto)&#xA;&#x9;&#x9;WHERE&#x9;(a14.id_clase_producto in ('S ')&#xA;&#x9;&#x9; and a14.id_segmento not in (3)&#xA;&#x9;&#x9; and not ((HD.id_producto = 16 and HD.id_plan_producto = 'CC   ')&#xA;&#x9;&#x9;   or  (HD.id_producto=16 and HD.id_plan_producto='CM   ')&#xA;&#x9;&#x9;   or  (HD.id_producto=16 and HD.id_plan_producto='CS1  ')&#xA;&#x9;&#x9;   or  (HD.id_producto=16 and HD.id_plan_producto='CS100')&#xA;&#x9;&#x9;   or  (HD.id_producto=4 and HD.id_plan_producto='M    ')&#xA;&#x9;&#x9;   or  (HD.id_producto=16 and HD.id_plan_producto='M    ')&#xA;&#x9;&#x9;   or  (HD.id_producto=20 and HD.id_plan_producto='M    ')&#xA;&#x9;&#x9;   or  (HD.id_producto=14 and HD.id_plan_producto='Z    ')&#xA;&#x9;&#x9;   or  (HD.id_producto=20 and HD.id_plan_producto='Z    '))&#xA;&#x9;&#x9;   or  (HD.id_producto=1 and HD.id_plan_producto='C    ')&#xA;&#x9;&#x9;   or  (HD.id_producto=4 and HD.id_plan_producto='PMO  ')&#xA;&#x9;&#x9;   or  (HD.id_producto=35 and HD.id_plan_producto='PMO  '))&#xA;&#x9;&#x9;GROUP BY I.id_periodo, I.id_orden_int, I.afiliado, I.subnumero, I.secuencia, I.id_persona, HD.id_producto, HD.id_plan_producto,  Isnull(a12.id_rubro_salud,'A'), a13.id_plan_agrupado_S, I.edad_orden, I.id_tipo_internacion, I.fecha_internacion, I.id_estado_aut_orden,I.id_posicion_estab_asist, I.id_posicion_estab_asist, I.id_tipo_prestador, HD.id_prestacion, HD.id_usuario_auditor&#xA;&#xA;&#xA;&#x9;&#x9;UPDATE [DW_Salud].[dbo].[H_INTERNACIONES_DEBITOS] SET id_subproducto = HC.id_subproducto, id_prof_prescr = HC.id_prof_prescr, id_profesional = HC.id_profesional, id_no_facturador = HC.id_no_facturador, id_tipo_profesional_preescribiente = HC.id_tipo_profesional_preescribiente, id_tipo_prestador = HC.id_tipo_prestador&#xA;&#x9;&#x9;FROM [DW_Salud].[dbo].[H_INTERNACIONES_DEBITOS] HD&#xA;&#x9;&#x9;INNER JOIN H_INTERNACIONES_CONSUMOS HC  ON HD.id_orden_int = HC.id_orden_int AND HD.id_prestacion = HC.id_prestacion&#xA;&#x9;&#x9;WHERE HD.id_trimestre_internaciones = @Trimestre_Cambia&#xA;&#x9;&#xA;&#x9;end&#xA;&#x9;&#xA;else&#xA;&#xA;&#x9;begin&#xA;&#x9;&#x9;/* Calcula Ultimo Periodo Internaciones Consumos */ DECLARE @Trimestre_NO_Cambia INT SET @Trimestre_NO_Cambia = (select MAX(id_trimestre_internaciones) from H_INTERNACIONES_DEBITOS)&#xA;&#xA;&#x9;&#x9;/*Calcula rangos de internaciones Desde */ DECLARE @Periodo_Int_Desde_NC CHAR(6) SET @Periodo_Int_Desde_NC = (select MIN(id_periodo) from D_PERIODO where id_periodo in (select top 11 id_periodo from D_PERIODO where id_periodo &lt; @Trimestre_NO_Cambia order by id_periodo desc))&#xA;&#x9;&#x9;/*Calcula rangos de internaciones Hasta */ DECLARE @Periodo_Int_Hasta_NC CHAR(6) SET @Periodo_Int_Hasta_NC = @Trimestre_NO_Cambia&#xA;&#xA;&#x9;&#x9;DELETE FROM [DW_Salud].[dbo].[H_INTERNACIONES_DEBITOS] WHERE id_trimestre_internaciones = @Trimestre_NO_Cambia&#xA;&#xA;&#x9;&#x9;INSERT INTO [DW_Salud].[dbo].[H_INTERNACIONES_DEBITOS]&#xA;&#x9;&#x9;SELECT MAX(@Trimestre_NO_Cambia) as id_trimestre_internaciones, I.id_periodo, I.id_orden_int, MAX(I.de_orden_int) as de_orden_int, I.afiliado, I.subnumero, I.secuencia, I.id_persona, HD.id_producto, MAX(9999) as id_subproducto, HD.id_plan_producto, Isnull(a12.id_rubro_salud,'A') id_rubro_salud, a13.id_plan_agrupado_S as Id_Plan_Agrupado_SS, I.edad_orden, I.id_tipo_internacion, I.fecha_internacion, I.id_estado_aut_orden, MAX(999999) as id_prof_prescr, MAX(999999) as id_profesional, MAX(999999) as id_no_facturador, I.id_posicion_estab_asist, I.id_posicion_estab_asist as id_posicion_estab_asist_VI, MAX('P') as id_tipo_profesional_preescribiente, I.id_tipo_prestador, HD.id_prestacion, HD.id_usuario_auditor, sum(HD.importe_debito_Administrativo_Acreedor) as importe_debito_Administrativo_Acreedor, sum(HD.importe_debito_Administrativo_Cliente) as importe_debito_Administrativo_Cliente, sum(HD.importe_debito_Medico_Acreedor) as importe_debito_Medico_Acreedor, sum(HD.importe_debito_Medico_Cliente) as importe_debito_Medico_Cliente, sum(HD.importe_debito_Tecnico_Acreedor) as importe_debito_Tecnico_Acreedor, sum(HD.importe_debito_Tecnico_Cliente) as importe_debito_Tecnico_Cliente&#xA;&#x9;&#x9;FROM H_INTERNACIONES I&#xA;&#x9;&#x9;INNER JOIN H_DEBITOS_ORIGEN HD ON (I.id_orden_int = HD.id_orden_int and HD.id_tipo_orden = 6 and (I.id_estado_aut_orden in (3, 4) and I.id_periodo between @Periodo_Int_Desde_NC and @Periodo_Int_Hasta_NC))&#xA;&#x9;&#x9;INNER JOIN D_PLANES&#x9;a12&#xA;&#x9;&#x9;&#x9;  on &#x9;(HD.id_plan_producto = a12.id_plan_producto and HD.id_producto = a12.id_producto)&#xA;&#x9;&#x9;&#x9;join&#x9;D_PLANES_AGRUPADOS&#x9;a13&#xA;&#x9;&#x9;&#x9;  on &#x9;(a12.id_plan_agrupado = a13.id_plan_agrupado)&#xA; &#x9;&#x9;&#x9;join&#x9;D_PRODUCTOS&#x9;a14&#xA;&#x9;&#x9;&#x9;  on &#x9;(HD.id_producto = a14.id_producto)&#xA;&#x9;&#x9;WHERE&#x9;(a14.id_clase_producto in ('S ')&#xA;&#x9;&#x9; and a14.id_segmento not in (3)&#xA;&#x9;&#x9; and not ((HD.id_producto = 16 and HD.id_plan_producto = 'CC   ')&#xA;&#x9;&#x9;   or  (HD.id_producto=16 and HD.id_plan_producto='CM   ')&#xA;&#x9;&#x9;   or  (HD.id_producto=16 and HD.id_plan_producto='CS1  ')&#xA;&#x9;&#x9;   or  (HD.id_producto=16 and HD.id_plan_producto='CS100')&#xA;&#x9;&#x9;   or  (HD.id_producto=4 and HD.id_plan_producto='M    ')&#xA;&#x9;&#x9;   or  (HD.id_producto=16 and HD.id_plan_producto='M    ')&#xA;&#x9;&#x9;   or  (HD.id_producto=20 and HD.id_plan_producto='M    ')&#xA;&#x9;&#x9;   or  (HD.id_producto=14 and HD.id_plan_producto='Z    ')&#xA;&#x9;&#x9;   or  (HD.id_producto=20 and HD.id_plan_producto='Z    '))&#xA;&#x9;&#x9;   or  (HD.id_producto=1 and HD.id_plan_producto='C    ')&#xA;&#x9;&#x9;   or  (HD.id_producto=4 and HD.id_plan_producto='PMO  ')&#xA;&#x9;&#x9;   or  (HD.id_producto=35 and HD.id_plan_producto='PMO  '))&#xA;&#x9;&#x9;GROUP BY I.id_periodo, I.id_orden_int, I.afiliado, I.subnumero, I.secuencia, I.id_persona, HD.id_producto, HD.id_plan_producto,  Isnull(a12.id_rubro_salud,'A'), a13.id_plan_agrupado_S, I.edad_orden, I.id_tipo_internacion, I.fecha_internacion, I.id_estado_aut_orden,I.id_posicion_estab_asist, I.id_posicion_estab_asist, I.id_tipo_prestador, HD.id_prestacion, HD.id_usuario_auditor&#xA;&#xA;&#xA;&#x9;&#x9;UPDATE [DW_Salud].[dbo].[H_INTERNACIONES_DEBITOS] SET id_subproducto = HC.id_subproducto, id_prof_prescr = HC.id_prof_prescr, id_profesional = HC.id_profesional, id_no_facturador = HC.id_no_facturador, id_tipo_profesional_preescribiente = HC.id_tipo_profesional_preescribiente, id_tipo_prestador = HC.id_tipo_prestador&#xA;&#x9;&#x9;FROM [DW_Salud].[dbo].[H_INTERNACIONES_DEBITOS] HD&#xA;&#x9;&#x9;INNER JOIN H_INTERNACIONES_CONSUMOS HC  ON HD.id_orden_int = HC.id_orden_int AND HD.id_prestacion = HC.id_prestacion&#xA;&#x9;&#x9;WHERE HD.id_trimestre_internaciones = @Trimestre_NO_Cambia&#xA;&#x9;&#x9;&#xA;end&#xA;" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:PrecedenceConstraints>
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[{3F729C8D-446A-44D1-8980-25B189B5FA33\}]"
      DTS:CreationName=""
      DTS:DTSID="{3F729C8D-446A-44D1-8980-25B189B5FA33}"
      DTS:From="Package\Actualiza H_INTERNACIONES_CONSUMOS"
      DTS:LogicalAnd="True"
      DTS:ObjectName="{3F729C8D-446A-44D1-8980-25B189B5FA33}"
      DTS:To="Package\Actualiza H_DEBITOS_ORIGEN" />
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[{424C6AE9-487C-40B9-BBA2-57123A46D857\}]"
      DTS:CreationName=""
      DTS:DTSID="{424C6AE9-487C-40B9-BBA2-57123A46D857}"
      DTS:From="Package\Actualiza H_DEBITOS_ORIGEN"
      DTS:LogicalAnd="True"
      DTS:ObjectName="{424C6AE9-487C-40B9-BBA2-57123A46D857}"
      DTS:To="Package\Actualiza H_INTERNACIONES_DEBITOS" />
  </DTS:PrecedenceConstraints>
  <DTS:DesignTimeProperties><![CDATA[<?xml version="1.0"?>
<!--This CDATA section contains the layout information of the package. The section includes information such as (x,y) coordinates, width, and height.-->
<!--If you manually edit this section and make a mistake, you can delete it. -->
<!--The package will still be able to load normally but the previous layout information will be lost and the designer will automatically re-arrange the elements on the design surface.-->
<Objects
  Version="8">
  <!--Each node below will contain properties that do not affect runtime behavior.-->
  <Package
    design-time-name="Package">
    <LayoutInfo>
      <GraphLayout
        Capacity="8" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph" xmlns:mssgle="clr-namespace:Microsoft.SqlServer.Graph.LayoutEngine;assembly=Microsoft.SqlServer.Graph" xmlns:assembly="http://schemas.microsoft.com/winfx/2006/xaml">
        <NodeLayout
          Size="238,42"
          Id="Package\Actualiza H_DEBITOS_ORIGEN"
          TopLeft="35.9779874213836,98.1603773584906" />
        <NodeLayout
          Size="302,42"
          Id="Package\Actualiza H_INTERNACIONES_CONSUMOS"
          TopLeft="3.97798742138363,5.5" />
        <NodeLayout
          Size="286,42"
          Id="Package\Actualiza H_INTERNACIONES_DEBITOS"
          TopLeft="11.9779874213836,190.820754716981" />
        <EdgeLayout
          Id="Package.PrecedenceConstraints[{3F729C8D-446A-44D1-8980-25B189B5FA33\}]"
          TopLeft="154.977987421384,47.5">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="0,50.6603773584906"
              Start="0,0"
              End="0,43.1603773584906">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,43.1603773584906" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
        <EdgeLayout
          Id="Package.PrecedenceConstraints[{424C6AE9-487C-40B9-BBA2-57123A46D857\}]"
          TopLeft="154.977987421384,140.160377358491">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="0,50.6603773584906"
              Start="0,0"
              End="0,43.1603773584906">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,43.1603773584906" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
      </GraphLayout>
    </LayoutInfo>
  </Package>
</Objects>]]></DTS:DesignTimeProperties>
</DTS:Executable>