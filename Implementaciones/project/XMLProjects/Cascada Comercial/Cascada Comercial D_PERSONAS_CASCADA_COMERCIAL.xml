<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationDate="9/14/2017 1:21:38 PM"
  DTS:CreationName="Microsoft.Package"
  DTS:CreatorComputerName="AMS06X"
  DTS:CreatorName="AMS\jtrinchier"
  DTS:DTSID="{BC282B9B-8BAB-47A8-BD32-D87BAC3C2D0A}"
  DTS:ExecutableType="Microsoft.Package"
  DTS:LastModifiedProductVersion="15.0.1301.433"
  DTS:LocaleID="11274"
  DTS:ObjectName="Cascada Comercial D_PERSONAS_CASCADA_COMERCIAL"
  DTS:PackageType="5"
  DTS:VersionBuild="12"
  DTS:VersionGUID="{B3DC2ABF-D33A-42C6-9AEE-591EFB2519B7}">
  <DTS:Property
    DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:LogProviders>
    <DTS:LogProvider
      DTS:ConfigString="DS_MSDB"
      DTS:CreationName="Microsoft.LogProviderSQLServer"
      DTS:Description="Writes log entries for events to a SQL Server database"
      DTS:DTSID="{F8979B19-0981-469B-8562-1597B2C506DA}"
      DTS:ObjectName="SSIS log provider for SQL Server">
      <DTS:ObjectData>
        <InnerObject />
      </DTS:ObjectData>
    </DTS:LogProvider>
  </DTS:LogProviders>
  <DTS:Variables />
  <DTS:LoggingOptions
    DTS:FilterKind="0"
    DTS:LoggingMode="1">
    <DTS:Property
      DTS:DataType="8"
      DTS:Name="EventFilter">1,7,OnError</DTS:Property>
    <DTS:Property
      DTS:EventName="OnError"
      DTS:Name="ColumnFilter">
      <DTS:Property
        DTS:Name="Computer">-1</DTS:Property>
      <DTS:Property
        DTS:Name="Operator">-1</DTS:Property>
      <DTS:Property
        DTS:Name="SourceName">-1</DTS:Property>
      <DTS:Property
        DTS:Name="SourceID">-1</DTS:Property>
      <DTS:Property
        DTS:Name="ExecutionID">-1</DTS:Property>
      <DTS:Property
        DTS:Name="MessageText">-1</DTS:Property>
      <DTS:Property
        DTS:Name="DataBytes">-1</DTS:Property>
    </DTS:Property>
    <DTS:SelectedLogProviders>
      <DTS:SelectedLogProvider
        DTS:InstanceID="{F8979B19-0981-469B-8562-1597B2C506DA}" />
    </DTS:SelectedLogProviders>
  </DTS:LoggingOptions>
  <DTS:Executables>
    <DTS:Executable
      DTS:refId="Package\Borra y Carga D_PERSONAS_CASCADA_COMERCIAL"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{0D81B36F-CF0A-4285-A4A6-09D0E94614F6}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Borra y Carga D_PERSONAS_CASCADA_COMERCIAL"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{B6C8990D-748C-45F8-90C1-4EE0405A1677}"
          SQLTask:SqlStatementSource="/* Borra la tabla de AUX_D_PERSONAS_CASCADA_COMERCIAL */&#xA;&#xA;Truncate table AUX_D_PERSONAS_CASCADA_COMERCIAL&#xA;&#xA;/* Actualizo la tabla de AUX_D_PERSONAS_CASCADA_COMERCIAL */&#xA;&#xA;INSERT INTO AUX_D_PERSONAS_CASCADA_COMERCIAL&#xA;&#x9;(id_asesor_cascada_comercial, id_tipo_puesto_cascada_comercial, nro_legajo_asesor_cascada_comercial, apellido_nombre_asesor_cascada_comercial, id_puesto_cascada_comercial, id_puesto_superior_cascada_comercial, fecha_desde_asesor_cascada_comercial, fecha_hasta_asesor_cascada_comercial)&#xA;  select NUMERO, PU.IDTIPOPUESTO, NROLEGAJO, NOMBRE, PP.IDPUESTO, IDPUESTOSUPERIOR,  PE.FECHAINGRESO, PP.FECHAHASTA&#xA;from [HOST03].[HOST03].[COMERCIAL].[PERSONAS_PUESTOS] PP&#xA;INNER JOIN [HOST03].[HOST03].[COMERCIAL].[PERSONAS] PE ON (PE.IDPERSONA = PP.IDPERSONA)&#xA;INNER JOIN [HOST03].[HOST03].[COMERCIAL].[PUESTOS] PU ON (PP.IDPUESTO = PU.IDPUESTO)&#xA;&#xA;&#xA;---- Agrega las nuevas personas para el periodo produccion trazabilidad de fichas&#xA;&#xA;Declare @Fecha_Inicio_Periodo datetime, @Fecha_Fin_Periodo  datetime, @Periodo int&#xA;Set @Periodo = (Select MAX(id_periodo_produccion) from H_TRAZABILIDAD_FICHAS)&#xA;Set @Fecha_Inicio_Periodo = (select Min(id_fecha) from D_FECHA where id_periodo = @Periodo)&#xA;Set @Fecha_Fin_Periodo = (select MAX(id_fecha) from D_FECHA where id_periodo = @Periodo)&#xA; &#xA;insert into D_PERSONAS_CASCADA_COMERCIAL&#xA;select * from AUX_D_PERSONAS_CASCADA_COMERCIAL P&#xA;&#xA;where id_asesor_cascada_comercial not in &#xA;(select distinct id_asesor_cascada_comercial from D_PERSONAS_CASCADA_COMERCIAL&#xA;)&#xA;and  &#xA;---- Fecha desde&#xA;  p.fecha_desde_asesor_cascada_comercial &lt; @Fecha_Fin_Periodo&#xA;        AND&#xA;---- Fecha hasta&#xA;(p.fecha_hasta_asesor_cascada_comercial is null or&#xA; p.fecha_hasta_asesor_cascada_comercial &gt;= @Fecha_Inicio_Periodo)&#xA; &#xA; &#xA; ---- Agrega las nuevas personas para el periodo abacom pendiente &#xA;&#xA;Declare @Fecha_Inicio_Periodo_ABACOM datetime, @Fecha_Fin_Periodo_ABACOM  datetime, @Periodo_ABACOM int&#xA;Set @Periodo_ABACOM = (Select dbo.DevuelvePeriodo(GETDATE()))&#xA;Set @Fecha_Inicio_Periodo_ABACOM = (select Min(id_fecha) from D_FECHA where id_periodo = @Periodo_ABACOM)&#xA;Set @Fecha_Fin_Periodo_ABACOM = (select MAX(id_fecha) from D_FECHA where id_periodo = @Periodo_ABACOM)&#xA; &#xA;insert into D_PERSONAS_CASCADA_COMERCIAL&#xA;select * from AUX_D_PERSONAS_CASCADA_COMERCIAL P&#xA;&#xA;where id_asesor_cascada_comercial not in &#xA;(select distinct id_asesor_cascada_comercial from D_PERSONAS_CASCADA_COMERCIAL)&#xA;and  &#xA;---- Fecha desde&#xA;  p.fecha_desde_asesor_cascada_comercial &lt; @Fecha_Fin_Periodo_ABACOM AND&#xA;---- Fecha hasta&#xA;(p.fecha_hasta_asesor_cascada_comercial is null or&#xA; p.fecha_hasta_asesor_cascada_comercial &gt;= @Fecha_Inicio_Periodo_ABACOM)&#xA;&#xA;&#xA;&#xA;/* Borra la info de la tabla de D_PERSONAS_CASCADA_COMERCIAL, siempre que tengamos 2 veces o más el mismo asesor, se elimina los que tienen Fecha Hasta*/&#xA;--- De esta manera nos aseguramos que estan presentes los registros de los comerciales vigentes al día de la fecha de actualización.&#xA;&#xA;select id_asesor_cascada_comercial, COUNT(*) as cant&#xA;into #temp_duplicados&#xA; from AUX_D_PERSONAS_CASCADA_COMERCIAL &#xA;group  by id_asesor_cascada_comercial &#xA;having COUNT(*) &gt; 1&#xA;order by cant&#xA;&#xA;&#xA;&#xA;Delete  from AUX_D_PERSONAS_CASCADA_COMERCIAL &#xA;where id_asesor_cascada_comercial in &#xA;(select id_asesor_cascada_comercial from #temp_duplicados) &#xA;and fecha_hasta_asesor_cascada_comercial is not null&#xA;&#xA;---- Actualiza la D_PERSONAS_CASCADA_COMERCIAL&#xA;&#xA;UPDATE D_PERSONAS_CASCADA_COMERCIAL SET id_tipo_puesto_cascada_comercial = A.id_tipo_puesto_cascada_comercial,&#xA;nro_legajo_asesor_cascada_comercial      = A.nro_legajo_asesor_cascada_comercial ,&#xA;apellido_nombre_asesor_cascada_comercial = A.apellido_nombre_asesor_cascada_comercial,&#xA;id_puesto_cascada_comercial              = A.id_puesto_cascada_comercial,&#xA;id_puesto_superior_cascada_comercial = A.id_puesto_superior_cascada_comercial,&#xA;fecha_desde_asesor_cascada_comercial = A.fecha_desde_asesor_cascada_comercial,&#xA;fecha_hasta_asesor_cascada_comercial = A.fecha_hasta_asesor_cascada_comercial&#xA;FROM D_PERSONAS_CASCADA_COMERCIAL D&#xA;Inner Join AUX_D_PERSONAS_CASCADA_COMERCIAL A ON A.id_asesor_cascada_comercial = D.id_asesor_cascada_comercial&#xA;&#xA;&#xA;" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:DesignTimeProperties><![CDATA[<?xml version="1.0"?>
<!--This CDATA section contains the layout information of the package. The section includes information such as (x,y) coordinates, width, and height.-->
<!--If you manually edit this section and make a mistake, you can delete it. -->
<!--The package will still be able to load normally but the previous layout information will be lost and the designer will automatically re-arrange the elements on the design surface.-->
<Objects
  Version="8">
  <!--Each node below will contain properties that do not affect runtime behavior.-->
  <Package
    design-time-name="Package">
    <LayoutInfo>
      <GraphLayout
        Capacity="4" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph">
        <NodeLayout
          Size="356,42"
          Id="Package\Borra y Carga D_PERSONAS_CASCADA_COMERCIAL"
          TopLeft="177.5,37.5" />
      </GraphLayout>
    </LayoutInfo>
  </Package>
</Objects>]]></DTS:DesignTimeProperties>
</DTS:Executable>