<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationDate="11/21/2017 1:12:19 PM"
  DTS:CreationName="Microsoft.Package"
  DTS:CreatorComputerName="AMS06X"
  DTS:CreatorName="AMS\jtrinchier"
  DTS:DTSID="{8909CA6E-7E71-4AFB-96CE-663A2DC057BE}"
  DTS:ExecutableType="Microsoft.Package"
  DTS:LastModifiedProductVersion="15.0.1301.433"
  DTS:LocaleID="11274"
  DTS:ObjectName="Calendario D_PERIODO"
  DTS:PackageType="5"
  DTS:VersionBuild="14"
  DTS:VersionGUID="{D35E8413-4B5A-436F-A757-FAAA0A6E8A07}">
  <DTS:Property
    DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:LogProviders>
    <DTS:LogProvider
      DTS:ConfigString="DS_MSDB"
      DTS:CreationName="Microsoft.LogProviderSQLServer"
      DTS:Description="Writes log entries for events to a SQL Server database"
      DTS:DTSID="{077AAEC4-836D-43F8-A3B2-2AE387E7A524}"
      DTS:ObjectName="SSIS log provider for SQL Server">
      <DTS:ObjectData>
        <InnerObject />
      </DTS:ObjectData>
    </DTS:LogProvider>
  </DTS:LogProviders>
  <DTS:Variables />
  <DTS:LoggingOptions
    DTS:FilterKind="0"
    DTS:LoggingMode="1">
    <DTS:Property
      DTS:DataType="8"
      DTS:Name="EventFilter">1,7,OnError</DTS:Property>
    <DTS:Property
      DTS:EventName="OnError"
      DTS:Name="ColumnFilter">
      <DTS:Property
        DTS:Name="Computer">-1</DTS:Property>
      <DTS:Property
        DTS:Name="Operator">-1</DTS:Property>
      <DTS:Property
        DTS:Name="SourceName">-1</DTS:Property>
      <DTS:Property
        DTS:Name="SourceID">-1</DTS:Property>
      <DTS:Property
        DTS:Name="ExecutionID">-1</DTS:Property>
      <DTS:Property
        DTS:Name="MessageText">-1</DTS:Property>
      <DTS:Property
        DTS:Name="DataBytes">-1</DTS:Property>
    </DTS:Property>
    <DTS:SelectedLogProviders>
      <DTS:SelectedLogProvider
        DTS:InstanceID="{077AAEC4-836D-43F8-A3B2-2AE387E7A524}" />
    </DTS:SelectedLogProviders>
  </DTS:LoggingOptions>
  <DTS:Executables>
    <DTS:Executable
      DTS:refId="Package\Actualización Anual - periodos de la D_PERIODO"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{B75F2C0D-E957-4F25-BF4F-02534A33FF01}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Actualización Anual - periodos de la D_PERIODO"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{3BE99828-8109-4A1B-AE2C-93BA993956A4}"
          SQLTask:SqlStatementSource="---- El objetivo es una actualización Anual de la D_PERIODO todos los día 1 de Julio, agregando el nuevo ejercicio.&#xA;&#xA;---- Comprueba si el mes  de este periodo coincide con el mes de Julio (7), si es 7 envia un mail y actualiza los periodos de la tabla D_PERIODO.&#xA;---- Caso contrario, si el mes es distinto al mes 7 julio, debería pasar el IF sin enviar mail y sin actualizar nada en la D_PERIODO o D_EJERCICIO.&#xA;&#xA;if (select Month(getdate())) = 7&#xA;begin &#xA;&#xA;--- Lo que se requiere en este script es actualizar la D_EJERCICIO con el nuevo id_ejercicio que se agrega los 1 de julio de cada año.&#xA;--- Además se agrega el campo DE_EJERCICIO tomando el año que se actualiza junto con el siguiente.&#xA;---  Ejemplo ID_EJERCICIO = 25 and DE_EJERCICIO = 17/18&#xA;--- Se declaran las variables&#xA;&#xA;Declare @Año_Vigente int, @Año_Siguiente int,  @Año_unir  varchar(4), @Año_unir2  varchar(4)&#xA;, @Año_Right1 varchar(2), @Año_Right2 varchar(2), @DE_EJERCICIO varchar(5), @ID_EJERCICIO int, @ID_EJERCICIO_nuevo_ejercicio int&#xA;&#xA;set @Año_Vigente = (select YEAR(getdate() ) )&#xA;set @Año_Siguiente = (select YEAR(getdate() ) + 1)&#xA;set @Año_unir2 = (select 'Año')&#xA;&#xA;set @Año_unir = (select CONVERT(varchar(10), @Año_Vigente))&#xA;set @Año_unir2 = (select CONVERT(varchar(10), @Año_Siguiente))&#xA;set @Año_Right1 = (SELECT RIGHT(@Año_Vigente, 2) )&#xA;set @Año_Right2 = (SELECT RIGHT(@Año_Siguiente, 2) )&#xA;set @DE_EJERCICIO = (Select (@Año_Right1 + '/' + @Año_Right2) as DE_EJERCICIO)&#xA;set @ID_EJERCICIO = (select MAX(id_ejercicio) from D_PERIODO)&#xA;Set @ID_EJERCICIO_nuevo_ejercicio = (select @ID_EJERCICIO + 1)&#xA;&#xA;--- Se inserta el nuevo ejercicio en la D_EJERCICIO&#xA;insert into D_EJERCICIO &#xA;(ID_EJERCICIO, DE_EJERCICIO, vigencia_consumos)&#xA;select @ID_EJERCICIO_nuevo_ejercicio as ID_EJERCICIO , @DE_EJERCICIO as DE_EJERCICIO, ' ' as vigencia_consumos&#xA;&#xA;------ Se inserta el nuevo año en la tabla D_Anio&#xA;&#xA;IF (select max(ID_ANIO) from D_ANIO) &lt; ( select @Año_Siguiente)&#xA;BEGIN&#xA;insert into D_ANIO&#xA;(id_anio)&#xA;select @Año_Siguiente as id_anio&#xA;from D_ANIO where ID_ANIO not in (select distinct ID_ANIO from D_ANIO)&#xA;END&#xA;&#xA;DECLARE @Periodo INT&#xA;DECLARE @PeriodoSiguiente INT&#xA;DECLARE @Ejercicio INT&#xA;DECLARE @EjercicioProduccion INT&#xA;&#xA;DECLARE @Contador INT&#xA;SET @Contador = 0&#xA;WHILE @Contador &lt;&gt; 12&#xA;BEGIN&#xA;    SET @EjercicioProduccion = (SELECT MAX(id_ejercicio_produccion) FROM D_PERIODO)&#xA;    SET @Ejercicio = (SELECT MAX(ID_EJERCICIO) FROM D_PERIODO)&#xA;    SET @Periodo = (SELECT MAX(id_periodo) FROM D_PERIODO)&#xA;    SET @PeriodoSiguiente = DW_SALUD.dbo.PeriodoSiguiente(CAST(CAST(DW_SALUD.dbo.Devuelve_Fecha(@Periodo) AS VARCHAR) AS DATETIME))&#xA;        INSERT INTO D_PERIODO&#xA;      (id_periodo, id_anio, ID_MES, ID_EJERCICIO, vigente, vigente_consumo, vigente_comercial,&#xA;        vigente_tablero_afiliados, id_trimestre, id_ejercicio_produccion, id_periodo_anual, id_periodo_anual_cobranza, id_periodo_anual_recepcionado, vigente_produccion_fichas, cant_dias_periodo, id_periodo_anterior , id_periodo_anual_produccion, id_periodo_anual_contactos )&#xA;        SELECT TOP 1 @PeriodoSiguiente as id_periodo&#xA;                ,LEFT(@PeriodoSiguiente, 4) as id_anio&#xA;                ,(CASE     WHEN RIGHT(@PeriodoSiguiente, 2) BETWEEN 1 AND 9 THEN RIGHT(@PeriodoSiguiente, 1)&#xA;                        WHEN RIGHT(@PeriodoSiguiente, 2) BETWEEN 10 AND 12 THEN RIGHT(@PeriodoSiguiente, 2) END) AS ID_MES&#xA;                ,(CASE    WHEN RIGHT(@PeriodoSiguiente, 2) = 07 THEN @Ejercicio+1&#xA;                        WHEN RIGHT(@PeriodoSiguiente, 2) &lt;&gt; 07 THEN @Ejercicio END) AS ID_EJERCICIO&#xA;                ,0 as id_vigente&#xA;                ,0 as id_vigente_consumo&#xA;                ,0 as id_vigente_comercial&#xA;                ,0 as vigente_tablero_afiliados&#xA;                ,(CASE    WHEN RIGHT(@PeriodoSiguiente, 2) IN (1, 2, 3) THEN 1&#xA;                        WHEN RIGHT(@PeriodoSiguiente, 2) IN (4, 5, 6) THEN 2&#xA;                        WHEN RIGHT(@PeriodoSiguiente, 2) IN (7, 8, 9) THEN 3&#xA;                        WHEN RIGHT(@PeriodoSiguiente, 2) IN (10, 11, 12) THEN 4 END) as id_trimestre&#xA;                ,(CASE    WHEN RIGHT(@PeriodoSiguiente, 2) = 04 THEN @EjercicioProduccion+1&#xA;                        WHEN RIGHT(@PeriodoSiguiente, 2) &lt;&gt; 04 THEN @EjercicioProduccion END) as id_ejercicio_produccion&#xA;                ,0 as id_periodo_anual&#xA;                ,0 as id_periodo_anual_cobranza&#xA;                ,0 as id_periodo_anual_recepcionado&#xA;                ,0 as vigente_produccion_fichas&#xA;&#x9;&#x9;&#x9;&#x9;,(case when right(@PeriodoSiguiente, 2) IN (1, 3, 5,7,8,10,12) then 31 &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;when right(@PeriodoSiguiente, 2) IN (4,6,9,11)then 30&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;when right(@PeriodoSiguiente, 2) IN (2) and ((left(@PeriodoSiguiente,4) % 4 = 0) and ((@PeriodoSiguiente % 100 &lt;&gt; 0) or (left(@PeriodoSiguiente,4) % 400 = 0))) then 29 &#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;when right(@PeriodoSiguiente, 2) IN (2) and ((left(@PeriodoSiguiente,4) % 4 &lt;&gt; 0) and ((@PeriodoSiguiente % 100 = 0) or (left(@PeriodoSiguiente,4) % 400 &lt;&gt; 0))) then 28 end ) as cant_dias_periodo&#xA;               , @Periodo as id_periodo_anterior , 0 as id_periodo_anual_produccion, 0 as id_periodo_anual_contactos&#xA;&#x9;&#x9;from d_periodo&#xA;    SET @Contador = @Contador+1        &#xA;END&#xA;&#xA;&#xA;EXEC msdb.dbo.sp_send_dbmail&#xA;&#x9;&#x9;&#x9;@profile_name = 'Soporte MicroStrategy',&#xA;&#x9;&#x9;&#x9;@recipients = 'juanfrancisco.trinchieri@sancorsalud.com.ar; nicolas.borio@sancorsalud.com.ar',&#xA;&#x9;&#x9;&#x9;@subject = 'Actualización Anual - Se Agregaron Correctamente los Periodos',&#xA;&#x9;&#x9;&#x9;@body = 'Se informa en este correo que finalizo el proceso de actualización anual de periodos correspondientes.&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9; Se notifica que la tabla D_PERIODO posee la siguiente información :   &#xA;&#x9;&#x9;&#x9; &#xA;&#x9;&#x9;&#x9;                       ',&#xA;&#x9;&#x9;&#x9;@file_attachments = '',&#xA;&#x9;&#x9;&#x9;@query = 'Declare @ID_EJERCICIO_VIGENTE int, @ID_PERIODO_HOY int&#xA;Set @ID_EJERCICIO_VIGENTE = (select MAX(id_ejercicio) from D_PERIODO)&#xA;Set @ID_PERIODO_HOY = (select dbo.DevuelvePeriodo(getdate()))&#xA;&#xA;&#xA;select @ID_EJERCICIO_VIGENTE as ID_EJERCICIO_VIGENTE&#xA;&#xA;select ''Con la Siguiente Tabla Podemos Controlar los Periodos que se agregaron a D_PERIODO'' as Comentario&#xA;&#xA;select ID_EJERCICIO, ID_PERIODO FROM D_PERIODO WHERE ID_PERIODO &gt; = @ID_PERIODO_HOY&#xA;&#xA;select ''ADEMAS SE ACTUALIZO LA D_EJERCICIO, con el nuevo ejercicio vigente'' as Comentario&#xA; &#xA;select  ID_EJERCICIO, DE_EJERCICIO from D_EJERCICIO&#xA;&#xA;where ID_EJERCICIO = @ID_EJERCICIO_VIGENTE &#x9;&#xA;&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;&#xA; ',&#xA;&#x9;&#x9;&#x9;&#x9;@query_result_separator = '|',&#xA;&#x9;&#x9;&#x9;&#x9;@execute_query_database = 'DW_SALUD';&#xA;&#x9;&#x9;&#x9;&#x9;&#xA;&#xA;&#xA;&#xA;end" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:DesignTimeProperties><![CDATA[<?xml version="1.0"?>
<!--Esta sección CDATA contiene la información de diseño del paquete. Esta sección incluye información como, por ejemplo, las coordenadas (x,y), el ancho y el alto.-->
<!--Si edita manualmente esta sección y comete un error, puede eliminarlo. -->
<!--El paquete podrá cargarse normalmente, pero se perderá la información de diseño anterior y el diseñador reorganizará los elementos automáticamente en la superficie de diseño.-->
<Objects
  Version="8">
  <!--Cada uno de los nodos siguientes contiene propiedades que no afectan al comportamiento en tiempo de ejecución.-->
  <Package
    design-time-name="Package">
    <LayoutInfo>
      <GraphLayout
        Capacity="4" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph">
        <NodeLayout
          Size="321,42"
          Id="Package\Actualización Anual - periodos de la D_PERIODO"
          TopLeft="5.5,5.5" />
      </GraphLayout>
    </LayoutInfo>
  </Package>
</Objects>]]></DTS:DesignTimeProperties>
</DTS:Executable>