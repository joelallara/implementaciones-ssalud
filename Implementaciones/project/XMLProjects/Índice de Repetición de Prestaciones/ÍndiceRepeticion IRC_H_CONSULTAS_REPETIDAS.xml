<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationDate="1/16/2019 11:45:12 AM"
  DTS:CreationName="Microsoft.Package"
  DTS:CreatorComputerName="AMS06X"
  DTS:CreatorName="AMS\jtrinchier"
  DTS:DTSID="{68798922-858A-43E0-A9B7-12E41CD8FEA3}"
  DTS:ExecutableType="Microsoft.Package"
  DTS:LastModifiedProductVersion="15.0.1301.433"
  DTS:LocaleID="11274"
  DTS:ObjectName="ÍndiceRepeticion IRC_H_CONSULTAS_REPETIDAS"
  DTS:PackageType="5"
  DTS:VersionBuild="20"
  DTS:VersionGUID="{E283B5AB-5D9B-404D-8E0D-9CC88D4CF8A9}">
  <DTS:Property
    DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:LogProviders>
    <DTS:LogProvider
      DTS:ConfigString="DS_MSDB"
      DTS:CreationName="Microsoft.LogProviderSQLServer"
      DTS:Description="Writes log entries for events to a SQL Server database"
      DTS:DTSID="{5528EC4F-DCF2-4B10-8B65-F64E6A838210}"
      DTS:ObjectName="SSIS log provider for SQL Server">
      <DTS:ObjectData>
        <InnerObject />
      </DTS:ObjectData>
    </DTS:LogProvider>
  </DTS:LogProviders>
  <DTS:Variables />
  <DTS:LoggingOptions
    DTS:FilterKind="0"
    DTS:LoggingMode="1">
    <DTS:Property
      DTS:DataType="8"
      DTS:Name="EventFilter">1,7,OnError</DTS:Property>
    <DTS:Property
      DTS:EventName="OnError"
      DTS:Name="ColumnFilter">
      <DTS:Property
        DTS:Name="Computer">-1</DTS:Property>
      <DTS:Property
        DTS:Name="Operator">-1</DTS:Property>
      <DTS:Property
        DTS:Name="SourceName">-1</DTS:Property>
      <DTS:Property
        DTS:Name="SourceID">-1</DTS:Property>
      <DTS:Property
        DTS:Name="ExecutionID">-1</DTS:Property>
      <DTS:Property
        DTS:Name="MessageText">-1</DTS:Property>
      <DTS:Property
        DTS:Name="DataBytes">-1</DTS:Property>
    </DTS:Property>
    <DTS:SelectedLogProviders>
      <DTS:SelectedLogProvider
        DTS:InstanceID="{5528EC4F-DCF2-4B10-8B65-F64E6A838210}" />
    </DTS:SelectedLogProviders>
  </DTS:LoggingOptions>
  <DTS:Executables>
    <DTS:Executable
      DTS:refId="Package\Actualiza H_CONSULTAS_REPETIDAS_ACREEDOR"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{125E5644-40DD-4407-956C-D8DA293D403D}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Actualiza H_CONSULTAS_REPETIDAS_ACREEDOR"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{AF81043D-1159-4CE8-9D9C-6F22CFB556AE}"
          SQLTask:SqlStatementSource="------  Actualiza campos en H_Consultas_Repetidas id_acreedor_mayoritario, id_tipo_acreedor_mayoritario, importe_consultas_acreedor_mayoritario , importe_consultas_repetidas_profesiona&#xA;&#xA;SET DATEFORMAT 'YMD'&#xA;&#xA;DECLARE @Periodo Int&#xA;DECLARE @Periodo_Cons1 Int&#xA;DECLARE @Periodo_Cons2 Int&#xA;DECLARE @Fecha_calculo_edad DATETIME&#xA;declare @ultimo_semestre int -- Esta linea debe ir al principio del script&#xA;&#xA;&#xA;SET @Periodo =  (Select Max(id_periodo) from D_PERIODO where vigente_consumo = 1)&#xA;SET @Periodo_Cons1 =     (Select dbo.PeriodosAnteriores(@Periodo,12))&#xA;SET @Periodo_Cons2 =   (select   @Periodo)&#xA;SET @Fecha_calculo_edad = (select  CAST(@Periodo as CHAR(6))+'01' )&#xA;&#xA;Truncate Table Consultas_dw.dbo.H_CONSULTAS_REPETIDAS_ACREEDOR &#xA;&#xA;select&#x9;a11.id_profesional  id_profesional,&#xA;&#x9;a11.id_tipo_prestador  id_tipo_prestador,&#xA;&#x9;a11.id_persona  id_persona,&#xA;&#x9;sum(a11.cant_prest_amb_acep)  WJXBFS1,&#xA;&#x9;sum(a11.imp_pret_amb_pag)  WJXBFS2,&#xA;&#x9;a11.id_acreedor&#xA;into #paso2&#xA;from&#x9;H_ORD_AMB_DET&#x9;a11 with (nolock)&#xA;&#x9;join&#x9;D_PRODUCTOS&#x9;a12 with (nolock)&#xA;&#x9;  on &#x9;(a11.id_producto = a12.id_producto)&#xA;&#x9;join&#x9;D_PLANES&#x9;a13 with (nolock)&#xA;&#x9;  on &#x9;(a11.id_plan_producto = a13.id_plan_producto and &#xA;&#x9;a11.id_producto = a13.id_producto)&#xA;    join    D_PRESTACION a14 &#xA;&#x9;  on &#x9;(a11.id_prestacion = a14.id_prestacion)&#xA;where&#x9;(a13.id_SubRubro_ley in ( 1, 2, 3, 5, 6, 7)&#xA; and a11.ccosto2 = 1&#xA; and a14.id_rubro_ind_consumo = 'A'&#xA; and a11.id_origen_prestacion in ('A')&#xA; and a12.Id_Clase_Producto in ('S ')&#xA; and a12.id_segmento not in (3)&#xA; and not ((a11.id_producto = 16 and a11.id_plan_producto = 'CC   ')&#xA;   or  (a11.id_producto=16 and a11.id_plan_producto='CM   ')&#xA;   or  (a11.id_producto=16 and a11.id_plan_producto='CS1  ')&#xA;   or  (a11.id_producto=16 and a11.id_plan_producto='CS100')&#xA;   or  (a11.id_producto=4 and a11.id_plan_producto='M    ')&#xA;   or  (a11.id_producto=16 and a11.id_plan_producto='M    ')&#xA;   or  (a11.id_producto=20 and a11.id_plan_producto='M    ')&#xA;   or  (a11.id_producto=14 and a11.id_plan_producto='Z    ')&#xA;   or  (a11.id_producto=20 and a11.id_plan_producto='Z    ')&#xA;   or  (a11.id_producto=1 and a11.id_plan_producto='C    ')&#xA;   or  (a11.id_producto=4 and a11.id_plan_producto='Z    '))&#xA; and a11.id_periodo between @Periodo_Cons1 and @Periodo_Cons2&#xA; and a11.id_reintegro in ('F'))&#xA;group by&#x9;&#x9;a11.id_profesional,&#xA;&#x9;a11.id_tipo_prestador,&#xA;&#x9;a11.id_persona ,&#xA;&#x9;a11.id_acreedor&#xA;&#xA;insert INTO consultas_dw.dbo.H_CONSULTAS_REPETIDAS_ACREEDOR &#xA;&#x9;(id_periodo,&#xA;&#x9;id_profesional,&#xA;&#x9;id_tipo_prestador,&#xA;&#x9;id_persona,&#xA;&#x9;edad_actual,&#xA;&#x9;cantidad_consultas_repetidas,&#xA;&#x9;importe_consultas_repetida,&#xA;&#x9;id_acreedor,&#xA;&#x9;id_tipo_acreedor)&#xA;select @Periodo,&#xA;&#x9;id_profesional,&#xA;&#x9;id_tipo_prestador,&#xA;&#x9;id_persona,&#xA;&#x9;0,&#xA;&#x9;wjxbfs1,wjxbfs2 as &#xA;&#x9;importe_consultas_repetida, id_acreedor as  id_acreedor,  id_tipo_prestador as id_tipo_acreedor &#xA;from&#x9;#paso2&#x9;pa11&#xA;&#xA;&#x9;&#xA;&#xA;---- Luego extraer el profesional, el acreedor y la sum de todos los importes para dicho acreedor&#xA;select id_profesional, id_tipo_prestador, id_acreedor,id_tipo_acreedor ,SUM(importe_consultas_repetida) as total_importe&#xA;into #Agrupado&#xA;from consultas_dw.dbo.H_CONSULTAS_REPETIDAS_ACREEDOR&#xA;group by id_profesional, id_tipo_prestador, id_acreedor, id_tipo_acreedor&#xA;&#xA;---- Paso siguiente se excluye el profesional , tipo acreedor y monto maximo por profesional&#xA;&#xA;select  id_profesional, id_tipo_prestador, Max(total_importe) as total_importe&#xA;into #profesional_unico&#xA;from #Agrupado &#xA;group by id_profesional, id_tipo_prestador &#xA;&#xA;-----  se le agrega el id_acreedor_mayoritario&#xA;&#xA;select D.id_profesional, D.id_tipo_prestador, id_acreedor as id_acreedor_mayoritario, &#xA;D.total_importe&#xA;into #traspaso&#xA; from #Agrupado D&#xA;inner join  #profesional_unico u ON u.id_profesional = D.id_profesional and D.total_importe = U.total_importe&#xA;order by D.id_profesional&#xA;&#xA;---- Por ultimo actualizar para cada profesional , el id_acreedor y id_tipo_Acreedor.&#xA;&#xA;&#xA;---- Actualiza tomando la info de la temporal de traspaso.&#xA;&#xA;UPDATE H_CONSULTAS_REPETIDAS SET id_acreedor_mayoritario = T.id_acreedor_mayoritario , &#xA;id_tipo_acreedor_mayoritario = T.id_tipo_prestador,&#xA;importe_consultas_acreedor_mayoritario = T.total_importe&#xA;from H_CONSULTAS_REPETIDAS H&#xA;inner join #traspaso T ON T.id_profesional = h.id_profesional and H.id_tipo_prestador = T.id_tipo_prestador&#xA;where id_periodo = @Periodo&#xA;&#xA;---- Actualiza importe_consultas_repetidas_profesional&#xA;&#xA;select id_profesional, id_tipo_prestador,SUM(importe_consultas_repetidas) as importe_sumado&#xA;into ##importe_sumado_profesional&#xA; from H_CONSULTAS_REPETIDAS&#xA;where id_periodo = @Periodo&#xA;group by id_profesional, id_tipo_prestador&#xA;&#xA;UPDATE H_CONSULTAS_REPETIDAS SET importe_consultas_repetidas_profesional = importe_sumado&#xA;from H_CONSULTAS_REPETIDAS H&#xA;inner join ##importe_sumado_profesional T ON T.id_profesional = h.id_profesional&#xA;and H.id_tipo_prestador = T.id_tipo_prestador&#xA;where id_periodo = @Periodo" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\Actualiza H_CONSULTAS_REPETIDAS_CONSTANTES"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{E8136027-5AF2-4B09-B6A2-DB659810FEB6}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Actualiza H_CONSULTAS_REPETIDAS_CONSTANTES"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{AF81043D-1159-4CE8-9D9C-6F22CFB556AE}"
          SQLTask:SqlStatementSource="DECLARE @Periodo Int&#xA;SET @Periodo = (Select Max(id_periodo) from H_CONSULTAS_REPETIDAS)&#xA;&#xA;truncate table [dbo].[IRC_CTES]&#xA;&#xA;truncate table [dbo].[H_CONSULTAS_REPETIDAS_CONSTANTES]&#xA;&#xA;INSERT INTO [DW_SALUD].[dbo].[IRC_CTES]&#xA;           ([id_periodo]&#xA;           ,[id_posicion_profesional]&#xA;           ,[de_posicion_profesional]&#xA;           ,[id_grupo_especialidad_profesional]&#xA;           ,[de_grupo_especialidad_profesional]&#xA;           ,[cantidad_consultas]&#xA;           ,[cantidad_personas]&#xA;           ,[promedio_stdev])&#xA;  &#xA;select H.id_periodo, PO.id_posicion_profesional, PO.de_posicion_profesional, &#xA;E.id_grupo_especialidad_profesional, GE.de_grupo_especialidad_profesional, &#xA;SUM(H.cantidad_consultas_repetidas) as cantidad_consultas, &#xA;COUNT(distinct H.id_persona) as cantidad_personas, &#xA;CAST(CAST(SUM(H.cantidad_consultas_repetidas) as float)/CAST(COUNT(distinct H.id_persona) as float) as decimal(10,6)) as promedio_stdev&#xA;FROM dbo.H_CONSULTAS_REPETIDAS H&#xA;INNER JOIN dbo.D_PROFESIONAL P ON H.id_profesional = P.id_profesional AND H.id_tipo_prestador = P.id_tipo_Prestador&#xA;INNER JOIN dbo.D_ESPECIALIDAD_PROFESIONAL E ON P.id_especialidad_profesional = E.id_especialidad_profesional&#xA;INNER JOIN dbo.D_POSICION_PROFESIONAL PO ON P.id_posicion_profesional = PO.id_posicion_profesional&#xA;INNER JOIN dbo.D_GRUPO_ESPECIALIDAD_PROFESIONAL GE ON E.id_grupo_especialidad_profesional = GE.id_grupo_especialidad_profesional&#xA;INNER JOIN dbo.D_CATEGORIA_PROFESIONAL CA ON P.id_categoria_profesional = CA.id_categoria_profesional &#xA;WHERE H.id_periodo = @Periodo AND H.id_profesional_cantidad_consultas &gt;= 30 AND CA.id_grupo_categoria_profesional  = 1 AND GE.id_grupo_especialidad_profesional in (1,2,7,8,11,14,9,3,6,0,17,5,18,13,16,4,12,10, 19, 20, 21, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36 , 37)&#xA;group by H.id_periodo, PO.id_posicion_profesional, PO.de_posicion_profesional, E.id_grupo_especialidad_profesional, GE.de_grupo_especialidad_profesional, H.id_profesional, H.id_tipo_prestador&#xA;ORDER BY PO.de_posicion_profesional, GE.de_grupo_especialidad_profesional&#xA;&#xA;-- Desviacion Standard y Promedio&#xA;&#xA;INSERT INTO [DW_SALUD].[dbo].[H_CONSULTAS_REPETIDAS_CONSTANTES]&#xA;           ([id_periodo]&#xA;           ,[id_posicion_profesional]&#xA;           ,[id_grupo_especialidad_profesional]&#xA;           ,[promedio]&#xA;           ,[desv_std]&#xA;           ,[prom_mas_ds]&#xA;           ,[prom_menos_ds]&#xA;           ,[prom_mas_2ds]&#xA;           ,[prom_menos_2ds])&#xA;&#xA;SELECT id_periodo, id_posicion_profesional, id_grupo_especialidad_profesional, &#xA;CAST(CAST(SUM(cantidad_consultas) as float)/CAST(SUM(cantidad_personas) as float) as float) as promedio, &#xA;STDEVP(promedio_stdev) as desv_std, 0 as prom_mas_ds, 0 as prom_menos_ds, 0 as prom_mas_2ds, 0 as prom_menos_2ds&#xA;from IRC_CTES &#xA;GROUP BY id_periodo, id_posicion_profesional, de_posicion_profesional, id_grupo_especialidad_profesional, de_grupo_especialidad_profesional&#xA;&#xA;--- Calculo de desv_std teniendo en cuenta el grupo de especialidad y la posicion del profesional&#xA;SELECT id_posicion_profesional, id_grupo_especialidad_profesional, &#xA;STDEV(promedio_stdev) as desv_std &#xA;into #paso1&#xA;from IRC_CTES&#xA;group by id_posicion_profesional, id_grupo_especialidad_profesional&#xA;&#xA;update #paso1&#xA;set desv_std = 0&#xA;where desv_std is null&#xA;&#xA;UPDATE [DW_SALUD].[dbo].[H_CONSULTAS_REPETIDAS_CONSTANTES] SET desv_std = pas.desv_std&#xA;FROM [DW_SALUD].[dbo].[H_CONSULTAS_REPETIDAS_CONSTANTES] a11 &#xA;INNER JOIN #paso1 pas on (pas.id_posicion_profesional = a11.id_posicion_profesional and &#xA;pas.id_grupo_especialidad_profesional = a11.id_grupo_especialidad_profesional)&#xA;&#xA;&#xA;UPDATE [DW_SALUD].[dbo].[H_CONSULTAS_REPETIDAS_CONSTANTES] SET prom_mas_ds = promedio + desv_std&#xA;&#xA;UPDATE [DW_SALUD].[dbo].[H_CONSULTAS_REPETIDAS_CONSTANTES] SET prom_menos_ds = promedio - desv_std&#xA;&#xA;UPDATE [DW_SALUD].[dbo].[H_CONSULTAS_REPETIDAS_CONSTANTES] SET prom_mas_2ds = promedio + (desv_std*2)&#xA;&#xA;UPDATE [DW_SALUD].[dbo].[H_CONSULTAS_REPETIDAS_CONSTANTES] SET prom_menos_2ds = promedio - (desv_std*2)&#xA;" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\Actualiza TRANS_PERIODO_IRC"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{EA15A060-1DE6-4C25-8C07-30B38D1F0806}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Actualiza TRANS_PERIODO_IRC"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{AF81043D-1159-4CE8-9D9C-6F22CFB556AE}"
          SQLTask:SqlStatementSource="Declare @Periodo_Actual_IRC int, @Periodo_Anterior_IRC int&#xA;SET @Periodo_Anterior_IRC = (Select Max(id_periodo) from TRANS_PERIODO_IRC)&#xA;SET @Periodo_Actual_IRC = (Select Max(id_periodo) from H_CONSULTAS_REPETIDAS)&#xA;&#xA;&#xA;Insert into TRANS_PERIODO_IRC&#xA;(id_periodo, id_periodo_anterior_irc)&#xA;select  @Periodo_Actual_IRC, @Periodo_Anterior_IRC&#xA;where @Periodo_Actual_IRC &gt; @Periodo_Anterior_IRC" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\Armado de H_CONSULTAS_REPETIDAS"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{CCC37980-D8BF-4E59-A93A-091B3E13EDAB}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Armado de H_CONSULTAS_REPETIDAS"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{AF81043D-1159-4CE8-9D9C-6F22CFB556AE}"
          SQLTask:SqlStatementSource="SET DATEFORMAT 'YMD'&#xA;&#xA;DECLARE @Periodo Int&#xA;DECLARE @Periodo_Cons1 Int&#xA;DECLARE @Periodo_Cons2 Int&#xA;DECLARE @Fecha_calculo_edad DATETIME&#xA;DECLARE @ultimo_semestre int -- Esta linea debe ir al principio del script&#xA;&#xA;&#xA;SET @Periodo =  (Select Max(id_periodo) from D_PERIODO where vigente_consumo = 1)&#xA;SET @Periodo_Cons1 = (Select dbo.PeriodosAnteriores(@Periodo,12))&#xA;SET @Periodo_Cons2 =  (select   @Periodo)&#xA;SET @Fecha_calculo_edad = (select  CAST(@Periodo as CHAR(6))+'01' )&#xA;&#xA;Delete from H_CONSULTAS_REPETIDAS where id_periodo = @Periodo&#xA;&#xA;select&#x9;a11.id_profesional  id_profesional,&#xA;&#x9;a11.id_tipo_prestador  id_tipo_prestador,&#xA;&#x9;a11.id_persona  id_persona,&#xA;&#x9;sum(a11.cant_prest_amb_acep)  WJXBFS1,&#xA;&#x9;sum(a11.imp_pret_amb_pag)  WJXBFS2&#xA;into #paso1&#xA;from&#x9;H_ORD_AMB_DET&#x9;a11 &#xA;&#x9;join&#x9;D_PRODUCTOS&#x9;a12 &#xA;&#x9;  on &#x9;(a11.id_producto = a12.id_producto)&#xA;&#x9;join&#x9;D_PLANES&#x9;a13 &#xA;&#x9;  on &#x9;(a11.id_plan_producto = a13.id_plan_producto and &#xA;&#x9;a11.id_producto = a13.id_producto)&#xA;&#x9;join    D_PRESTACION a14 &#xA;&#x9;  on &#x9;(a11.id_prestacion = a14.id_prestacion)&#xA;where&#x9;(a13.id_SubRubro_ley in ( 1, 2, 3, 5, 6, 7)&#xA; and a11.ccosto2 = 1&#xA; and a14.id_rubro_ind_consumo = 'A'&#xA; and a11.id_origen_prestacion in ('A')&#xA; and a12.Id_Clase_Producto in ('S ')&#xA; and a12.id_segmento not in (3)&#xA; and not ((a11.id_producto = 16 and a11.id_plan_producto = 'CC   ')&#xA;   or  (a11.id_producto=16 and a11.id_plan_producto='CM   ')&#xA;   or  (a11.id_producto=16 and a11.id_plan_producto='CS1  ')&#xA;   or  (a11.id_producto=16 and a11.id_plan_producto='CS100')&#xA;   or  (a11.id_producto=4 and a11.id_plan_producto='M    ')&#xA;   or  (a11.id_producto=16 and a11.id_plan_producto='M    ')&#xA;   or  (a11.id_producto=20 and a11.id_plan_producto='M    ')&#xA;   or  (a11.id_producto=14 and a11.id_plan_producto='Z    ')&#xA;   or  (a11.id_producto=20 and a11.id_plan_producto='Z    ')&#xA;   or  (a11.id_producto=1 and a11.id_plan_producto='C    ')&#xA;   or  (a11.id_producto=4 and a11.id_plan_producto='Z    '))&#xA; and a11.id_periodo between @Periodo_Cons1 and @Periodo_Cons2&#xA; and a11.id_reintegro in ('F'))&#xA;group by&#x9;&#x9;a11.id_profesional,&#xA;&#x9;a11.id_tipo_prestador,&#xA;&#x9;a11.id_persona &#xA;&#xA;Insert INTO H_CONSULTAS_REPETIDAS&#xA;&#x9;(id_periodo,&#xA;&#x9;id_profesional,&#xA;&#x9;id_tipo_prestador,&#xA;&#x9;id_persona,&#xA;&#x9;edad_actual,&#xA;&#x9;cantidad_consultas_repetidas,&#xA;&#x9;importe_consultas_repetidas)&#xA;select&#x9;@Periodo,&#xA;&#x9;&#x9;id_profesional,&#xA;&#x9;&#x9;id_tipo_prestador,&#xA;&#x9;&#x9;id_persona,&#xA;&#x9;&#x9;0,&#xA;&#x9;&#x9;wjxbfs1,&#xA;&#x9;&#x9;wjxbfs2&#xA;from&#x9;#paso1&#x9;pa11&#xA;&#xA;drop table #paso1&#xA;&#xA;UPDATE H_CONSULTAS_REPETIDAS&#xA; set edad_actual = case isdate(Fecha_Nacimiento) when 0 then 0 else datediff(YEAR, Fecha_Nacimiento, @Fecha_calculo_edad) end&#xA; from H_CONSULTAS_REPETIDAS a11 inner join D_PERSONAS t on (a11.id_persona = t.id_persona)&#xA;where id_periodo = @Periodo&#xA;&#xA;UPDATE H_CONSULTAS_REPETIDAS SET id_profesional_cantidad_consultas = Consultas_Profesional.cantidad_consultas &#xA;FROM H_CONSULTAS_REPETIDAS H&#xA;INNER JOIN (Select id_periodo, id_profesional, id_tipo_prestador, sum(cantidad_consultas_repetidas) AS cantidad_consultas &#xA;            FROM H_CONSULTAS_REPETIDAS &#xA;            GROUP BY id_periodo, id_profesional, id_tipo_prestador) Consultas_Profesional            &#xA;            ON H.id_periodo = Consultas_Profesional.id_periodo AND H.id_profesional = Consultas_Profesional.id_profesional AND H.id_tipo_prestador = Consultas_Profesional.id_tipo_prestador&#xA;&#xA;&#xA;Select @ultimo_semestre = MAX(id_periodo) from H_CONSULTAS_REPETIDAS&#xA;&#xA;UPDATE H_CONSULTAS_REPETIDAS set id_ultimo_semestre = @ultimo_semestre &#xA;&#xA;--- Eliminar al socio A de las estadísticas&#xA;&#xA;Delete H_CONSULTAS_REPETIDAS where id_persona = 22606&#xA;" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\Borra en H_CONSULTAS_REPETIDAS el periodo más viejo"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{58073DCE-72D5-4518-AEE1-0DE7FD30F7B9}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Borra en H_CONSULTAS_REPETIDAS el periodo más viejo"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{AF81043D-1159-4CE8-9D9C-6F22CFB556AE}"
          SQLTask:SqlStatementSource="IF (Select COUNT(distinct id_periodo) from H_CONSULTAS_REPETIDAS) &gt;= 6&#xA;BEGIN&#xA;&#xA;Declare @PERIODO_MAS_VIEJO INT &#xA;SET  @PERIODO_MAS_VIEJO = (Select MIN(id_periodo) from H_CONSULTAS_REPETIDAS)&#xA;&#xA;DELETE FROM H_CONSULTAS_REPETIDAS where id_periodo = @PERIODO_MAS_VIEJO&#xA;&#xA;END" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:PrecedenceConstraints>
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[Constraint]"
      DTS:CreationName=""
      DTS:DTSID="{63E18A00-E389-4880-9724-6A5E83DEEC01}"
      DTS:From="Package\Armado de H_CONSULTAS_REPETIDAS"
      DTS:LogicalAnd="True"
      DTS:ObjectName="Constraint"
      DTS:To="Package\Actualiza H_CONSULTAS_REPETIDAS_ACREEDOR" />
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[Constraint 1]"
      DTS:CreationName=""
      DTS:DTSID="{5B174B1E-CD0E-436E-BD8B-6B5FE0B8641C}"
      DTS:From="Package\Actualiza TRANS_PERIODO_IRC"
      DTS:LogicalAnd="True"
      DTS:ObjectName="Constraint 1"
      DTS:To="Package\Actualiza H_CONSULTAS_REPETIDAS_CONSTANTES" />
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[Constraint 2]"
      DTS:CreationName=""
      DTS:DTSID="{55D227CB-09BB-425E-8C8D-75F2F948A0A1}"
      DTS:From="Package\Actualiza H_CONSULTAS_REPETIDAS_CONSTANTES"
      DTS:LogicalAnd="True"
      DTS:ObjectName="Constraint 2"
      DTS:To="Package\Borra en H_CONSULTAS_REPETIDAS el periodo más viejo" />
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[Constraint 3]"
      DTS:CreationName=""
      DTS:DTSID="{E1344C2B-C265-427D-8CFF-611C4F686009}"
      DTS:From="Package\Actualiza H_CONSULTAS_REPETIDAS_ACREEDOR"
      DTS:LogicalAnd="True"
      DTS:ObjectName="Constraint 3"
      DTS:To="Package\Actualiza TRANS_PERIODO_IRC" />
  </DTS:PrecedenceConstraints>
  <DTS:DesignTimeProperties><![CDATA[<?xml version="1.0"?>
<!--This CDATA section contains the layout information of the package. The section includes information such as (x,y) coordinates, width, and height.-->
<!--If you manually edit this section and make a mistake, you can delete it. -->
<!--The package will still be able to load normally but the previous layout information will be lost and the designer will automatically re-arrange the elements on the design surface.-->
<Objects
  Version="8">
  <!--Each node below will contain properties that do not affect runtime behavior.-->
  <Package
    design-time-name="Package">
    <LayoutInfo>
      <GraphLayout
        Capacity="16" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph" xmlns:mssgle="clr-namespace:Microsoft.SqlServer.Graph.LayoutEngine;assembly=Microsoft.SqlServer.Graph" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:mssge="clr-namespace:Microsoft.SqlServer.Graph.Extended;assembly=Microsoft.SqlServer.IntegrationServices.Graph" xmlns:av="http://schemas.microsoft.com/winfx/2006/xaml/presentation">
        <NodeLayout
          Size="345,42"
          Id="Package\Actualiza H_CONSULTAS_REPETIDAS_ACREEDOR"
          TopLeft="18.0867924528302,74.3584905660377" />
        <NodeLayout
          Size="358,42"
          Id="Package\Actualiza H_CONSULTAS_REPETIDAS_CONSTANTES"
          TopLeft="11.5867924528302,212.075471698113" />
        <NodeLayout
          Size="246,42"
          Id="Package\Actualiza TRANS_PERIODO_IRC"
          TopLeft="67.5867924528302,143.216981132075" />
        <NodeLayout
          Size="285,42"
          Id="Package\Armado de H_CONSULTAS_REPETIDAS"
          TopLeft="48.0867924528302,5.5" />
        <NodeLayout
          Size="374,42"
          Id="Package\Borra en H_CONSULTAS_REPETIDAS el periodo más viejo"
          TopLeft="3.5867924528302,280.933962264151" />
        <EdgeLayout
          Id="Package.PrecedenceConstraints[Constraint]"
          TopLeft="190.58679245283,47.5">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{x:Null}"
              EndConnector="0,26.8584905660377"
              Start="0,0"
              End="0,19.3584905660377">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,19.3584905660377" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
        <EdgeLayout
          Id="Package.PrecedenceConstraints[Constraint 1]"
          TopLeft="190.58679245283,185.216981132075">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{x:Null}"
              EndConnector="0,26.858490566038"
              Start="0,0"
              End="0,19.358490566038">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,19.358490566038" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
        <EdgeLayout
          Id="Package.PrecedenceConstraints[Constraint 2]"
          TopLeft="190.58679245283,254.075471698113">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{x:Null}"
              EndConnector="0,26.858490566038"
              Start="0,0"
              End="0,19.358490566038">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,19.358490566038" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
        <EdgeLayout
          Id="Package.PrecedenceConstraints[Constraint 3]"
          TopLeft="190.58679245283,116.358490566038">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{x:Null}"
              EndConnector="0,26.8584905660377"
              Start="0,0"
              End="0,19.3584905660377">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,19.3584905660377" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
        <AnnotationLayout
          Text="               ------ &gt;  Actualiza campos en H_Consultas_Repetidas"
          ParentId="Package"
          Size="305,51"
          Id="04e8b936-7c63-46f3-bf1e-c8115a6acc2b"
          TopLeft="391.141509433962,71.5754716981132">
          <AnnotationLayout.FontInfo>
            <mssge:FontInfo
              Family="Tahoma"
              Size="11.25"
              Color="#FF080000">
              <mssge:FontInfo.TextDecorations>
                <av:TextDecorationCollection />
              </mssge:FontInfo.TextDecorations>
            </mssge:FontInfo>
          </AnnotationLayout.FontInfo>
        </AnnotationLayout>
      </GraphLayout>
    </LayoutInfo>
  </Package>
</Objects>]]></DTS:DesignTimeProperties>
</DTS:Executable>