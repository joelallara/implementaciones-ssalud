<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationDate="8/22/2019 10:23:46 AM"
  DTS:CreationName="Microsoft.Package"
  DTS:CreatorComputerName="LA22676-08835"
  DTS:CreatorName="AMS\nprida"
  DTS:DTSID="{64D9A275-99A1-4119-9FA2-97FEBAC3EDB6}"
  DTS:ExecutableType="Microsoft.Package"
  DTS:LastModifiedProductVersion="15.0.1301.433"
  DTS:LocaleID="11274"
  DTS:ObjectName="Conectividad_MEDIANAS_H_TRANSACCIONES_PRESTACIONES"
  DTS:PackageType="5"
  DTS:VersionBuild="3"
  DTS:VersionGUID="{CF23C793-33F6-4F98-8D98-30B9169EE3A9}">
  <DTS:Property
    DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:LogProviders>
    <DTS:LogProvider
      DTS:ConfigString="DS_MSDB"
      DTS:CreationName="Microsoft.LogProviderSQLServer"
      DTS:Description="Writes log entries for events to a SQL Server database"
      DTS:DTSID="{023438FD-32A2-422A-8C18-052B07C5974D}"
      DTS:ObjectName="SSIS log provider for SQL Server">
      <DTS:ObjectData>
        <InnerObject />
      </DTS:ObjectData>
    </DTS:LogProvider>
  </DTS:LogProviders>
  <DTS:Variables />
  <DTS:LoggingOptions
    DTS:FilterKind="0"
    DTS:LoggingMode="1">
    <DTS:SelectedLogProviders>
      <DTS:SelectedLogProvider
        DTS:InstanceID="{023438FD-32A2-422A-8C18-052B07C5974D}" />
    </DTS:SelectedLogProviders>
  </DTS:LoggingOptions>
  <DTS:Executables>
    <DTS:Executable
      DTS:refId="Package\Actualiza Medianas en H_TRANSACCIONES_PRESTACIONES"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{79deb785-9212-4705-b450-19c6089988a6}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Actualiza Medianas en H_TRANSACCIONES_PRESTACIONES"
      DTS:TaskContact="Execute SQL Task; Microsoft Corporation; Microsoft SQL Server 2008 R2; © 2007 Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:LoggingOptions
        DTS:FilterKind="0" />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{8BD4D703-8049-4F8E-B36A-AAAD9C1434D4}"
          SQLTask:SqlStatementSource="--ACTUALIZO LOS VALORES DE LAS MEDIANAS&#xA;--DECLARO LOS PERIODOS DESEADOS&#xA;&#xA;declare @periodo_desde int, @periodo_hasta int, @Periodo_Desde_Consumo INT, &#xA;@Periodo_Hasta_Consumo INT,  @Periodo_Siguiente_Consumo_Cerrado INT, @mes7 INT,&#xA;@Periodo_Hasta_Prestaciones INT, @Periodo_Desde_Prestaciones INT&#xA;&#xA;set @periodo_hasta = (SELECT MAX( id_periodo ) FROM H_TRANSACCIONES_PRESTACIONES)&#xA;set @periodo_desde = (SELECT MAX( id_periodo ) - 100 FROM H_TRANSACCIONES_PRESTACIONES)&#xA;SET @Periodo_Desde_Consumo = (select min(id_periodo) from D_periodo where id_periodo in (select top 12 id_periodo from D_PERIODO&#xA;                               where vigente_consumo = 1&#xA;                                group by  id_periodo&#xA;                                order by id_periodo desc))&#xA;SET @Periodo_Hasta_Consumo = (select MAX(id_periodo) from D_PERIODO where vigente_consumo = 1)&#xA;SET @Periodo_Siguiente_Consumo_Cerrado = (select dbo.PeriodosPosteriores(@Periodo_Hasta_Consumo, 2))&#xA;SET @mes7 =  ( select dbo.PeriodosPosteriores(@Periodo_Desde_Consumo,7)) /* Obtener el mes 7 de U12M de consumo */&#xA;SET @Periodo_Desde_Prestaciones = @periodo_desde&#xA;SET @Periodo_Hasta_Prestaciones = @periodo_hasta&#xA;&#xA;-- SETEO EL VALOR DE imp_unitario_pag&#xA;&#xA;--ACTUALIZO IMP_UNITARIO_PAG&#xA;Update H_TRANSACCIONES_PRESTACIONES&#xA;set imp_unitario_pag = imp_prest_pag / cant_prest_pag&#xA;from H_TRANSACCIONES_PRESTACIONES &#xA;where id_periodo &gt;= @periodo_desde and id_periodo &lt;= @periodo_hasta&#xA;and cant_prest_pag &lt;&gt; 0 and imp_prest_pag &lt;&gt; 0 and id_tipo_transaccion_metodo &lt;&gt; 3&#xA;&#xA;---SETEO EL VALOR DE LAS MEDIANAS&#xA;Update H_TRANSACCIONES_PRESTACIONES&#xA;set mediana_acreedor_prestacion = M.[mediana_Acreedor_Prestacion]&#xA;from H_TRANSACCIONES_PRESTACIONES P&#xA;inner join D_MEDIANAS_ACREEDOR_PRESTACION M on P.id_acreedor = M.id_acreedor &#xA;             and P.id_tipo_prestador = M.id_Tipo_Prestador &#xA;             and P.id_prestacion = M.id_prestacion&#xA;where id_periodo &gt;= @periodo_desde and id_periodo &lt;= @periodo_hasta and id_tipo_transaccion_metodo &lt;&gt; 3&#xA;&#xA;    ----------------------&#xA;&#xA;Update H_TRANSACCIONES_PRESTACIONES&#xA;set [mediana_posicion_acreedor_prestacion] = M.[mediana_PosicionAcreedor_Prestacion]&#xA;from H_TRANSACCIONES_PRESTACIONES P&#xA;inner join D_ACREEDOR  A on P.id_acreedor = A.id_acreedor &#xA;inner join D_MEDIANAS_POSICION_ACREEDOR_PRESTACION M on A.id_posicion_acreedor = M.id_posicion_acreedor &#xA;                      and P.id_prestacion = M.id_prestacion&#xA;where id_periodo &gt;= @periodo_desde and id_periodo &lt;= @periodo_hasta and id_tipo_transaccion_metodo &lt;&gt; 3&#xA;    ----------------------&#xA;Update H_TRANSACCIONES_PRESTACIONES&#xA;set mediana_prestacion_conectividad = M.mediana_Prestacion&#xA;from H_TRANSACCIONES_PRESTACIONES P&#xA;inner join D_MEDIANAS_PRESTACION M on  P.id_prestacion = M.id_prestacion&#xA;where id_periodo &gt;= @periodo_desde and id_periodo &lt;= @periodo_hasta and id_tipo_transaccion_metodo &lt;&gt; 3&#xA;&#xA;&#xA;    ----------------&#xA;--------------------------------------------------------------------------------------------&#xA;--SI imp_unitario_pag TIENE VALOR SE LE PASA ESE VALOR A imp_final_conectividad&#xA;--SI imp_unitario_pag NO TIENE VALOR SE LE PASA ESE VALOR DE mediana_acreedor_prestacion A imp_final_conectividad &#xA;--SI mediana_acreedor_prestacion NO TIENE VALOR SE LE PASA ESE VALOR DE mediana_posicion_acreedor_prestacion A imp_final_conectividad &#xA;--SI mediana_posicion_acreedor_prestacion NO TIENE VALOR SE LE PASA ESE VALOR DE mediana_prestacion A imp_final_conectividad &#xA;&#xA;update H_TRANSACCIONES_PRESTACIONES&#xA;set  imp_final_conectividad = CASE &#xA; WHEN (imp_unitario_pag &lt;&gt; 0) THEN imp_unitario_pag * cant_prest_pag &#xA; WHEN (imp_unitario_pag = 0 and mediana_acreedor_prestacion &lt;&gt; 0) &#xA; THEN mediana_acreedor_prestacion * cantidad_prestaciones&#xA; WHEN (mediana_posicion_acreedor_prestacion &lt;&gt; 0 and imp_unitario_pag = 0 and mediana_acreedor_prestacion = 0 ) &#xA;      THEN mediana_posicion_acreedor_prestacion * cantidad_prestaciones&#xA; WHEN (mediana_prestacion_conectividad &lt;&gt; 0 and imp_unitario_pag = 0 and  &#xA;   mediana_acreedor_prestacion = 0 and mediana_posicion_acreedor_prestacion = 0 ) &#xA;    THEN mediana_prestacion_conectividad * cantidad_prestaciones&#xA; WHEN (imp_unitario_pag = 0 and mediana_acreedor_prestacion = 0 and mediana_posicion_acreedor_prestacion = 0 and mediana_prestacion_conectividad = 0  ) &#xA;  THEN 0 &#xA; END &#xA;FROM H_TRANSACCIONES_PRESTACIONES &#xA;where id_periodo &gt;= @periodo_desde and id_periodo &lt;=@periodo_hasta and id_tipo_transaccion_metodo &lt;&gt; 3&#xA;&#xA;&#xA;--CARGO INFORMACION EN LAS COLUMNAS DE MEDIANAS AJUSTADAS: [mediana_acreedor_prestacion_ajustada],[mediana_posicion_acreedor_ajustada],&#xA;--[mediana_prestacion_conectividad_ajustada]],[imp_final_conectividad_ajustada]&#xA;&#xA;&#xA;/* Calculo del % de aumento a aplicar a partir del mes 7 de consumo */&#xA;DECLARE @aumento FLOAT&#xA;SET @aumento = (select SUM(aumento_Sss) from H_ARANCELES_AUMENTOS where id_periodo &gt;= @Periodo_Desde_Consumo &#xA;and id_periodo &lt;= @Periodo_Hasta_Consumo)/2&#xA;&#xA;/* Actualizar los valores a todas las prestaciones hasta el mes 6 de consumo */&#xA;UPDATE H_TRANSACCIONES_PRESTACIONES&#xA;SET mediana_acreedor_prestacion_ajustada = mediana_acreedor_prestacion , &#xA; mediana_posicion_acreedor_prestacion_ajustada = mediana_posicion_acreedor_prestacion,&#xA; mediana_prestacion_conectividad_ajustada = mediana_prestacion_conectividad&#xA; --imp_final_conectividad_ajustada = imp_final_conectividad&#xA; WHERE id_periodo &gt;= @Periodo_Desde_prestaciones and id_periodo &lt; @mes7 and id_tipo_transaccion_metodo &lt;&gt; 3&#xA;&#xA;/* Actualizar los valores a todas las prestaciones a partir del mes 7 de consumo &#xA;hasta el periodo de consumo incluido */&#xA;UPDATE  H_TRANSACCIONES_PRESTACIONES&#xA;set mediana_acreedor_prestacion_ajustada = mediana_acreedor_prestacion + mediana_acreedor_prestacion  * @aumento,&#xA;mediana_posicion_acreedor_prestacion_ajustada = mediana_posicion_acreedor_prestacion + mediana_posicion_acreedor_prestacion * @aumento,&#xA;mediana_prestacion_conectividad_ajustada = mediana_prestacion_conectividad + mediana_prestacion_conectividad * @aumento&#xA;--imp_final_conectividad_ajustada = imp_final_conectividad + imp_final_conectividad * @aumento&#xA;WHERE id_periodo &gt;= @mes7 and id_periodo &lt;= @Periodo_Hasta_Consumo and id_tipo_transaccion_metodo &lt;&gt; 3&#xA;&#xA;/* Actualizar los valores a todas las internaciones a partir del mes siguiente de consumo &#xA;hasta el ultimo periodo que hay internaciones */&#xA;UPDATE H_TRANSACCIONES_PRESTACIONES&#xA;set mediana_acreedor_prestacion_ajustada = mediana_acreedor_prestacion + mediana_acreedor_prestacion  * aum.aumento,&#xA;mediana_posicion_acreedor_prestacion_ajustada = mediana_posicion_acreedor_prestacion + mediana_posicion_acreedor_prestacion * aum.aumento,&#xA;mediana_prestacion_conectividad_ajustada = mediana_prestacion_conectividad + mediana_prestacion_conectividad * aum.aumento&#xA;FROM H_TRANSACCIONES_PRESTACIONES pre&#xA;INNER JOIN TAumento Aum on (pre.id_periodo = aum.id_periodo) &#xA;WHERE pre.id_periodo &gt;= @Periodo_Siguiente_Consumo_Cerrado and pre.id_periodo &lt;= @Periodo_Hasta_Prestaciones and id_tipo_transaccion_metodo &lt;&gt; 3&#xA; &#xA;--SI imp_unitario_pag TIENE VALOR SE LE PASA ESE VALOR A imp_final_conectividad_ajustado&#xA;--SI imp_unitario_pag NO TIENE VALOR SE LE PASA ESE VALOR DE mediana_acreedor_prestacion_ajustada A imp_final_conectividad_ajustado&#xA;--SI mediana_acreedor_prestacion NO TIENE VALOR SE LE PASA ESE VALOR DE mediana_posicion_acreedor_prestacion_ajustada A imp_final_conectividad_ajustada &#xA;--SI mediana_posicion_acreedor_prestacion NO TIENE VALOR SE LE PASA ESE VALOR DE mediana_prestacion_ajustada A imp_final_conectividad_ajustada &#xA;&#xA;&#xA;update H_TRANSACCIONES_PRESTACIONES&#xA;set  imp_final_conectividad_ajustada = CASE &#xA; WHEN (imp_unitario_pag &lt;&gt; 0) THEN imp_unitario_pag * cant_prest_pag &#xA; WHEN (imp_unitario_pag = 0 and mediana_acreedor_prestacion_ajustada &lt;&gt; 0) &#xA;    THEN mediana_acreedor_prestacion_ajustada * cantidad_prestaciones&#xA; WHEN (mediana_posicion_acreedor_prestacion_ajustada &lt;&gt; 0 and imp_unitario_pag = 0 and mediana_acreedor_prestacion_ajustada = 0 ) &#xA;       THEN mediana_posicion_acreedor_prestacion_ajustada * cantidad_prestaciones&#xA; WHEN (mediana_prestacion_conectividad_ajustada &lt;&gt; 0 and imp_unitario_pag = 0 and  &#xA;   mediana_acreedor_prestacion_ajustada = 0 and mediana_posicion_acreedor_prestacion_ajustada = 0 ) &#xA;    THEN mediana_prestacion_conectividad_ajustada * cantidad_prestaciones&#xA; WHEN (imp_unitario_pag = 0 and mediana_acreedor_prestacion_ajustada = 0 and mediana_posicion_acreedor_prestacion_ajustada = 0 and mediana_prestacion_conectividad_ajustada = 0  ) &#xA;    THEN 0 &#xA; END &#xA;FROM H_TRANSACCIONES_PRESTACIONES &#xA;where id_periodo &gt;= @periodo_desde and id_periodo &lt;=@periodo_hasta and id_tipo_transaccion_metodo &lt;&gt; 3&#xA;&#xA;&#xA;&#xA;DECLARE @Periodo13 INT&#xA;SET @Periodo13 = dbo.PeriodosAnteriores((SELECT MAX(id_periodo) FROM H_TRANSACCIONES_PRESTACIONES),13)&#xA;DECLARE @Periodo6 INT&#xA;SET @Periodo6 = dbo.PeriodosAnteriores((SELECT MAX(id_periodo) FROM H_TRANSACCIONES_PRESTACIONES),8)&#xA;-- Setea en 0 los valores&#xA;update H_TRANSACCIONES_PRESTACIONES &#xA;Set imp_conectividad_considerado = 0,&#xA; cant_conectividad_considerado = 0&#xA; where id_periodo &gt;= @Periodo13 &#xA;&#xA; -- Calcula para los primeros 6 meses&#xA;update H_TRANSACCIONES_PRESTACIONES &#xA;Set imp_conectividad_considerado = imp_prest_pag,&#xA; cant_conectividad_considerado = cant_prest_pag&#xA; where id_periodo between  @Periodo13 and  @Periodo6 and id_tipo_transaccion_metodo &lt;&gt; 3&#xA;&#xA;-- Calcula para los 7 meses posteriores&#xA;update H_TRANSACCIONES_PRESTACIONES &#xA; Set imp_conectividad_considerado = imp_final_conectividad_ajustada,&#xA; cant_conectividad_considerado = cantidad_prestaciones&#xA; where id_periodo  &gt; @Periodo6 and id_tipo_transaccion_metodo &lt;&gt; 3&#xA;" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:DesignTimeProperties><![CDATA[<?xml version="1.0"?>
<!--Esta sección CDATA contiene la información de diseño del paquete. Esta sección incluye información como, por ejemplo, las coordenadas (x,y), el ancho y el alto.-->
<!--Si edita manualmente esta sección y comete un error, puede eliminarlo. -->
<!--El paquete podrá cargarse normalmente, pero se perderá la información de diseño anterior y el diseñador reorganizará los elementos automáticamente en la superficie de diseño.-->
<Objects
  Version="8">
  <!--Cada uno de los nodos siguientes contiene propiedades que no afectan al comportamiento en tiempo de ejecución.-->
  <Package
    design-time-name="Package">
    <LayoutInfo>
      <GraphLayout
        Capacity="4" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph">
        <NodeLayout
          Size="346,44"
          Id="Package\Actualiza Medianas en H_TRANSACCIONES_PRESTACIONES"
          TopLeft="147,115" />
      </GraphLayout>
    </LayoutInfo>
  </Package>
</Objects>]]></DTS:DesignTimeProperties>
</DTS:Executable>